
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://vault.axonshield.com/security/common-vulnerabilities/">
      
      
        <link rel="prev" href="../certificate-pinning/">
      
      
        <link rel="next" href="../compliance-and-audit/">
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Common Vulnerabilities - Shield Vault</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


    
    
    
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WJXPDRF2');</script>
  <!-- End Google Tag Manager -->
  
  <!-- Apollo Tracking -->
  <script>
    (function() {
      var apolloScript = document.createElement('script');
      apolloScript.type = 'text/javascript';
      apolloScript.async = true;
      apolloScript.src = 'https://cdn.apollo.io/v1/apollo.js';
      apolloScript.setAttribute('data-apollo-id', '68b8b91c5e883f0021f7f7aa');
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(apolloScript, s);
    })();
  </script>
  <!-- End Apollo Tracking -->
  
  <!-- Organization Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ProfessionalService",
    "name": "Axon Shield",
    "url": "https://vault.axonshield.com",
    "logo": "https://vault.axonshield.com/logo.png",
    "description": "Enterprise PKI and certificate automation consulting. Cambridge postdoctoral expertise with implementations at Barclays, Deutsche Bank, Sky UK, and Comcast. Specializing in HSM integration, multi-tenant PKI architecture, and certificate management for fintech and healthcare.",
    "priceRange": "$$$",
    "areaServed": {
      "@type": "Country",
      "name": "Worldwide"
    },
    "serviceType": [
      "PKI Architecture Consulting",
      "Certificate Automation Implementation", 
      "HSM Integration",
      "Multi-Tenant PKI Design",
      "Certificate Management Strategy",
      "Post-Quantum Cryptography Planning"
    ],
    "founder": {
      "@type": "Person",
      "name": "Dan Cvrcek",
      "jobTitle": "Founder and Principal Consultant",
      "description": "Cambridge postdoctoral researcher specializing in PKI and cryptography. Black Hat and DEF CON conference speaker with 20+ years implementing certificate infrastructure for Fortune 500 companies.",
      "alumniOf": {
        "@type": "CollegeOrUniversity",
        "name": "University of Cambridge",
        "sameAs": "https://www.cam.ac.uk"
      },
      "honorificPrefix": "Dr.",
      "knowsAbout": [
        {
          "@type": "Thing",
          "name": "Public Key Infrastructure",
          "sameAs": "https://en.wikipedia.org/wiki/Public_key_infrastructure"
        },
        {
          "@type": "Thing", 
          "name": "Hardware Security Module",
          "sameAs": "https://en.wikipedia.org/wiki/Hardware_security_module"
        },
        {
          "@type": "Thing",
          "name": "Certificate Automation"
        },
        {
          "@type": "Thing",
          "name": "PKCS#11"
        },
        {
          "@type": "Thing",
          "name": "Zero Trust Architecture"
        },
        {
          "@type": "Thing",
          "name": "Operational Models"
        }
      ],
      "award": [
        "Black Hat USA Conference Speaker",
        "DEF CON Conference Speaker"
      ],
      "workExample": [
        {
          "@type": "Organization",
          "name": "Barclays",
          "sameAs": "https://en.wikipedia.org/wiki/Barclays"
        },
        {
          "@type": "Organization",
          "name": "Deutsche Bank",
          "sameAs": "https://en.wikipedia.org/wiki/Deutsche_Bank"
        },
        {
          "@type": "Organization",
          "name": "Sky UK",
          "sameAs": "https://en.wikipedia.org/wiki/Sky_UK"
        },
        {
          "@type": "Organization",
          "name": "TSB Bank PLC (part of Banco Sabadell)",
          "sameAs": "https://en.wikipedia.org/wiki/TSB"
        },
        {
          "@type": "Organization",
          "name": "Comcast",
          "sameAs": "https://en.wikipedia.org/wiki/Comcast"
        }
      ],
      "hasCredential": [
        {
          "@type": "EducationalOccupationalCredential",
          "credentialCategory": "Postdoctoral Research",
          "recognizedBy": {
            "@type": "CollegeOrUniversity",
            "name": "University of Cambridge"
          }
        },
        {
          "@type": "EducationalOccupationalCredential",
          "credentialCategory": "Professor (Docent)",
          "recognizedBy": {
            "@type": "CollegeOrUniversity",
            "name": "Brno University of Technology"
          }
        }
      ]
    },
    "hasOfferCatalog": {
      "@type": "OfferCatalog",
      "name": "Consulting Services",
      "itemListElement": [
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "PKI Architecture Assessment",
            "description": "Comprehensive evaluation of PKI readiness, architecture design, and implementation planning"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service", 
            "name": "HSM Integration Implementation",
            "description": "End-to-end HSM deployment including vendor selection, PKCS#11 integration, and operational procedures"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Certificate Automation Strategy",
            "description": "Multi-tenant PKI design, ACME implementation, and certificate lifecycle automation"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Infrastructure Intelligence - Operational Model",
            "description": "Integration with Asset Management, CMDB, Runbooks, Integrated Network Perimeter (WAF, DoS, DNS, PKI)"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "PKI Rescue Consulting",
            "description": "Emergency response for certificate outages, HSM failures, and PKI implementation problems"
          }
        }
      ]
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "5.0",
      "reviewCount": "12",
      "bestRating": "5"
    }
  }
  </script>
  <!-- End Organization Schema -->

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#common-vulnerabilities" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Shield Vault" class="md-header__button md-logo" aria-label="Shield Vault" data-md-component="logo">
      
  <img src="../../assets/axon-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Shield Vault
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Common Vulnerabilities
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Why Certificate Management Matters

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../glossary/" class="md-tabs__link">
        
  
  
    
  
  Glossary

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../quick-start/" class="md-tabs__link">
        
  
  
    
  
  Quick Start Guide

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../technical-guide/" class="md-tabs__link">
        
  
  
    
  
  Foundations for Infrastructure Intelligence - Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../architecture/case-studies/" class="md-tabs__link">
          
  
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../business/cost_of_certificate_management/" class="md-tabs__link">
          
  
  
  Business

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../foundations/certificate-anatomy/" class="md-tabs__link">
          
  
  
  Foundations

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../implementation/acme-protocol-implementation/" class="md-tabs__link">
          
  
  
  Implementation

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../operations/certificate-lifecycle-management/" class="md-tabs__link">
          
  
  
  Operations

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../patterns/ca-hierarchies/" class="md-tabs__link">
          
  
  
  Patterns

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../ca-compromise-scenarios/" class="md-tabs__link">
          
  
  
  Security

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../standards/acme-protocol/" class="md-tabs__link">
          
  
  
  Standards

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../strategy/success-metrics/" class="md-tabs__link">
          
  
  
  Strategy

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../troubleshooting/chain-validation-errors/" class="md-tabs__link">
          
  
  
  Troubleshooting

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../vendors/digicert-certcentral/" class="md-tabs__link">
          
  
  
  Vendors

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Shield Vault" class="md-nav__button md-logo" aria-label="Shield Vault" data-md-component="logo">
      
  <img src="../../assets/axon-logo.png" alt="logo">

    </a>
    Shield Vault
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Why Certificate Management Matters
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Foundations for Infrastructure Intelligence - Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/case-studies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Case Studies - Certificate Management at Scale
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/certificate-as-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate-as-Code
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/mutual-tls-patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mutual TLS Patterns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/service-mesh-certificates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Service Mesh Certificates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/zero-trust-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Zero-Trust Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Business
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Business
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../business/cost_of_certificate_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The $67 Million Risk: Hidden Costs of Manual Certificate Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Foundations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Foundations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/certificate-anatomy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Anatomy
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/cryptographic-primitives/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cryptographic Primitives
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/public-private-key-pairs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Public-Private Key Pairs
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/trust-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trust Models
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/what-is-pki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    What is PKI?
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Implementation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Implementation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/acme-protocol-implementation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ACME Protocol Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/ca-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CA Architecture
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/certificate-issuance-workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Issuance Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/hsm-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HSM Integration
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/hsm-operational-failures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HSM Operational Failures
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/multi-cloud-pki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Cloud PKI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/onprem-vs-cloud-hsm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    On-Premises vs Cloud HSM
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/certificate-lifecycle-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Lifecycle Management
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/certificate-rotation-strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Rotation Strategies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/inventory-and-discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inventory and Discovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/monitoring-and-alerting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Monitoring and Alerting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/renewal-automation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Renewal Automation
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Patterns
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/ca-hierarchies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CA Hierarchies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/cloud-vs-on-premises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cloud vs On-Premises
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/high-availability-disaster-recovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    High Availability and Disaster Recovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/multi-tenancy-considerations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Tenancy Considerations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" checked>
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Security
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ca-compromise-scenarios/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CA Compromise Scenarios
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../certificate-pinning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Pinning
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Common Vulnerabilities
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Common Vulnerabilities
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-issuance-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Issuance Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Certificate Issuance Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#weak-domain-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Weak Domain Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caa-record-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      CAA Record Bypass
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#weak-key-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Weak Key Generation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-validation-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Validation Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Certificate Validation Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#incomplete-chain-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Incomplete Chain Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#name-constraint-violations" class="md-nav__link">
    <span class="md-ellipsis">
      Name Constraint Violations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#revocation-check-failures" class="md-nav__link">
    <span class="md-ellipsis">
      Revocation Check Failures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocol-level-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Protocol-Level Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Protocol-Level Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ssltls-protocol-attacks" class="md-nav__link">
    <span class="md-ellipsis">
      SSL/TLS Protocol Attacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downgrade-attacks" class="md-nav__link">
    <span class="md-ellipsis">
      Downgrade Attacks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#improper-certificate-storage" class="md-nav__link">
    <span class="md-ellipsis">
      Improper Certificate Storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insufficient-random-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Insufficient Random Generation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supply-chain-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Supply Chain Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Supply Chain Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compromised-certificate-authorities" class="md-nav__link">
    <span class="md-ellipsis">
      Compromised Certificate Authorities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malicious-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Malicious Dependencies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operational-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Operational Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operational Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#certificate-expiration" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Expiration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insufficient-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Insufficient Monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defense-in-depth-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Defense in Depth Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Defense in Depth Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#layered-security-controls" class="md-nav__link">
    <span class="md-ellipsis">
      Layered Security Controls
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      Further Reading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Further Reading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#standards-and-rfcs" class="md-nav__link">
    <span class="md-ellipsis">
      Standards and RFCs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Security Resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#research-papers" class="md-nav__link">
    <span class="md-ellipsis">
      Research Papers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../compliance-and-audit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compliance and Audit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../incident-response/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Incident Response
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../key-management-best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Key Management Best Practices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../private-key-protection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Private Key Protection
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../threat-models-and-attack-vectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Threat Models and Attack Vectors
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Standards
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            Standards
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/acme-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ACME Protocol
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/ocsp-and-crl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OCSP and CRL
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/pkcs-standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PKCS Standards
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/tls-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TLS Protocol
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/x509-standard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    X.509 Standard
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Strategy
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Strategy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategy/success-metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Success Metrics and KPIs for Certificate Automation
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            Troubleshooting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/chain-validation-errors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chain Validation Errors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/common-misconfigurations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common Misconfigurations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/expired-certificate-outages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Expired Certificate Outages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/performance-bottlenecks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Performance Bottlenecks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Vendors
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            Vendors
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/digicert-certcentral/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DigiCert CertCentral
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/hashicorp-vault-pki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HashiCorp Vault PKI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/keyfactor-command/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Keyfactor Command
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/venafi-platform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Venafi Platform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/vendor-comparison-matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vendor Comparison Matrix
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-issuance-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Issuance Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Certificate Issuance Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#weak-domain-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Weak Domain Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caa-record-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      CAA Record Bypass
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#weak-key-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Weak Key Generation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-validation-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Validation Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Certificate Validation Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#incomplete-chain-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Incomplete Chain Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#name-constraint-violations" class="md-nav__link">
    <span class="md-ellipsis">
      Name Constraint Violations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#revocation-check-failures" class="md-nav__link">
    <span class="md-ellipsis">
      Revocation Check Failures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocol-level-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Protocol-Level Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Protocol-Level Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ssltls-protocol-attacks" class="md-nav__link">
    <span class="md-ellipsis">
      SSL/TLS Protocol Attacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downgrade-attacks" class="md-nav__link">
    <span class="md-ellipsis">
      Downgrade Attacks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#improper-certificate-storage" class="md-nav__link">
    <span class="md-ellipsis">
      Improper Certificate Storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insufficient-random-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Insufficient Random Generation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supply-chain-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Supply Chain Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Supply Chain Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compromised-certificate-authorities" class="md-nav__link">
    <span class="md-ellipsis">
      Compromised Certificate Authorities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malicious-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Malicious Dependencies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operational-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Operational Vulnerabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operational Vulnerabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#certificate-expiration" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Expiration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insufficient-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Insufficient Monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defense-in-depth-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Defense in Depth Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Defense in Depth Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#layered-security-controls" class="md-nav__link">
    <span class="md-ellipsis">
      Layered Security Controls
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      Further Reading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Further Reading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#standards-and-rfcs" class="md-nav__link">
    <span class="md-ellipsis">
      Standards and RFCs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Security Resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#research-papers" class="md-nav__link">
    <span class="md-ellipsis">
      Research Papers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WJXPDRF2"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <!-- Right sidebar with disclaimer above TOC -->
  
    <style>
      @media screen and (min-width: 76.25em) {
        .md-sidebar--secondary {
          order: 1;
        }
        .md-sidebar--secondary::before {
          content: '';
          display: block;
          margin-bottom: 1rem;
        }
      }
    </style>
  
  
  
                  



<h1 id="common-vulnerabilities">Common Vulnerabilities</h1>
<p><strong>Category</strong>: Security<br />
<strong>Complexity</strong>: Advanced<br />
<strong>Prerequisites</strong>: <a href="../../foundations/certificate-anatomy/">Certificate Anatomy</a>, <a href="../../foundations/trust-models/">Chain Of Trust</a>, <a href="../../standards/tls-protocol/">Tls Protocol</a>, <a href="../private-key-protection/">Private Key Protection</a><br />
<strong>Related</strong>: <a href="../certificate-pinning/">Certificate Pinning</a>, <a href="../../foundations/trust-models/">Trust Models</a>, <a href="../../foundations/cryptographic-primitives/">Cryptographic Primitives</a></p>
<hr />
<h2 id="overview">Overview</h2>
<p>PKI systems face numerous vulnerabilities across the certificate lifecycle, from issuance through validation to revocation. Understanding these vulnerabilities is critical for securing certificate infrastructure and preventing attacks that can compromise confidentiality, integrity, and authenticity.</p>
<p>This page catalogs common PKI vulnerabilities, real-world incidents, and practical mitigations.</p>
<h2 id="certificate-issuance-vulnerabilities">Certificate Issuance Vulnerabilities</h2>
<h3 id="weak-domain-validation">Weak Domain Validation</h3>
<p><strong>Vulnerability</strong>: Attackers can obtain valid certificates for domains they don't control by exploiting weak validation processes.</p>
<p><strong>Attack Vectors</strong>:</p>
<p><strong>1. Email-based validation bypass</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Traditional approach: CA sends validation email to admin@domain.com
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>Attack: Attacker gains control of admin email account
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>Result: Attacker can request valid certificate for domain.com
</code></pre></div></p>
<p><strong>2. DNS validation bypass</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Vulnerability: Temporary DNS control</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DNSValidationAttack</span><span class="p">:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="sd">    Attacker temporarily gains DNS control to pass validation</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">attack_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>        <span class="c1"># Step 1: Attacker initiates certificate request</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>        <span class="n">ca_challenge</span> <span class="o">=</span> <span class="n">request_certificate</span><span class="p">(</span><span class="s2">&quot;victim.com&quot;</span><span class="p">)</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>        <span class="c1"># CA responds: &quot;Create TXT record _acme-challenge.victim.com with value XYZ&quot;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>        <span class="c1"># Step 2: Attacker exploits DNS weakness</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        <span class="c1"># Examples:</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>        <span class="c1"># - Subdomain takeover (pointing to attacker&#39;s server)</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>        <span class="c1"># - BGP hijacking to route DNS queries</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="c1"># - Registrar account compromise</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>        <span class="c1"># - DNS cache poisoning</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>        <span class="c1"># Step 3: Attacker creates validation record</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>        <span class="n">create_dns_record</span><span class="p">(</span><span class="s2">&quot;_acme-challenge.victim.com&quot;</span><span class="p">,</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">)</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>        <span class="c1"># Step 4: CA validates and issues certificate</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>        <span class="n">certificate</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">validate_and_issue</span><span class="p">()</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>        <span class="c1"># Step 5: Attacker removes DNS record (covers tracks)</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>        <span class="n">delete_dns_record</span><span class="p">(</span><span class="s2">&quot;_acme-challenge.victim.com&quot;</span><span class="p">)</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>        <span class="c1"># Result: Valid certificate for victim.com in attacker&#39;s hands</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>        <span class="k">return</span> <span class="n">certificate</span>
</code></pre></div></p>
<p><strong>3. HTTP validation bypass</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Traditional: CA requests file at http://domain.com/.well-known/acme-challenge/token
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>Attacks:
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>- HTTP request interception
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>- Load balancer misconfiguration
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>- Shared hosting exploitation
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>- CDN configuration errors
</code></pre></div></p>
<p><strong>Real-World Incident</strong>: Let's Encrypt Boulder Bug (2016)
- Vulnerability in validation logic
- Allowed certificates for domains with only partial control
- 2,600+ certificates revoked</p>
<p><strong>Mitigations</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureDomainValidation</span><span class="p">:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="sd">    Implement multiple validation checks</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">validation_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="sd">        Multi-layered domain validation</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>        <span class="n">validations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        <span class="c1"># 1. Check domain ownership history</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_consistent_ownership</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Domain ownership recently changed&quot;</span><span class="p">)</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>        <span class="c1"># 2. Multiple validation methods</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="k">if</span> <span class="n">validation_method</span> <span class="o">==</span> <span class="s1">&#39;dns&#39;</span><span class="p">:</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>            <span class="n">validations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dns_validation</span><span class="p">(</span><span class="n">domain</span><span class="p">))</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>            <span class="c1"># Also require HTTP validation</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>            <span class="n">validations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_validation</span><span class="p">(</span><span class="n">domain</span><span class="p">))</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>        <span class="c1"># 3. Check for suspicious patterns</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_suspicious_patterns</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>            <span class="c1"># Require manual review</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">flag_for_manual_review</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>        <span class="c1"># 4. CAA record check (required by RFC 8659)</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>        <span class="n">caa_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_caa_records</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>        <span class="k">if</span> <span class="n">caa_records</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca_is_authorized</span><span class="p">(</span><span class="n">caa_records</span><span class="p">):</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;CA not authorized by CAA records&quot;</span><span class="p">)</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>        <span class="c1"># 5. Certificate Transparency pre-check</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_has_suspicious_ct_history</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">flag_for_review</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">validations</span><span class="p">)</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_consistent_ownership</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a><span class="sd">        Verify domain ownership hasn&#39;t changed recently</span>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>        <span class="n">whois_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_whois_history</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>        <span class="c1"># Check for recent ownership transfers</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;registrant&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">whois_history</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>        <span class="c1"># Check for recent DNS changes</span>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>        <span class="n">dns_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dns_history</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_unusual_dns_changes</span><span class="p">(</span><span class="n">dns_history</span><span class="p">):</span>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></p>
<h3 id="caa-record-bypass">CAA Record Bypass</h3>
<p><strong>Vulnerability</strong>: Certificate Authority Authorization (CAA) records specify which CAs can issue certificates, but not all CAs check them properly.</p>
<p><strong>Attack</strong>: Attacker requests certificate from CA that doesn't check CAA records.</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>; Intended CAA policy
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>victim.com. CAA 0 issue &quot;trusted-ca.com&quot;
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>; Attacker requests from different CA
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>; Vulnerable CA doesn&#39;t check CAA records
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>; Issues certificate despite CAA policy
</code></pre></div></p>
<p><strong>Detection</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dns.resolver</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_caa_compliance</span><span class="p">(</span><span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">issuing_ca</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="sd">    Verify CA is authorized by CAA records</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="c1"># Query CAA records</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        <span class="n">answers</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="s1">&#39;CAA&#39;</span><span class="p">)</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="n">authorized_cas</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="n">wildcards_allowed</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        <span class="k">for</span> <span class="n">rdata</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">:</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>            <span class="k">if</span> <span class="n">rdata</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;issue&#39;</span><span class="p">:</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>                <span class="n">authorized_cas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rdata</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>            <span class="k">elif</span> <span class="n">rdata</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;issuewild&#39;</span><span class="p">:</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>                <span class="n">wildcards_allowed</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>                <span class="n">authorized_cas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rdata</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="c1"># Check if issuing CA is authorized</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">authorized_cas</span><span class="p">:</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>            <span class="c1"># No CAA records = any CA can issue</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        <span class="c1"># Verify CA is in authorized list</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        <span class="k">for</span> <span class="n">authorized_ca</span> <span class="ow">in</span> <span class="n">authorized_cas</span><span class="p">:</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>            <span class="k">if</span> <span class="n">issuing_ca</span> <span class="ow">in</span> <span class="n">authorized_ca</span><span class="p">:</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="c1"># CA not authorized</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>        <span class="k">raise</span> <span class="n">CAAViolation</span><span class="p">(</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>            <span class="sa">f</span><span class="s2">&quot;CA </span><span class="si">{</span><span class="n">issuing_ca</span><span class="si">}</span><span class="s2"> not authorized by CAA records. &quot;</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>            <span class="sa">f</span><span class="s2">&quot;Authorized: </span><span class="si">{</span><span class="n">authorized_cas</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="p">)</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>    <span class="k">except</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NXDOMAIN</span><span class="p">:</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>        <span class="c1"># No CAA records = any CA can issue (per RFC)</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>    <span class="k">except</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NoAnswer</span><span class="p">:</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>        <span class="c1"># No CAA records at this level, check parent domain</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>        <span class="n">parent</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>            <span class="k">return</span> <span class="n">check_caa_compliance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">issuing_ca</span><span class="p">)</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></p>
<p><strong>Mitigation</strong>:</p>
<ul>
<li>RFC 8659 requires CAs to check CAA records (since 2019)</li>
<li>Set CAA records for your domains</li>
<li>Monitor Certificate Transparency logs for unauthorized issuance</li>
</ul>
<h3 id="weak-key-generation">Weak Key Generation</h3>
<p><strong>Vulnerability</strong>: Certificates issued with weak or compromised keys.</p>
<p><strong>Attack Scenarios</strong>:</p>
<p><strong>1. Predictable random number generation</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># VULNERABLE: Debian OpenSSL Bug (2008)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="c1"># Random number generator used only process ID as entropy</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1"># Result: Only 32,767 possible RSA keys</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>  <span class="c1"># BAD: Predictable seed</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="n">private_key</span> <span class="o">=</span> <span class="n">generate_rsa_key</span><span class="p">(</span><span class="n">random</span><span class="p">)</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="c1"># Attacker can generate all possible keys and find match</span>
</code></pre></div></p>
<p><strong>2. Shared keys across systems</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># VULNERABLE: Using same key for multiple purposes</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">WeakKeyPractice</span><span class="p">:</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="sd">    Anti-pattern: Key reuse</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>        <span class="c1"># Same key used for multiple certificates</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_key</span><span class="p">(</span><span class="s2">&quot;shared.key&quot;</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">issue_cert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>        <span class="c1"># Creates certificate for different domain with same key</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>        <span class="k">return</span> <span class="n">create_certificate</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_key</span><span class="p">)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="c1"># Risk: Compromise of one domain compromises all</span>
</code></pre></div></p>
<p><strong>Real-World Impact</strong>: Debian OpenSSL Bug
- Affected: Debian/Ubuntu systems (2006-2008)
- Impact: Weak SSH and SSL keys generated
- Scope: Millions of certificates and SSH keys compromised
- Resolution: Mass revocation and regeneration</p>
<p><strong>Mitigations</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">rsa</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.backends</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_backend</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureKeyGeneration</span><span class="p">:</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="sd">    Generate cryptographically secure keys</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_rsa_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPrivateKey</span><span class="p">:</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="sd">        Generate RSA key with secure random number generator</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>        <span class="c1"># Validate key size</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>        <span class="k">if</span> <span class="n">key_size</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">:</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Minimum key size is 2048 bits&quot;</span><span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>        <span class="c1"># Use system&#39;s CSPRNG</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>        <span class="n">private_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>            <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>            <span class="n">key_size</span><span class="o">=</span><span class="n">key_size</span><span class="p">,</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>            <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">()</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>        <span class="p">)</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>        <span class="k">return</span> <span class="n">private_key</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_key_uniqueness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPrivateKey</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="sd">        Verify key hasn&#39;t been generated before</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>        <span class="c1"># Hash the public key</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>        <span class="n">public_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>        <span class="n">key_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_public_key</span><span class="p">(</span><span class="n">public_key</span><span class="p">)</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>        <span class="c1"># Check against database of issued keys</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_hash_exists</span><span class="p">(</span><span class="n">key_hash</span><span class="p">):</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>                <span class="s2">&quot;Key collision detected - regenerate key&quot;</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>            <span class="p">)</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>        <span class="c1"># Store hash for future checks</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">store_key_hash</span><span class="p">(</span><span class="n">key_hash</span><span class="p">)</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_key_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPrivateKey</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a><span class="sd">        Verify key has sufficient entropy</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>        <span class="c1"># Extract key components</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>        <span class="n">private_numbers</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">private_numbers</span><span class="p">()</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a>        <span class="c1"># Test for weak primes</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_strong_prime</span><span class="p">(</span><span class="n">private_numbers</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">&quot;Weak prime detected in key&quot;</span><span class="p">)</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_strong_prime</span><span class="p">(</span><span class="n">private_numbers</span><span class="o">.</span><span class="n">q</span><span class="p">):</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">&quot;Weak prime detected in key&quot;</span><span class="p">)</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>        <span class="c1"># Verify key strength</span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">private_numbers</span><span class="o">.</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">key</span><span class="o">.</span><span class="n">key_size</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">10</span><span class="p">:</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">&quot;Insufficient key entropy&quot;</span><span class="p">)</span>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></p>
<h2 id="certificate-validation-vulnerabilities">Certificate Validation Vulnerabilities</h2>
<h3 id="incomplete-chain-validation">Incomplete Chain Validation</h3>
<p><strong>Vulnerability</strong>: Applications fail to validate entire certificate chain properly.</p>
<p><strong>Common Mistakes</strong>:</p>
<p><strong>1. Only validating leaf certificate</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># VULNERABLE: Doesn&#39;t check intermediate certificates</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">vulnerable_validation</span><span class="p">(</span><span class="n">cert</span><span class="p">:</span> <span class="n">Certificate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="c1"># Only checks if leaf certificate is signed</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="k">if</span> <span class="n">verify_signature</span><span class="p">(</span><span class="n">cert</span><span class="p">):</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="c1"># Attack: Attacker uses self-signed intermediate</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="c1"># Leaf cert signature validates, but chain is broken</span>
</code></pre></div></p>
<p><strong>2. Missing expiration checks</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># VULNERABLE: Doesn&#39;t verify validity dates</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">weak_validation</span><span class="p">(</span><span class="n">cert</span><span class="p">:</span> <span class="n">Certificate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="c1"># Checks signature but ignores notBefore/notAfter</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="k">return</span> <span class="n">verify_certificate_signature</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="c1"># Attack: Use expired certificate that was once valid</span>
</code></pre></div></p>
<p><strong>3. Improper hostname verification</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># VULNERABLE: Doesn&#39;t check hostname matches</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">insecure_validation</span><span class="p">(</span><span class="n">cert</span><span class="p">:</span> <span class="n">Certificate</span><span class="p">,</span> <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="c1"># Validates certificate but not hostname</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="k">return</span> <span class="n">validate_certificate_chain</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c1"># Attack: Use valid certificate for different domain</span>
</code></pre></div></p>
<p><strong>Secure Implementation</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography</span><span class="w"> </span><span class="kn">import</span> <span class="n">x509</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.backends</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_backend</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureCertificateValidator</span><span class="p">:</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="sd">    Comprehensive certificate validation</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trust_store</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Certificate</span><span class="p">]):</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trust_store</span> <span class="o">=</span> <span class="n">trust_store</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_certificate_chain</span><span class="p">(</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        <span class="n">cert_chain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span> 
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="sd">        Validate complete certificate chain</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        <span class="c1"># Parse certificates</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>        <span class="n">certificates</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>            <span class="n">x509</span><span class="o">.</span><span class="n">load_der_x509_certificate</span><span class="p">(</span><span class="n">cert_der</span><span class="p">,</span> <span class="n">default_backend</span><span class="p">())</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>            <span class="k">for</span> <span class="n">cert_der</span> <span class="ow">in</span> <span class="n">cert_chain</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>        <span class="p">]</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>        <span class="c1"># 1. Validate each certificate&#39;s validity period</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>        <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="n">certificates</span><span class="p">:</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">validate_temporal_validity</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>        <span class="c1"># 2. Validate chain signatures</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validate_signature_chain</span><span class="p">(</span><span class="n">certificates</span><span class="p">)</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>        <span class="c1"># 3. Validate chain to trusted root</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validate_trust_anchor</span><span class="p">(</span><span class="n">certificates</span><span class="p">)</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>        <span class="c1"># 4. Validate hostname</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validate_hostname</span><span class="p">(</span><span class="n">certificates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hostname</span><span class="p">)</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>        <span class="c1"># 5. Check revocation status</span>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">check_revocation</span><span class="p">(</span><span class="n">certificates</span><span class="p">)</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>        <span class="c1"># 6. Validate key usage and constraints</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validate_key_usage</span><span class="p">(</span><span class="n">certificates</span><span class="p">)</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_temporal_validity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">):</span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a><span class="sd">        Check certificate is within validity period</span>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>        <span class="k">if</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">cert</span><span class="o">.</span><span class="n">not_valid_before_utc</span><span class="p">:</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>                <span class="sa">f</span><span class="s2">&quot;Certificate not yet valid. &quot;</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>                <span class="sa">f</span><span class="s2">&quot;Valid from: </span><span class="si">{</span><span class="n">cert</span><span class="o">.</span><span class="n">not_valid_before_utc</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>            <span class="p">)</span>
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>        <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">cert</span><span class="o">.</span><span class="n">not_valid_after_utc</span><span class="p">:</span>
<a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a>                <span class="sa">f</span><span class="s2">&quot;Certificate expired. &quot;</span>
<a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a>                <span class="sa">f</span><span class="s2">&quot;Expired: </span><span class="si">{</span><span class="n">cert</span><span class="o">.</span><span class="n">not_valid_after_utc</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>            <span class="p">)</span>
<a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a>
<a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_signature_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">]):</span>
<a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a><span class="sd">        Verify each certificate is signed by next in chain</span>
<a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">certificates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a>            <span class="n">cert</span> <span class="o">=</span> <span class="n">certificates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a>            <span class="n">issuer_cert</span> <span class="o">=</span> <span class="n">certificates</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a>
<a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a>            <span class="c1"># Verify issuer</span>
<a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a>            <span class="k">if</span> <span class="n">cert</span><span class="o">.</span><span class="n">issuer</span> <span class="o">!=</span> <span class="n">issuer_cert</span><span class="o">.</span><span class="n">subject</span><span class="p">:</span>
<a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a>                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a>                    <span class="sa">f</span><span class="s2">&quot;Chain break: Certificate </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> issuer doesn&#39;t match &quot;</span>
<a id="__codelineno-12-79" name="__codelineno-12-79" href="#__codelineno-12-79"></a>                    <span class="sa">f</span><span class="s2">&quot;certificate </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> subject&quot;</span>
<a id="__codelineno-12-80" name="__codelineno-12-80" href="#__codelineno-12-80"></a>                <span class="p">)</span>
<a id="__codelineno-12-81" name="__codelineno-12-81" href="#__codelineno-12-81"></a>
<a id="__codelineno-12-82" name="__codelineno-12-82" href="#__codelineno-12-82"></a>            <span class="c1"># Verify signature</span>
<a id="__codelineno-12-83" name="__codelineno-12-83" href="#__codelineno-12-83"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-84" name="__codelineno-12-84" href="#__codelineno-12-84"></a>                <span class="n">issuer_public_key</span> <span class="o">=</span> <span class="n">issuer_cert</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
<a id="__codelineno-12-85" name="__codelineno-12-85" href="#__codelineno-12-85"></a>                <span class="n">issuer_public_key</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span>
<a id="__codelineno-12-86" name="__codelineno-12-86" href="#__codelineno-12-86"></a>                    <span class="n">cert</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
<a id="__codelineno-12-87" name="__codelineno-12-87" href="#__codelineno-12-87"></a>                    <span class="n">cert</span><span class="o">.</span><span class="n">tbs_certificate_bytes</span><span class="p">,</span>
<a id="__codelineno-12-88" name="__codelineno-12-88" href="#__codelineno-12-88"></a>                    <span class="n">cert</span><span class="o">.</span><span class="n">signature_algorithm_parameters</span>
<a id="__codelineno-12-89" name="__codelineno-12-89" href="#__codelineno-12-89"></a>                <span class="p">)</span>
<a id="__codelineno-12-90" name="__codelineno-12-90" href="#__codelineno-12-90"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-12-91" name="__codelineno-12-91" href="#__codelineno-12-91"></a>                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-92" name="__codelineno-12-92" href="#__codelineno-12-92"></a>                    <span class="sa">f</span><span class="s2">&quot;Signature verification failed for certificate </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-12-93" name="__codelineno-12-93" href="#__codelineno-12-93"></a>                <span class="p">)</span>
<a id="__codelineno-12-94" name="__codelineno-12-94" href="#__codelineno-12-94"></a>
<a id="__codelineno-12-95" name="__codelineno-12-95" href="#__codelineno-12-95"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_trust_anchor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">]):</span>
<a id="__codelineno-12-96" name="__codelineno-12-96" href="#__codelineno-12-96"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-12-97" name="__codelineno-12-97" href="#__codelineno-12-97"></a><span class="sd">        Verify chain terminates at trusted root</span>
<a id="__codelineno-12-98" name="__codelineno-12-98" href="#__codelineno-12-98"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-12-99" name="__codelineno-12-99" href="#__codelineno-12-99"></a>        <span class="n">root_cert</span> <span class="o">=</span> <span class="n">certificates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-12-100" name="__codelineno-12-100" href="#__codelineno-12-100"></a>
<a id="__codelineno-12-101" name="__codelineno-12-101" href="#__codelineno-12-101"></a>        <span class="c1"># Check if root is in trust store</span>
<a id="__codelineno-12-102" name="__codelineno-12-102" href="#__codelineno-12-102"></a>        <span class="k">for</span> <span class="n">trusted_root</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trust_store</span><span class="p">:</span>
<a id="__codelineno-12-103" name="__codelineno-12-103" href="#__codelineno-12-103"></a>            <span class="k">if</span> <span class="n">root_cert</span><span class="o">.</span><span class="n">fingerprint</span> <span class="o">==</span> <span class="n">trusted_root</span><span class="o">.</span><span class="n">fingerprint</span><span class="p">:</span>
<a id="__codelineno-12-104" name="__codelineno-12-104" href="#__codelineno-12-104"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-12-105" name="__codelineno-12-105" href="#__codelineno-12-105"></a>
<a id="__codelineno-12-106" name="__codelineno-12-106" href="#__codelineno-12-106"></a>        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-107" name="__codelineno-12-107" href="#__codelineno-12-107"></a>            <span class="s2">&quot;Certificate chain doesn&#39;t terminate at trusted root&quot;</span>
<a id="__codelineno-12-108" name="__codelineno-12-108" href="#__codelineno-12-108"></a>        <span class="p">)</span>
<a id="__codelineno-12-109" name="__codelineno-12-109" href="#__codelineno-12-109"></a>
<a id="__codelineno-12-110" name="__codelineno-12-110" href="#__codelineno-12-110"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">,</span> <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-12-111" name="__codelineno-12-111" href="#__codelineno-12-111"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-12-112" name="__codelineno-12-112" href="#__codelineno-12-112"></a><span class="sd">        Verify certificate is valid for hostname</span>
<a id="__codelineno-12-113" name="__codelineno-12-113" href="#__codelineno-12-113"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-12-114" name="__codelineno-12-114" href="#__codelineno-12-114"></a>        <span class="c1"># Get Subject Alternative Names</span>
<a id="__codelineno-12-115" name="__codelineno-12-115" href="#__codelineno-12-115"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-116" name="__codelineno-12-116" href="#__codelineno-12-116"></a>            <span class="n">san_ext</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span>
<a id="__codelineno-12-117" name="__codelineno-12-117" href="#__codelineno-12-117"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">SubjectAlternativeName</span>
<a id="__codelineno-12-118" name="__codelineno-12-118" href="#__codelineno-12-118"></a>            <span class="p">)</span>
<a id="__codelineno-12-119" name="__codelineno-12-119" href="#__codelineno-12-119"></a>            <span class="n">san_names</span> <span class="o">=</span> <span class="n">san_ext</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get_values_for_type</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">DNSName</span><span class="p">)</span>
<a id="__codelineno-12-120" name="__codelineno-12-120" href="#__codelineno-12-120"></a>        <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
<a id="__codelineno-12-121" name="__codelineno-12-121" href="#__codelineno-12-121"></a>            <span class="n">san_names</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-12-122" name="__codelineno-12-122" href="#__codelineno-12-122"></a>
<a id="__codelineno-12-123" name="__codelineno-12-123" href="#__codelineno-12-123"></a>        <span class="c1"># Get Common Name from subject</span>
<a id="__codelineno-12-124" name="__codelineno-12-124" href="#__codelineno-12-124"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-125" name="__codelineno-12-125" href="#__codelineno-12-125"></a>            <span class="n">cn</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get_attributes_for_oid</span><span class="p">(</span>
<a id="__codelineno-12-126" name="__codelineno-12-126" href="#__codelineno-12-126"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">oid</span><span class="o">.</span><span class="n">NameOID</span><span class="o">.</span><span class="n">COMMON_NAME</span>
<a id="__codelineno-12-127" name="__codelineno-12-127" href="#__codelineno-12-127"></a>            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-12-128" name="__codelineno-12-128" href="#__codelineno-12-128"></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
<a id="__codelineno-12-129" name="__codelineno-12-129" href="#__codelineno-12-129"></a>            <span class="n">cn</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-12-130" name="__codelineno-12-130" href="#__codelineno-12-130"></a>
<a id="__codelineno-12-131" name="__codelineno-12-131" href="#__codelineno-12-131"></a>        <span class="c1"># Check hostname matches</span>
<a id="__codelineno-12-132" name="__codelineno-12-132" href="#__codelineno-12-132"></a>        <span class="n">valid_names</span> <span class="o">=</span> <span class="n">san_names</span> <span class="o">+</span> <span class="p">([</span><span class="n">cn</span><span class="p">]</span> <span class="k">if</span> <span class="n">cn</span> <span class="k">else</span> <span class="p">[])</span>
<a id="__codelineno-12-133" name="__codelineno-12-133" href="#__codelineno-12-133"></a>
<a id="__codelineno-12-134" name="__codelineno-12-134" href="#__codelineno-12-134"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname_matches</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">valid_names</span><span class="p">):</span>
<a id="__codelineno-12-135" name="__codelineno-12-135" href="#__codelineno-12-135"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-136" name="__codelineno-12-136" href="#__codelineno-12-136"></a>                <span class="sa">f</span><span class="s2">&quot;Hostname </span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2"> doesn&#39;t match certificate names: &quot;</span>
<a id="__codelineno-12-137" name="__codelineno-12-137" href="#__codelineno-12-137"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">valid_names</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-12-138" name="__codelineno-12-138" href="#__codelineno-12-138"></a>            <span class="p">)</span>
<a id="__codelineno-12-139" name="__codelineno-12-139" href="#__codelineno-12-139"></a>
<a id="__codelineno-12-140" name="__codelineno-12-140" href="#__codelineno-12-140"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">hostname_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cert_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-12-141" name="__codelineno-12-141" href="#__codelineno-12-141"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-12-142" name="__codelineno-12-142" href="#__codelineno-12-142"></a><span class="sd">        Check if hostname matches certificate name (including wildcards)</span>
<a id="__codelineno-12-143" name="__codelineno-12-143" href="#__codelineno-12-143"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-12-144" name="__codelineno-12-144" href="#__codelineno-12-144"></a>        <span class="c1"># Exact match</span>
<a id="__codelineno-12-145" name="__codelineno-12-145" href="#__codelineno-12-145"></a>        <span class="k">if</span> <span class="n">hostname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">cert_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
<a id="__codelineno-12-146" name="__codelineno-12-146" href="#__codelineno-12-146"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-12-147" name="__codelineno-12-147" href="#__codelineno-12-147"></a>
<a id="__codelineno-12-148" name="__codelineno-12-148" href="#__codelineno-12-148"></a>        <span class="c1"># Wildcard match</span>
<a id="__codelineno-12-149" name="__codelineno-12-149" href="#__codelineno-12-149"></a>        <span class="k">if</span> <span class="n">cert_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;*.&#39;</span><span class="p">):</span>
<a id="__codelineno-12-150" name="__codelineno-12-150" href="#__codelineno-12-150"></a>            <span class="c1"># Wildcard only matches single level</span>
<a id="__codelineno-12-151" name="__codelineno-12-151" href="#__codelineno-12-151"></a>            <span class="n">pattern</span> <span class="o">=</span> <span class="n">cert_name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># Remove *.</span>
<a id="__codelineno-12-152" name="__codelineno-12-152" href="#__codelineno-12-152"></a>            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span>
<a id="__codelineno-12-153" name="__codelineno-12-153" href="#__codelineno-12-153"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">hostname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-12-154" name="__codelineno-12-154" href="#__codelineno-12-154"></a>                <span class="k">return</span> <span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">pattern</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-12-155" name="__codelineno-12-155" href="#__codelineno-12-155"></a>
<a id="__codelineno-12-156" name="__codelineno-12-156" href="#__codelineno-12-156"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-12-157" name="__codelineno-12-157" href="#__codelineno-12-157"></a>
<a id="__codelineno-12-158" name="__codelineno-12-158" href="#__codelineno-12-158"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_key_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">]):</span>
<a id="__codelineno-12-159" name="__codelineno-12-159" href="#__codelineno-12-159"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-12-160" name="__codelineno-12-160" href="#__codelineno-12-160"></a><span class="sd">        Verify certificates have appropriate key usage extensions</span>
<a id="__codelineno-12-161" name="__codelineno-12-161" href="#__codelineno-12-161"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-12-162" name="__codelineno-12-162" href="#__codelineno-12-162"></a>        <span class="n">leaf_cert</span> <span class="o">=</span> <span class="n">certificates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-12-163" name="__codelineno-12-163" href="#__codelineno-12-163"></a>
<a id="__codelineno-12-164" name="__codelineno-12-164" href="#__codelineno-12-164"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-165" name="__codelineno-12-165" href="#__codelineno-12-165"></a>            <span class="c1"># Check leaf certificate key usage</span>
<a id="__codelineno-12-166" name="__codelineno-12-166" href="#__codelineno-12-166"></a>            <span class="n">key_usage</span> <span class="o">=</span> <span class="n">leaf_cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span>
<a id="__codelineno-12-167" name="__codelineno-12-167" href="#__codelineno-12-167"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">KeyUsage</span>
<a id="__codelineno-12-168" name="__codelineno-12-168" href="#__codelineno-12-168"></a>            <span class="p">)</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-12-169" name="__codelineno-12-169" href="#__codelineno-12-169"></a>
<a id="__codelineno-12-170" name="__codelineno-12-170" href="#__codelineno-12-170"></a>            <span class="c1"># For TLS server certificates</span>
<a id="__codelineno-12-171" name="__codelineno-12-171" href="#__codelineno-12-171"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">key_usage</span><span class="o">.</span><span class="n">digital_signature</span><span class="p">:</span>
<a id="__codelineno-12-172" name="__codelineno-12-172" href="#__codelineno-12-172"></a>                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-173" name="__codelineno-12-173" href="#__codelineno-12-173"></a>                    <span class="s2">&quot;Leaf certificate missing digital_signature key usage&quot;</span>
<a id="__codelineno-12-174" name="__codelineno-12-174" href="#__codelineno-12-174"></a>                <span class="p">)</span>
<a id="__codelineno-12-175" name="__codelineno-12-175" href="#__codelineno-12-175"></a>
<a id="__codelineno-12-176" name="__codelineno-12-176" href="#__codelineno-12-176"></a>            <span class="c1"># Check Extended Key Usage</span>
<a id="__codelineno-12-177" name="__codelineno-12-177" href="#__codelineno-12-177"></a>            <span class="n">eku</span> <span class="o">=</span> <span class="n">leaf_cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span>
<a id="__codelineno-12-178" name="__codelineno-12-178" href="#__codelineno-12-178"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">ExtendedKeyUsage</span>
<a id="__codelineno-12-179" name="__codelineno-12-179" href="#__codelineno-12-179"></a>            <span class="p">)</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-12-180" name="__codelineno-12-180" href="#__codelineno-12-180"></a>
<a id="__codelineno-12-181" name="__codelineno-12-181" href="#__codelineno-12-181"></a>            <span class="k">if</span> <span class="n">x509</span><span class="o">.</span><span class="n">oid</span><span class="o">.</span><span class="n">ExtendedKeyUsageOID</span><span class="o">.</span><span class="n">SERVER_AUTH</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eku</span><span class="p">:</span>
<a id="__codelineno-12-182" name="__codelineno-12-182" href="#__codelineno-12-182"></a>                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-183" name="__codelineno-12-183" href="#__codelineno-12-183"></a>                    <span class="s2">&quot;Leaf certificate missing serverAuth extended key usage&quot;</span>
<a id="__codelineno-12-184" name="__codelineno-12-184" href="#__codelineno-12-184"></a>                <span class="p">)</span>
<a id="__codelineno-12-185" name="__codelineno-12-185" href="#__codelineno-12-185"></a>
<a id="__codelineno-12-186" name="__codelineno-12-186" href="#__codelineno-12-186"></a>        <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
<a id="__codelineno-12-187" name="__codelineno-12-187" href="#__codelineno-12-187"></a>            <span class="c1"># Key usage extensions are critical for security</span>
<a id="__codelineno-12-188" name="__codelineno-12-188" href="#__codelineno-12-188"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-189" name="__codelineno-12-189" href="#__codelineno-12-189"></a>                <span class="s2">&quot;Certificate missing required key usage extensions&quot;</span>
<a id="__codelineno-12-190" name="__codelineno-12-190" href="#__codelineno-12-190"></a>            <span class="p">)</span>
<a id="__codelineno-12-191" name="__codelineno-12-191" href="#__codelineno-12-191"></a>
<a id="__codelineno-12-192" name="__codelineno-12-192" href="#__codelineno-12-192"></a>        <span class="c1"># Validate CA certificates in chain</span>
<a id="__codelineno-12-193" name="__codelineno-12-193" href="#__codelineno-12-193"></a>        <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="n">certificates</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
<a id="__codelineno-12-194" name="__codelineno-12-194" href="#__codelineno-12-194"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-195" name="__codelineno-12-195" href="#__codelineno-12-195"></a>                <span class="n">basic_constraints</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span>
<a id="__codelineno-12-196" name="__codelineno-12-196" href="#__codelineno-12-196"></a>                    <span class="n">x509</span><span class="o">.</span><span class="n">BasicConstraints</span>
<a id="__codelineno-12-197" name="__codelineno-12-197" href="#__codelineno-12-197"></a>                <span class="p">)</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-12-198" name="__codelineno-12-198" href="#__codelineno-12-198"></a>
<a id="__codelineno-12-199" name="__codelineno-12-199" href="#__codelineno-12-199"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">basic_constraints</span><span class="o">.</span><span class="n">ca</span><span class="p">:</span>
<a id="__codelineno-12-200" name="__codelineno-12-200" href="#__codelineno-12-200"></a>                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-201" name="__codelineno-12-201" href="#__codelineno-12-201"></a>                        <span class="s2">&quot;Intermediate certificate doesn&#39;t have CA flag&quot;</span>
<a id="__codelineno-12-202" name="__codelineno-12-202" href="#__codelineno-12-202"></a>                    <span class="p">)</span>
<a id="__codelineno-12-203" name="__codelineno-12-203" href="#__codelineno-12-203"></a>            <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
<a id="__codelineno-12-204" name="__codelineno-12-204" href="#__codelineno-12-204"></a>                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-12-205" name="__codelineno-12-205" href="#__codelineno-12-205"></a>                    <span class="s2">&quot;CA certificate missing Basic Constraints&quot;</span>
<a id="__codelineno-12-206" name="__codelineno-12-206" href="#__codelineno-12-206"></a>                <span class="p">)</span>
</code></pre></div></p>
<h3 id="name-constraint-violations">Name Constraint Violations</h3>
<p><strong>Vulnerability</strong>: Intermediate CAs can issue certificates outside their authorized scope.</p>
<p><strong>Attack</strong>: Compromised intermediate CA issues certificates for unauthorized domains.</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># Intermediate CA constrained to *.example.com</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1"># Issues unauthorized certificate for evil.com</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">NameConstraintValidator</span><span class="p">:</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="sd">    Enforce name constraints from CA certificates</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_name_constraints</span><span class="p">(</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>        <span class="n">leaf_cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">,</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>        <span class="n">ca_chain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">]</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="sd">        Verify leaf certificate respects name constraints from CA chain</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>        <span class="c1"># Extract leaf certificate names</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>        <span class="n">leaf_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_names</span><span class="p">(</span><span class="n">leaf_cert</span><span class="p">)</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="c1"># Check constraints from each CA in chain</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>        <span class="k">for</span> <span class="n">ca_cert</span> <span class="ow">in</span> <span class="n">ca_chain</span><span class="p">:</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>                <span class="n">constraints</span> <span class="o">=</span> <span class="n">ca_cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>                    <span class="n">x509</span><span class="o">.</span><span class="n">NameConstraints</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>                <span class="p">)</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>                <span class="c1"># Check permitted subtrees</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>                <span class="k">if</span> <span class="n">constraints</span><span class="o">.</span><span class="n">permitted_subtrees</span><span class="p">:</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_in_permitted_subtrees</span><span class="p">(</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>                        <span class="n">leaf_names</span><span class="p">,</span> 
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>                        <span class="n">constraints</span><span class="o">.</span><span class="n">permitted_subtrees</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>                    <span class="p">):</span>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>                        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>                            <span class="sa">f</span><span class="s2">&quot;Certificate names </span><span class="si">{</span><span class="n">leaf_names</span><span class="si">}</span><span class="s2"> not in &quot;</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>                            <span class="sa">f</span><span class="s2">&quot;permitted subtrees&quot;</span>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>                        <span class="p">)</span>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>                <span class="c1"># Check excluded subtrees</span>
<a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>                <span class="k">if</span> <span class="n">constraints</span><span class="o">.</span><span class="n">excluded_subtrees</span><span class="p">:</span>
<a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_in_excluded_subtrees</span><span class="p">(</span>
<a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>                        <span class="n">leaf_names</span><span class="p">,</span>
<a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>                        <span class="n">constraints</span><span class="o">.</span><span class="n">excluded_subtrees</span>
<a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>                    <span class="p">):</span>
<a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>                        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>                            <span class="sa">f</span><span class="s2">&quot;Certificate names </span><span class="si">{</span><span class="n">leaf_names</span><span class="si">}</span><span class="s2"> in &quot;</span>
<a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a>                            <span class="sa">f</span><span class="s2">&quot;excluded subtrees&quot;</span>
<a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>                        <span class="p">)</span>
<a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>
<a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a>            <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
<a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a>                <span class="c1"># No name constraints in this CA</span>
<a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>                <span class="k">continue</span>
<a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a>
<a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></p>
<p><strong>Real-World Incident</strong>: TURKTRUST Incident (2013)
- TURKTRUST mistakenly issued intermediate CA certificates
- Recipients used them to issue fraudulent certificates for google.com
- Detection via Certificate Transparency
- Resolution: Revocation and removal from trust stores</p>
<h3 id="revocation-check-failures">Revocation Check Failures</h3>
<p><strong>Vulnerability</strong>: Applications don't properly check if certificates have been revoked.</p>
<p><strong>Attack</strong>: Use revoked certificate that application accepts due to missing revocation check.</p>
<p><strong>Common Failures</strong>:</p>
<p><strong>1. Not checking CRL/OCSP</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># VULNERABLE: No revocation check</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate_without_revocation</span><span class="p">(</span><span class="n">cert</span><span class="p">:</span> <span class="n">Certificate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="c1"># Only validates signature and expiration</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="k">return</span> <span class="n">verify_signature</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_expired</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="c1"># Attack: Present revoked certificate</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="c1"># Application accepts it because revocation not checked</span>
</code></pre></div></p>
<p><strong>2. Soft-fail on OCSP errors</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># VULNERABLE: Treats OCSP errors as &quot;not revoked&quot;</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">weak_revocation_check</span><span class="p">(</span><span class="n">cert</span><span class="p">:</span> <span class="n">Certificate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        <span class="n">ocsp_response</span> <span class="o">=</span> <span class="n">check_ocsp</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>        <span class="k">return</span> <span class="n">ocsp_response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;good&#39;</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="k">except</span> <span class="n">OCSPUnavailable</span><span class="p">:</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        <span class="c1"># BUG: Soft fail - assumes not revoked</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># VULNERABLE</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="c1"># Attack: Block OCSP server, revoked cert accepted</span>
</code></pre></div></p>
<p><strong>Secure Implementation</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.x509</span><span class="w"> </span><span class="kn">import</span> <span class="n">ocsp</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureRevocationChecker</span><span class="p">:</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="sd">    Comprehensive revocation checking</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">require_ocsp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">require_ocsp</span> <span class="o">=</span> <span class="n">require_ocsp</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crl_cache</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_revocation</span><span class="p">(</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>        <span class="n">cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">,</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>        <span class="n">issuer</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="sd">        Check certificate revocation status</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>        <span class="c1"># Try OCSP first (faster)</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_ocsp</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">issuer</span><span class="p">)</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>        <span class="k">except</span> <span class="n">OCSPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_ocsp</span><span class="p">:</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>                <span class="c1"># Hard fail if OCSP required</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>                    <span class="sa">f</span><span class="s2">&quot;OCSP check failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Certificate rejected.&quot;</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>                <span class="p">)</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>            <span class="c1"># Fall back to CRL</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_crl</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">issuer</span><span class="p">)</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_ocsp</span><span class="p">(</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>        <span class="n">cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">,</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>        <span class="n">issuer</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">,</span>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a><span class="sd">        Check OCSP status</span>
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>        <span class="c1"># Extract OCSP URL</span>
<a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a>            <span class="n">aia</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span>
<a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">AuthorityInformationAccess</span>
<a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a>            <span class="p">)</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a>
<a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a>            <span class="n">ocsp_urls</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a>                <span class="n">desc</span><span class="o">.</span><span class="n">access_location</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a>                <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">aia</span>
<a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a>                <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">access_method</span> <span class="o">==</span> <span class="n">x509</span><span class="o">.</span><span class="n">oid</span><span class="o">.</span><span class="n">AuthorityInformationAccessOID</span><span class="o">.</span><span class="n">OCSP</span>
<a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a>            <span class="p">]</span>
<a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a>
<a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ocsp_urls</span><span class="p">:</span>
<a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a>                <span class="k">raise</span> <span class="n">OCSPError</span><span class="p">(</span><span class="s2">&quot;No OCSP URL in certificate&quot;</span><span class="p">)</span>
<a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a>
<a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a>        <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
<a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a>            <span class="k">raise</span> <span class="n">OCSPError</span><span class="p">(</span><span class="s2">&quot;No AIA extension in certificate&quot;</span><span class="p">)</span>
<a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a>
<a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a>        <span class="c1"># Build OCSP request</span>
<a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">ocsp</span><span class="o">.</span><span class="n">OCSPRequestBuilder</span><span class="p">()</span>
<a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add_certificate</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
<a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a>        <span class="n">ocsp_request</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a>
<a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a>        <span class="c1"># Send OCSP request</span>
<a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a>        <span class="n">ocsp_url</span> <span class="o">=</span> <span class="n">ocsp_urls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a>                <span class="n">ocsp_url</span><span class="p">,</span>
<a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a>                <span class="n">data</span><span class="o">=</span><span class="n">ocsp_request</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">DER</span><span class="p">),</span>
<a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a>                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/ocsp-request&#39;</span><span class="p">},</span>
<a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
<a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a>            <span class="p">)</span>
<a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a>            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a>        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a>            <span class="k">raise</span> <span class="n">OCSPError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OCSP request failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a>
<a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a>        <span class="c1"># Parse OCSP response</span>
<a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a>        <span class="n">ocsp_response</span> <span class="o">=</span> <span class="n">ocsp</span><span class="o">.</span><span class="n">load_der_ocsp_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a>
<a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a>        <span class="c1"># Verify OCSP response</span>
<a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a>        <span class="k">if</span> <span class="n">ocsp_response</span><span class="o">.</span><span class="n">response_status</span> <span class="o">!=</span> <span class="n">ocsp</span><span class="o">.</span><span class="n">OCSPResponseStatus</span><span class="o">.</span><span class="n">SUCCESSFUL</span><span class="p">:</span>
<a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a>            <span class="k">raise</span> <span class="n">OCSPError</span><span class="p">(</span>
<a id="__codelineno-16-85" name="__codelineno-16-85" href="#__codelineno-16-85"></a>                <span class="sa">f</span><span class="s2">&quot;OCSP response status: </span><span class="si">{</span><span class="n">ocsp_response</span><span class="o">.</span><span class="n">response_status</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-16-86" name="__codelineno-16-86" href="#__codelineno-16-86"></a>            <span class="p">)</span>
<a id="__codelineno-16-87" name="__codelineno-16-87" href="#__codelineno-16-87"></a>
<a id="__codelineno-16-88" name="__codelineno-16-88" href="#__codelineno-16-88"></a>        <span class="c1"># Check certificate status</span>
<a id="__codelineno-16-89" name="__codelineno-16-89" href="#__codelineno-16-89"></a>        <span class="n">cert_status</span> <span class="o">=</span> <span class="n">ocsp_response</span><span class="o">.</span><span class="n">certificate_status</span>
<a id="__codelineno-16-90" name="__codelineno-16-90" href="#__codelineno-16-90"></a>
<a id="__codelineno-16-91" name="__codelineno-16-91" href="#__codelineno-16-91"></a>        <span class="k">if</span> <span class="n">cert_status</span> <span class="o">==</span> <span class="n">ocsp</span><span class="o">.</span><span class="n">OCSPCertStatus</span><span class="o">.</span><span class="n">REVOKED</span><span class="p">:</span>
<a id="__codelineno-16-92" name="__codelineno-16-92" href="#__codelineno-16-92"></a>            <span class="n">revocation_reason</span> <span class="o">=</span> <span class="n">ocsp_response</span><span class="o">.</span><span class="n">revocation_reason</span>
<a id="__codelineno-16-93" name="__codelineno-16-93" href="#__codelineno-16-93"></a>            <span class="n">revocation_time</span> <span class="o">=</span> <span class="n">ocsp_response</span><span class="o">.</span><span class="n">revocation_time</span>
<a id="__codelineno-16-94" name="__codelineno-16-94" href="#__codelineno-16-94"></a>            <span class="k">raise</span> <span class="n">CertificateRevoked</span><span class="p">(</span>
<a id="__codelineno-16-95" name="__codelineno-16-95" href="#__codelineno-16-95"></a>                <span class="sa">f</span><span class="s2">&quot;Certificate revoked at </span><span class="si">{</span><span class="n">revocation_time</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-16-96" name="__codelineno-16-96" href="#__codelineno-16-96"></a>                <span class="sa">f</span><span class="s2">&quot;Reason: </span><span class="si">{</span><span class="n">revocation_reason</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-16-97" name="__codelineno-16-97" href="#__codelineno-16-97"></a>            <span class="p">)</span>
<a id="__codelineno-16-98" name="__codelineno-16-98" href="#__codelineno-16-98"></a>        <span class="k">elif</span> <span class="n">cert_status</span> <span class="o">==</span> <span class="n">ocsp</span><span class="o">.</span><span class="n">OCSPCertStatus</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">:</span>
<a id="__codelineno-16-99" name="__codelineno-16-99" href="#__codelineno-16-99"></a>            <span class="k">raise</span> <span class="n">OCSPError</span><span class="p">(</span><span class="s2">&quot;OCSP responder doesn&#39;t know certificate&quot;</span><span class="p">)</span>
<a id="__codelineno-16-100" name="__codelineno-16-100" href="#__codelineno-16-100"></a>
<a id="__codelineno-16-101" name="__codelineno-16-101" href="#__codelineno-16-101"></a>        <span class="c1"># Certificate is good</span>
<a id="__codelineno-16-102" name="__codelineno-16-102" href="#__codelineno-16-102"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-16-103" name="__codelineno-16-103" href="#__codelineno-16-103"></a>
<a id="__codelineno-16-104" name="__codelineno-16-104" href="#__codelineno-16-104"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_crl</span><span class="p">(</span>
<a id="__codelineno-16-105" name="__codelineno-16-105" href="#__codelineno-16-105"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-106" name="__codelineno-16-106" href="#__codelineno-16-106"></a>        <span class="n">cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">,</span>
<a id="__codelineno-16-107" name="__codelineno-16-107" href="#__codelineno-16-107"></a>        <span class="n">issuer</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span>
<a id="__codelineno-16-108" name="__codelineno-16-108" href="#__codelineno-16-108"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-16-109" name="__codelineno-16-109" href="#__codelineno-16-109"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-110" name="__codelineno-16-110" href="#__codelineno-16-110"></a><span class="sd">        Check CRL for revocation</span>
<a id="__codelineno-16-111" name="__codelineno-16-111" href="#__codelineno-16-111"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-16-112" name="__codelineno-16-112" href="#__codelineno-16-112"></a>        <span class="c1"># Extract CRL distribution points</span>
<a id="__codelineno-16-113" name="__codelineno-16-113" href="#__codelineno-16-113"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-114" name="__codelineno-16-114" href="#__codelineno-16-114"></a>            <span class="n">crl_ext</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span>
<a id="__codelineno-16-115" name="__codelineno-16-115" href="#__codelineno-16-115"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">CRLDistributionPoints</span>
<a id="__codelineno-16-116" name="__codelineno-16-116" href="#__codelineno-16-116"></a>            <span class="p">)</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-16-117" name="__codelineno-16-117" href="#__codelineno-16-117"></a>
<a id="__codelineno-16-118" name="__codelineno-16-118" href="#__codelineno-16-118"></a>            <span class="n">crl_urls</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-16-119" name="__codelineno-16-119" href="#__codelineno-16-119"></a>            <span class="k">for</span> <span class="n">dist_point</span> <span class="ow">in</span> <span class="n">crl_ext</span><span class="p">:</span>
<a id="__codelineno-16-120" name="__codelineno-16-120" href="#__codelineno-16-120"></a>                <span class="k">if</span> <span class="n">dist_point</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
<a id="__codelineno-16-121" name="__codelineno-16-121" href="#__codelineno-16-121"></a>                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dist_point</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
<a id="__codelineno-16-122" name="__codelineno-16-122" href="#__codelineno-16-122"></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">x509</span><span class="o">.</span><span class="n">UniformResourceIdentifier</span><span class="p">):</span>
<a id="__codelineno-16-123" name="__codelineno-16-123" href="#__codelineno-16-123"></a>                            <span class="n">crl_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-16-124" name="__codelineno-16-124" href="#__codelineno-16-124"></a>
<a id="__codelineno-16-125" name="__codelineno-16-125" href="#__codelineno-16-125"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">crl_urls</span><span class="p">:</span>
<a id="__codelineno-16-126" name="__codelineno-16-126" href="#__codelineno-16-126"></a>                <span class="k">raise</span> <span class="n">CRLError</span><span class="p">(</span><span class="s2">&quot;No CRL URLs in certificate&quot;</span><span class="p">)</span>
<a id="__codelineno-16-127" name="__codelineno-16-127" href="#__codelineno-16-127"></a>
<a id="__codelineno-16-128" name="__codelineno-16-128" href="#__codelineno-16-128"></a>        <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
<a id="__codelineno-16-129" name="__codelineno-16-129" href="#__codelineno-16-129"></a>            <span class="k">raise</span> <span class="n">CRLError</span><span class="p">(</span><span class="s2">&quot;No CRL distribution points extension&quot;</span><span class="p">)</span>
<a id="__codelineno-16-130" name="__codelineno-16-130" href="#__codelineno-16-130"></a>
<a id="__codelineno-16-131" name="__codelineno-16-131" href="#__codelineno-16-131"></a>        <span class="c1"># Fetch and cache CRL</span>
<a id="__codelineno-16-132" name="__codelineno-16-132" href="#__codelineno-16-132"></a>        <span class="n">crl_url</span> <span class="o">=</span> <span class="n">crl_urls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-16-133" name="__codelineno-16-133" href="#__codelineno-16-133"></a>        <span class="k">if</span> <span class="n">crl_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crl_cache</span><span class="p">:</span>
<a id="__codelineno-16-134" name="__codelineno-16-134" href="#__codelineno-16-134"></a>            <span class="n">crl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crl_cache</span><span class="p">[</span><span class="n">crl_url</span><span class="p">]</span>
<a id="__codelineno-16-135" name="__codelineno-16-135" href="#__codelineno-16-135"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-136" name="__codelineno-16-136" href="#__codelineno-16-136"></a>            <span class="n">crl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_crl</span><span class="p">(</span><span class="n">crl_url</span><span class="p">)</span>
<a id="__codelineno-16-137" name="__codelineno-16-137" href="#__codelineno-16-137"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">crl_cache</span><span class="p">[</span><span class="n">crl_url</span><span class="p">]</span> <span class="o">=</span> <span class="n">crl</span>
<a id="__codelineno-16-138" name="__codelineno-16-138" href="#__codelineno-16-138"></a>
<a id="__codelineno-16-139" name="__codelineno-16-139" href="#__codelineno-16-139"></a>        <span class="c1"># Check if certificate is revoked</span>
<a id="__codelineno-16-140" name="__codelineno-16-140" href="#__codelineno-16-140"></a>        <span class="n">revoked_cert</span> <span class="o">=</span> <span class="n">crl</span><span class="o">.</span><span class="n">get_revoked_certificate_by_serial_number</span><span class="p">(</span>
<a id="__codelineno-16-141" name="__codelineno-16-141" href="#__codelineno-16-141"></a>            <span class="n">cert</span><span class="o">.</span><span class="n">serial_number</span>
<a id="__codelineno-16-142" name="__codelineno-16-142" href="#__codelineno-16-142"></a>        <span class="p">)</span>
<a id="__codelineno-16-143" name="__codelineno-16-143" href="#__codelineno-16-143"></a>
<a id="__codelineno-16-144" name="__codelineno-16-144" href="#__codelineno-16-144"></a>        <span class="k">if</span> <span class="n">revoked_cert</span><span class="p">:</span>
<a id="__codelineno-16-145" name="__codelineno-16-145" href="#__codelineno-16-145"></a>            <span class="k">raise</span> <span class="n">CertificateRevoked</span><span class="p">(</span>
<a id="__codelineno-16-146" name="__codelineno-16-146" href="#__codelineno-16-146"></a>                <span class="sa">f</span><span class="s2">&quot;Certificate revoked at </span><span class="si">{</span><span class="n">revoked_cert</span><span class="o">.</span><span class="n">revocation_date</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-16-147" name="__codelineno-16-147" href="#__codelineno-16-147"></a>                <span class="sa">f</span><span class="s2">&quot;Reason: </span><span class="si">{</span><span class="n">revoked_cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">CRLReason</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-16-148" name="__codelineno-16-148" href="#__codelineno-16-148"></a>            <span class="p">)</span>
<a id="__codelineno-16-149" name="__codelineno-16-149" href="#__codelineno-16-149"></a>
<a id="__codelineno-16-150" name="__codelineno-16-150" href="#__codelineno-16-150"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-16-151" name="__codelineno-16-151" href="#__codelineno-16-151"></a>
<a id="__codelineno-16-152" name="__codelineno-16-152" href="#__codelineno-16-152"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_crl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crl_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x509</span><span class="o">.</span><span class="n">CertificateRevocationList</span><span class="p">:</span>
<a id="__codelineno-16-153" name="__codelineno-16-153" href="#__codelineno-16-153"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-154" name="__codelineno-16-154" href="#__codelineno-16-154"></a><span class="sd">        Download and parse CRL</span>
<a id="__codelineno-16-155" name="__codelineno-16-155" href="#__codelineno-16-155"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-16-156" name="__codelineno-16-156" href="#__codelineno-16-156"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-157" name="__codelineno-16-157" href="#__codelineno-16-157"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">crl_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-16-158" name="__codelineno-16-158" href="#__codelineno-16-158"></a>            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-16-159" name="__codelineno-16-159" href="#__codelineno-16-159"></a>
<a id="__codelineno-16-160" name="__codelineno-16-160" href="#__codelineno-16-160"></a>            <span class="n">crl</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_der_x509_crl</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">default_backend</span><span class="p">())</span>
<a id="__codelineno-16-161" name="__codelineno-16-161" href="#__codelineno-16-161"></a>
<a id="__codelineno-16-162" name="__codelineno-16-162" href="#__codelineno-16-162"></a>            <span class="c1"># Verify CRL signature (should be signed by issuer)</span>
<a id="__codelineno-16-163" name="__codelineno-16-163" href="#__codelineno-16-163"></a>            <span class="c1"># Verify CRL is not expired</span>
<a id="__codelineno-16-164" name="__codelineno-16-164" href="#__codelineno-16-164"></a>            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">crl</span><span class="o">.</span><span class="n">next_update_utc</span><span class="p">:</span>
<a id="__codelineno-16-165" name="__codelineno-16-165" href="#__codelineno-16-165"></a>                <span class="k">raise</span> <span class="n">CRLError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRL expired at </span><span class="si">{</span><span class="n">crl</span><span class="o">.</span><span class="n">next_update_utc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-16-166" name="__codelineno-16-166" href="#__codelineno-16-166"></a>
<a id="__codelineno-16-167" name="__codelineno-16-167" href="#__codelineno-16-167"></a>            <span class="k">return</span> <span class="n">crl</span>
<a id="__codelineno-16-168" name="__codelineno-16-168" href="#__codelineno-16-168"></a>
<a id="__codelineno-16-169" name="__codelineno-16-169" href="#__codelineno-16-169"></a>        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-16-170" name="__codelineno-16-170" href="#__codelineno-16-170"></a>            <span class="k">raise</span> <span class="n">CRLError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch CRL: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="protocol-level-vulnerabilities">Protocol-Level Vulnerabilities</h2>
<h3 id="ssltls-protocol-attacks">SSL/TLS Protocol Attacks</h3>
<p><strong>BEAST (Browser Exploit Against SSL/TLS)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>Vulnerability: CBC mode cipher in TLS 1.0
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>Attack: Predict IV, decrypt HTTPS cookies
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>Mitigation: Use TLS 1.2+, prefer AEAD ciphers (AES-GCM, ChaCha20-Poly1305)
</code></pre></div></p>
<p><strong>CRIME (Compression Ratio Info-leak Made Easy)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>Vulnerability: TLS compression reveals plaintext
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>Attack: Measure compressed size to guess secrets
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>Mitigation: Disable TLS compression
</code></pre></div></p>
<p><strong>POODLE (Padding Oracle On Downgraded Legacy Encryption)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>Vulnerability: SSL 3.0 CBC padding oracle
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>Attack: Downgrade to SSL 3.0, decrypt via padding oracle
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>Mitigation: Disable SSL 3.0, use TLS 1.2+
</code></pre></div></p>
<p><strong>Heartbleed (CVE-2014-0160)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>Vulnerability: Buffer over-read in OpenSSL heartbeat
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>Attack: Read server memory, potentially exposing keys
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>Impact: 17% of web servers vulnerable
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>Mitigation: Update OpenSSL, revoke/reissue certificates
</code></pre></div></p>
<p><strong>Secure TLS Configuration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_secure_ssl_context</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">:</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="sd">    Create hardened SSL context</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="c1"># Use TLS 1.2 minimum</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLS_SERVER</span><span class="p">)</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="n">context</span><span class="o">.</span><span class="n">minimum_version</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">TLSVersion</span><span class="o">.</span><span class="n">TLSv1_2</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>    <span class="c1"># Disable insecure features</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>    <span class="n">context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_COMPRESSION</span>  <span class="c1"># Prevent CRIME</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>    <span class="n">context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>    <span class="n">context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv3</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>    <span class="n">context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_TLSv1</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>    <span class="n">context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_TLSv1_1</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>    <span class="c1"># Prefer server cipher order</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>    <span class="n">context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_CIPHER_SERVER_PREFERENCE</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>    <span class="c1"># Use secure ciphers only</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>    <span class="n">context</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="s1">&#39;ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:!aNULL:!MD5:!DSS&#39;</span><span class="p">)</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>    <span class="c1"># Enable certificate validation</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>    <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>    <span class="n">context</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>    <span class="c1"># Load trusted CA certificates</span>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>    <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="s1">&#39;/path/to/ca-bundle.crt&#39;</span><span class="p">)</span>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>    <span class="k">return</span> <span class="n">context</span>
</code></pre></div></p>
<h3 id="downgrade-attacks">Downgrade Attacks</h3>
<p><strong>Attack</strong>: Force connection to use weaker protocol version or cipher.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># Attacker intercepts ClientHello</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="c1"># Modifies to remove strong cipher suites</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="c1"># Server selects weak cipher from remaining options</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">DowngradeDetector</span><span class="p">:</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="sd">    Detect and prevent protocol downgrade attacks</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_tls_handshake</span><span class="p">(</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>        <span class="n">client_hello</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>        <span class="n">server_hello</span><span class="p">:</span> <span class="nb">bytes</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="sd">        Verify server didn&#39;t downgrade connection</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>        <span class="c1"># Parse handshake messages</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>        <span class="n">client_versions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_supported_versions</span><span class="p">(</span><span class="n">client_hello</span><span class="p">)</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>        <span class="n">negotiated_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_negotiated_version</span><span class="p">(</span><span class="n">server_hello</span><span class="p">)</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>        <span class="c1"># Verify negotiated version is highest mutually supported</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>        <span class="k">if</span> <span class="n">negotiated_version</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">client_versions</span><span class="p">):</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>            <span class="k">raise</span> <span class="n">DowngradeError</span><span class="p">(</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>                <span class="sa">f</span><span class="s2">&quot;Potential downgrade attack: &quot;</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>                <span class="sa">f</span><span class="s2">&quot;Negotiated </span><span class="si">{</span><span class="n">negotiated_version</span><span class="si">}</span><span class="s2"> but client supports &quot;</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">client_versions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>            <span class="p">)</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>        <span class="c1"># Check for downgrade protection signals (RFC 8446)</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>        <span class="n">server_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_server_random</span><span class="p">(</span><span class="n">server_hello</span><span class="p">)</span>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>        <span class="k">if</span> <span class="n">negotiated_version</span> <span class="o">&lt;</span> <span class="n">TLSVersion</span><span class="o">.</span><span class="n">TLS_1_3</span><span class="p">:</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>            <span class="c1"># TLS 1.2 should include downgrade protection</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>            <span class="n">downgrade_signal</span> <span class="o">=</span> <span class="n">server_random</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>            <span class="n">expected_signals</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>                <span class="sa">b</span><span class="s2">&quot;DOWNGRD</span><span class="se">\x01</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># TLS 1.2 downgrade from 1.3</span>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>                <span class="sa">b</span><span class="s2">&quot;DOWNGRD</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># TLS 1.1 or below downgrade</span>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>            <span class="p">]</span>
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">signal</span> <span class="ow">in</span> <span class="n">downgrade_signal</span> <span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">expected_signals</span><span class="p">):</span>
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>                <span class="c1"># Server signaling downgrade - could be attack</span>
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_supports_tls_1_3</span><span class="p">():</span>
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a>                    <span class="k">raise</span> <span class="n">DowngradeError</span><span class="p">(</span>
<a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a>                        <span class="s2">&quot;Server signaled downgrade from TLS 1.3&quot;</span>
<a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a>                    <span class="p">)</span>
<a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a>
<a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p><strong>Mitigation - SCSV (Signaling Cipher Suite Value)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># Client includes TLS_FALLBACK_SCSV in cipher suite list</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="c1"># Server detects if client supports higher version than negotiated</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="c1"># Server aborts if downgrade detected</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="n">TLS_FALLBACK_SCSV</span> <span class="o">=</span> <span class="mh">0x5600</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">server_check_scsv</span><span class="p">(</span><span class="n">client_hello</span><span class="p">:</span> <span class="n">ClientHello</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="sd">    Server-side downgrade detection</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>    <span class="k">if</span> <span class="n">TLS_FALLBACK_SCSV</span> <span class="ow">in</span> <span class="n">client_hello</span><span class="o">.</span><span class="n">cipher_suites</span><span class="p">:</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>        <span class="c1"># Client is using fallback mechanism</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>        <span class="k">if</span> <span class="n">client_hello</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">server_max_supported_version</span><span class="p">:</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>            <span class="c1"># Inappropriate fallback - abort</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>            <span class="k">raise</span> <span class="n">DowngradeError</span><span class="p">(</span><span class="s2">&quot;Inappropriate fallback detected&quot;</span><span class="p">)</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></p>
<h2 id="implementation-vulnerabilities">Implementation Vulnerabilities</h2>
<h3 id="improper-certificate-storage">Improper Certificate Storage</h3>
<p><strong>Vulnerability</strong>: Certificates and private keys stored insecurely.</p>
<p><strong>Common Mistakes</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># VULNERABLE: Hardcoded in source code</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">PRIVATE_KEY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;-----BEGIN PRIVATE KEY-----</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="s2">MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC7...</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="s2">-----END PRIVATE KEY-----&quot;&quot;&quot;</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="c1"># VULNERABLE: World-readable file permissions</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="c1"># -rw-r--r-- 1 root root 1704 private.key</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="c1"># VULNERABLE: Stored in version control</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="n">git</span> <span class="n">add</span> <span class="n">certificates</span><span class="o">/</span><span class="n">private</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">pem</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;Add certificate&quot;</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="n">git</span> <span class="n">push</span>  <span class="c1"># Now in Git history forever</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="c1"># VULNERABLE: Logged in plaintext</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using private key: </span><span class="si">{</span><span class="n">private_key_pem</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Secure Storage</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">rsa</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureCertificateStorage</span><span class="p">:</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="sd">    Secure certificate and key storage practices</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">store_private_key</span><span class="p">(</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>        <span class="n">private_key</span><span class="p">:</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPrivateKey</span><span class="p">,</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>        <span class="n">password</span><span class="p">:</span> <span class="nb">bytes</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>    <span class="p">):</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="sd">        Store private key with encryption and proper permissions</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>        <span class="c1"># Encrypt private key</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>        <span class="n">pem</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">private_bytes</span><span class="p">(</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>            <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>            <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PrivateFormat</span><span class="o">.</span><span class="n">PKCS8</span><span class="p">,</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>            <span class="n">encryption_algorithm</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">BestAvailableEncryption</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>        <span class="p">)</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>        <span class="c1"># Create file with restrictive permissions (owner only)</span>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>        <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mo">0o077</span><span class="p">)</span>  <span class="c1"># Remove all group/other permissions</span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pem</span><span class="p">)</span>
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>        <span class="c1"># Verify permissions</span>
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>        <span class="n">stat_info</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a>        <span class="k">if</span> <span class="n">stat_info</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o077</span><span class="p">:</span>  <span class="c1"># Group or other can access</span>
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>                <span class="sa">f</span><span class="s2">&quot;Insecure permissions on </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">oct</span><span class="p">(</span><span class="n">stat_info</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a>            <span class="p">)</span>
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a>        <span class="c1"># Set immutable flag (Linux)</span>
<a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a>            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;chattr +i </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>            <span class="k">pass</span>  <span class="c1"># Not all filesystems support</span>
<a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a>
<a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_private_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPrivateKey</span><span class="p">:</span>
<a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a><span class="sd">        Load encrypted private key</span>
<a id="__codelineno-25-48" name="__codelineno-25-48" href="#__codelineno-25-48"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-25-49" name="__codelineno-25-49" href="#__codelineno-25-49"></a>        <span class="c1"># Verify file permissions before reading</span>
<a id="__codelineno-25-50" name="__codelineno-25-50" href="#__codelineno-25-50"></a>        <span class="n">stat_info</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
<a id="__codelineno-25-51" name="__codelineno-25-51" href="#__codelineno-25-51"></a>        <span class="k">if</span> <span class="n">stat_info</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o077</span><span class="p">:</span>
<a id="__codelineno-25-52" name="__codelineno-25-52" href="#__codelineno-25-52"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-25-53" name="__codelineno-25-53" href="#__codelineno-25-53"></a>                <span class="sa">f</span><span class="s2">&quot;Insecure permissions on </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-25-54" name="__codelineno-25-54" href="#__codelineno-25-54"></a>                <span class="sa">f</span><span class="s2">&quot;Expected 0600, got </span><span class="si">{</span><span class="nb">oct</span><span class="p">(</span><span class="n">stat_info</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-55" name="__codelineno-25-55" href="#__codelineno-25-55"></a>            <span class="p">)</span>
<a id="__codelineno-25-56" name="__codelineno-25-56" href="#__codelineno-25-56"></a>
<a id="__codelineno-25-57" name="__codelineno-25-57" href="#__codelineno-25-57"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-25-58" name="__codelineno-25-58" href="#__codelineno-25-58"></a>            <span class="n">pem</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-25-59" name="__codelineno-25-59" href="#__codelineno-25-59"></a>
<a id="__codelineno-25-60" name="__codelineno-25-60" href="#__codelineno-25-60"></a>        <span class="k">return</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span>
<a id="__codelineno-25-61" name="__codelineno-25-61" href="#__codelineno-25-61"></a>            <span class="n">pem</span><span class="p">,</span>
<a id="__codelineno-25-62" name="__codelineno-25-62" href="#__codelineno-25-62"></a>            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
<a id="__codelineno-25-63" name="__codelineno-25-63" href="#__codelineno-25-63"></a>            <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">()</span>
<a id="__codelineno-25-64" name="__codelineno-25-64" href="#__codelineno-25-64"></a>        <span class="p">)</span>
<a id="__codelineno-25-65" name="__codelineno-25-65" href="#__codelineno-25-65"></a>
<a id="__codelineno-25-66" name="__codelineno-25-66" href="#__codelineno-25-66"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">use_hsm_for_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-25-67" name="__codelineno-25-67" href="#__codelineno-25-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-25-68" name="__codelineno-25-68" href="#__codelineno-25-68"></a><span class="sd">        Store keys in Hardware Security Module (recommended)</span>
<a id="__codelineno-25-69" name="__codelineno-25-69" href="#__codelineno-25-69"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-25-70" name="__codelineno-25-70" href="#__codelineno-25-70"></a>        <span class="c1"># HSM keeps private keys in tamper-resistant hardware</span>
<a id="__codelineno-25-71" name="__codelineno-25-71" href="#__codelineno-25-71"></a>        <span class="c1"># Keys never leave HSM - only sign/decrypt operations performed</span>
<a id="__codelineno-25-72" name="__codelineno-25-72" href="#__codelineno-25-72"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span>
<a id="__codelineno-25-73" name="__codelineno-25-73" href="#__codelineno-25-73"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.backends.pkcs11</span><span class="w"> </span><span class="kn">import</span> <span class="n">PKCS11Backend</span>
<a id="__codelineno-25-74" name="__codelineno-25-74" href="#__codelineno-25-74"></a>
<a id="__codelineno-25-75" name="__codelineno-25-75" href="#__codelineno-25-75"></a>        <span class="c1"># Connect to HSM</span>
<a id="__codelineno-25-76" name="__codelineno-25-76" href="#__codelineno-25-76"></a>        <span class="n">backend</span> <span class="o">=</span> <span class="n">PKCS11Backend</span><span class="p">(</span><span class="s1">&#39;/usr/lib/libpkcs11.so&#39;</span><span class="p">)</span>
<a id="__codelineno-25-77" name="__codelineno-25-77" href="#__codelineno-25-77"></a>
<a id="__codelineno-25-78" name="__codelineno-25-78" href="#__codelineno-25-78"></a>        <span class="c1"># Access key by label (never extract private key)</span>
<a id="__codelineno-25-79" name="__codelineno-25-79" href="#__codelineno-25-79"></a>        <span class="n">key</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">get_private_key</span><span class="p">(</span><span class="n">key_label</span><span class="p">)</span>
<a id="__codelineno-25-80" name="__codelineno-25-80" href="#__codelineno-25-80"></a>
<a id="__codelineno-25-81" name="__codelineno-25-81" href="#__codelineno-25-81"></a>        <span class="c1"># Perform operations on HSM</span>
<a id="__codelineno-25-82" name="__codelineno-25-82" href="#__codelineno-25-82"></a>        <span class="n">signature</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
<a id="__codelineno-25-83" name="__codelineno-25-83" href="#__codelineno-25-83"></a>
<a id="__codelineno-25-84" name="__codelineno-25-84" href="#__codelineno-25-84"></a>        <span class="k">return</span> <span class="n">signature</span>
</code></pre></div></p>
<h3 id="insufficient-random-generation">Insufficient Random Generation</h3>
<p><strong>Vulnerability</strong>: Weak randomness in nonces, IVs, or key generation.</p>
<p><strong>Attack</strong>: Predict random values, break cryptography.</p>
<p><strong>Secure Random Generation</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureRandomGenerator</span><span class="p">:</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="sd">    Generate cryptographically secure random values</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_nonce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="sd">        Generate random nonce for cryptographic use</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>        <span class="c1"># Use secrets module (CSPRNG)</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>        <span class="k">return</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_bytes</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="sd">        Generate unguessable session identifier</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>        <span class="c1"># 32 bytes = 256 bits of entropy</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>        <span class="k">return</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_entropy_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="sd">        Verify system has sufficient entropy</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>        <span class="c1"># Check available entropy (Linux)</span>
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/proc/sys/kernel/random/entropy_avail&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a>                <span class="n">entropy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a>
<a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a>            <span class="k">if</span> <span class="n">entropy</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">:</span>
<a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a>                <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a>                    <span class="sa">f</span><span class="s2">&quot;Insufficient system entropy: </span><span class="si">{</span><span class="n">entropy</span><span class="si">}</span><span class="s2"> bits&quot;</span>
<a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>                <span class="p">)</span>
<a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a>            <span class="k">pass</span>  <span class="c1"># Not Linux</span>
<a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a>
<a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bad_random_examples</span><span class="p">():</span>
<a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="sd">        Examples of INSECURE random generation (DO NOT USE)</span>
<a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a>
<a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a>        <span class="c1"># VULNERABLE: Predictable seed</span>
<a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a>        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
<a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a>        <span class="n">weak_random</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
<a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a>
<a id="__codelineno-26-51" name="__codelineno-26-51" href="#__codelineno-26-51"></a>        <span class="c1"># VULNERABLE: Not cryptographically secure</span>
<a id="__codelineno-26-52" name="__codelineno-26-52" href="#__codelineno-26-52"></a>        <span class="n">weak_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<a id="__codelineno-26-53" name="__codelineno-26-53" href="#__codelineno-26-53"></a>
<a id="__codelineno-26-54" name="__codelineno-26-54" href="#__codelineno-26-54"></a>        <span class="c1"># VULNERABLE: Using timestamp</span>
<a id="__codelineno-26-55" name="__codelineno-26-55" href="#__codelineno-26-55"></a>        <span class="n">weak_nonce</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<a id="__codelineno-26-56" name="__codelineno-26-56" href="#__codelineno-26-56"></a>
<a id="__codelineno-26-57" name="__codelineno-26-57" href="#__codelineno-26-57"></a>        <span class="k">return</span> <span class="s2">&quot;These are all INSECURE - DO NOT USE&quot;</span>
</code></pre></div></p>
<h2 id="supply-chain-vulnerabilities">Supply Chain Vulnerabilities</h2>
<h3 id="compromised-certificate-authorities">Compromised Certificate Authorities</h3>
<p><strong>Incident Examples</strong>:</p>
<p><strong>DigiNotar (2011)</strong>:</p>
<ul>
<li>Dutch CA compromised by attackers</li>
<li>Issued fraudulent certificates for google.com, gmail.com, etc.</li>
<li>Used for surveillance in Iran</li>
<li>Impact: CA removed from all trust stores, company bankrupt</li>
</ul>
<p><strong>CNNIC (2015)</strong>:</p>
<ul>
<li>Chinese CA issued unauthorized intermediate CA certificate</li>
<li>Used to intercept HTTPS traffic</li>
<li>Impact: CNNIC removed from trust stores</li>
</ul>
<p><strong>Symantec (2017)</strong>:</p>
<ul>
<li>Improper issuance of 30,000+ certificates</li>
<li>Failed to follow industry standards</li>
<li>Impact: All Symantec certificates distrusted by browsers</li>
</ul>
<p><strong>Detection and Response</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">CACompromiseDetector</span><span class="p">:</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="sd">    Detect and respond to CA compromise</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_ct_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">your_domains</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="sd">        Monitor Certificate Transparency logs for unauthorized issuance</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>        <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">your_domains</span><span class="p">:</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>            <span class="c1"># Query CT logs</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>                <span class="sa">f</span><span class="s1">&#39;https://crt.sh/?q=%.</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s1">&amp;output=json&#39;</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>            <span class="p">)</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a>            <span class="n">certificates</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>            <span class="c1"># Check for unexpected issuers</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a>            <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="n">certificates</span><span class="p">:</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_authorized_issuer</span><span class="p">(</span><span class="n">cert</span><span class="p">[</span><span class="s1">&#39;issuer_name&#39;</span><span class="p">]):</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">alert_unauthorized_cert</span><span class="p">(</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>                        <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>                        <span class="n">issuer</span><span class="o">=</span><span class="n">cert</span><span class="p">[</span><span class="s1">&#39;issuer_name&#39;</span><span class="p">],</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>                        <span class="n">issued_at</span><span class="o">=</span><span class="n">cert</span><span class="p">[</span><span class="s1">&#39;not_before&#39;</span><span class="p">],</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>                        <span class="n">serial</span><span class="o">=</span><span class="n">cert</span><span class="p">[</span><span class="s1">&#39;serial_number&#39;</span><span class="p">]</span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>                    <span class="p">)</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_authorized_issuer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">issuer</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a><span class="sd">        Check if CA is authorized to issue certs for your domains</span>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>        <span class="n">authorized_cas</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a>            <span class="s1">&#39;Let</span><span class="se">\&#39;</span><span class="s1">s Encrypt&#39;</span><span class="p">,</span>
<a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a>            <span class="s1">&#39;DigiCert&#39;</span><span class="p">,</span>
<a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a>            <span class="s1">&#39;Your Internal CA&#39;</span><span class="p">,</span>
<a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a>        <span class="p">]</span>
<a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>
<a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">ca</span> <span class="ow">in</span> <span class="n">issuer</span> <span class="k">for</span> <span class="n">ca</span> <span class="ow">in</span> <span class="n">authorized_cas</span><span class="p">)</span>
<a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>
<a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">alert_unauthorized_cert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">details</span><span class="p">):</span>
<a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a><span class="sd">        Alert on unauthorized certificate issuance</span>
<a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a>        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a>            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;critical&#39;</span><span class="p">,</span>
<a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Unauthorized Certificate Detected&#39;</span><span class="p">,</span>
<a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a>            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
<a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a>            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a>                <span class="s1">&#39;1. Verify certificate legitimacy&#39;</span><span class="p">,</span>
<a id="__codelineno-27-54" name="__codelineno-27-54" href="#__codelineno-27-54"></a>                <span class="s1">&#39;2. If fraudulent, report to CA&#39;</span><span class="p">,</span>
<a id="__codelineno-27-55" name="__codelineno-27-55" href="#__codelineno-27-55"></a>                <span class="s1">&#39;3. Request revocation&#39;</span><span class="p">,</span>
<a id="__codelineno-27-56" name="__codelineno-27-56" href="#__codelineno-27-56"></a>                <span class="s1">&#39;4. Notify browser vendors&#39;</span><span class="p">,</span>
<a id="__codelineno-27-57" name="__codelineno-27-57" href="#__codelineno-27-57"></a>                <span class="s1">&#39;5. Implement certificate pinning&#39;</span><span class="p">,</span>
<a id="__codelineno-27-58" name="__codelineno-27-58" href="#__codelineno-27-58"></a>            <span class="p">]</span>
<a id="__codelineno-27-59" name="__codelineno-27-59" href="#__codelineno-27-59"></a>        <span class="p">}</span>
<a id="__codelineno-27-60" name="__codelineno-27-60" href="#__codelineno-27-60"></a>
<a id="__codelineno-27-61" name="__codelineno-27-61" href="#__codelineno-27-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="malicious-dependencies">Malicious Dependencies</h3>
<p><strong>Vulnerability</strong>: Compromised PKI libraries or dependencies.</p>
<p><strong>Event Stream Incident (2018)</strong>:</p>
<ul>
<li>Popular npm package compromised</li>
<li>Injected code to steal cryptocurrency wallets</li>
<li>Affected thousands of applications</li>
</ul>
<p><strong>Protection</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">DependencyVerification</span><span class="p">:</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="sd">    Verify integrity of PKI dependencies</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="sd">        Verify package hasn&#39;t been tampered with</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>        <span class="c1"># Check package hash against known good values</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>        <span class="n">known_hashes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_known_hashes</span><span class="p">()</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>        <span class="n">package_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">==</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>        <span class="k">if</span> <span class="n">package_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_hashes</span><span class="p">:</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>                <span class="sa">f</span><span class="s2">&quot;Unknown package version: </span><span class="si">{</span><span class="n">package_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>            <span class="p">)</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>        <span class="c1"># Download and hash package</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>        <span class="n">package_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_package</span><span class="p">(</span><span class="n">package_name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>        <span class="n">actual_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">package_data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a>
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a>        <span class="n">expected_hash</span> <span class="o">=</span> <span class="n">known_hashes</span><span class="p">[</span><span class="n">package_id</span><span class="p">]</span>
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a>
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a>        <span class="k">if</span> <span class="n">actual_hash</span> <span class="o">!=</span> <span class="n">expected_hash</span><span class="p">:</span>
<a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a>                <span class="sa">f</span><span class="s2">&quot;Package hash mismatch for </span><span class="si">{</span><span class="n">package_id</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a>                <span class="sa">f</span><span class="s2">&quot;Expected: </span><span class="si">{</span><span class="n">expected_hash</span><span class="si">}</span><span class="s2">, Got: </span><span class="si">{</span><span class="n">actual_hash</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a>                <span class="sa">f</span><span class="s2">&quot;Package may be compromised!&quot;</span>
<a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a>            <span class="p">)</span>
<a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a>
<a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a>
<a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">audit_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a><span class="sd">        Audit all cryptography-related dependencies</span>
<a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">pkg_resources</span>
<a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a>
<a id="__codelineno-28-43" name="__codelineno-28-43" href="#__codelineno-28-43"></a>        <span class="n">crypto_packages</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-28-44" name="__codelineno-28-44" href="#__codelineno-28-44"></a>            <span class="s1">&#39;cryptography&#39;</span><span class="p">,</span>
<a id="__codelineno-28-45" name="__codelineno-28-45" href="#__codelineno-28-45"></a>            <span class="s1">&#39;pyopenssl&#39;</span><span class="p">,</span>
<a id="__codelineno-28-46" name="__codelineno-28-46" href="#__codelineno-28-46"></a>            <span class="s1">&#39;certifi&#39;</span><span class="p">,</span>
<a id="__codelineno-28-47" name="__codelineno-28-47" href="#__codelineno-28-47"></a>            <span class="s1">&#39;urllib3&#39;</span><span class="p">,</span>
<a id="__codelineno-28-48" name="__codelineno-28-48" href="#__codelineno-28-48"></a>            <span class="s1">&#39;requests&#39;</span><span class="p">,</span>
<a id="__codelineno-28-49" name="__codelineno-28-49" href="#__codelineno-28-49"></a>        <span class="p">]</span>
<a id="__codelineno-28-50" name="__codelineno-28-50" href="#__codelineno-28-50"></a>
<a id="__codelineno-28-51" name="__codelineno-28-51" href="#__codelineno-28-51"></a>        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">crypto_packages</span><span class="p">:</span>
<a id="__codelineno-28-52" name="__codelineno-28-52" href="#__codelineno-28-52"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-28-53" name="__codelineno-28-53" href="#__codelineno-28-53"></a>                <span class="n">dist</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
<a id="__codelineno-28-54" name="__codelineno-28-54" href="#__codelineno-28-54"></a>                <span class="n">version</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">version</span>
<a id="__codelineno-28-55" name="__codelineno-28-55" href="#__codelineno-28-55"></a>
<a id="__codelineno-28-56" name="__codelineno-28-56" href="#__codelineno-28-56"></a>                <span class="c1"># Check for known vulnerabilities</span>
<a id="__codelineno-28-57" name="__codelineno-28-57" href="#__codelineno-28-57"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_vulnerabilities</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<a id="__codelineno-28-58" name="__codelineno-28-58" href="#__codelineno-28-58"></a>                    <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-28-59" name="__codelineno-28-59" href="#__codelineno-28-59"></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2"> has known vulnerabilities. &quot;</span>
<a id="__codelineno-28-60" name="__codelineno-28-60" href="#__codelineno-28-60"></a>                        <span class="sa">f</span><span class="s2">&quot;Update immediately!&quot;</span>
<a id="__codelineno-28-61" name="__codelineno-28-61" href="#__codelineno-28-61"></a>                    <span class="p">)</span>
<a id="__codelineno-28-62" name="__codelineno-28-62" href="#__codelineno-28-62"></a>
<a id="__codelineno-28-63" name="__codelineno-28-63" href="#__codelineno-28-63"></a>                <span class="c1"># Verify integrity</span>
<a id="__codelineno-28-64" name="__codelineno-28-64" href="#__codelineno-28-64"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">verify_package</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
<a id="__codelineno-28-65" name="__codelineno-28-65" href="#__codelineno-28-65"></a>
<a id="__codelineno-28-66" name="__codelineno-28-66" href="#__codelineno-28-66"></a>            <span class="k">except</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">DistributionNotFound</span><span class="p">:</span>
<a id="__codelineno-28-67" name="__codelineno-28-67" href="#__codelineno-28-67"></a>                <span class="k">continue</span>
</code></pre></div></p>
<h2 id="operational-vulnerabilities">Operational Vulnerabilities</h2>
<h3 id="certificate-expiration">Certificate Expiration</h3>
<p><strong>Impact</strong>: Service outages when certificates expire unexpectedly.</p>
<p><strong>Famous Incidents</strong>:</p>
<ul>
<li>Microsoft Teams (2020): Global outage due to expired certificate</li>
<li>Spotify (2020): Outage from expired cert</li>
<li>Ericsson (2018): Mobile network outage affecting millions</li>
</ul>
<p><strong>Prevention</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">CertificateExpirationMonitor</span><span class="p">:</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="sd">    Monitor and alert on approaching certificate expiration</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warning_days</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">warning_days</span> <span class="o">=</span> <span class="n">warning_days</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_expiration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="sd">        Check certificate expiration and return status</span>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>        <span class="n">expires</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">not_valid_after_utc</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>        <span class="n">days_until_expiry</span> <span class="o">=</span> <span class="p">(</span><span class="n">expires</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>        <span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a>            <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="n">expires</span><span class="p">,</span>
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a>            <span class="s1">&#39;days_remaining&#39;</span><span class="p">:</span> <span class="n">days_until_expiry</span><span class="p">,</span>
<a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a>            <span class="s1">&#39;action_required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a>        <span class="p">}</span>
<a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a>
<a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a>        <span class="k">if</span> <span class="n">days_until_expiry</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a>            <span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;expired&#39;</span>
<a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a>            <span class="n">status</span><span class="p">[</span><span class="s1">&#39;action_required&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a>            <span class="n">status</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;critical&#39;</span>
<a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a>        <span class="k">elif</span> <span class="n">days_until_expiry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning_days</span><span class="p">:</span>
<a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a>            <span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;expiring_soon&#39;</span>
<a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a>            <span class="n">status</span><span class="p">[</span><span class="s1">&#39;action_required&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a>            <span class="n">status</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_severity</span><span class="p">(</span><span class="n">days_until_expiry</span><span class="p">)</span>
<a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-29-36" name="__codelineno-29-36" href="#__codelineno-29-36"></a>            <span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;valid&#39;</span>
<a id="__codelineno-29-37" name="__codelineno-29-37" href="#__codelineno-29-37"></a>
<a id="__codelineno-29-38" name="__codelineno-29-38" href="#__codelineno-29-38"></a>        <span class="k">return</span> <span class="n">status</span>
<a id="__codelineno-29-39" name="__codelineno-29-39" href="#__codelineno-29-39"></a>
<a id="__codelineno-29-40" name="__codelineno-29-40" href="#__codelineno-29-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_severity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_remaining</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-29-41" name="__codelineno-29-41" href="#__codelineno-29-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-29-42" name="__codelineno-29-42" href="#__codelineno-29-42"></a><span class="sd">        Determine alert severity based on days remaining</span>
<a id="__codelineno-29-43" name="__codelineno-29-43" href="#__codelineno-29-43"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-29-44" name="__codelineno-29-44" href="#__codelineno-29-44"></a>        <span class="k">if</span> <span class="n">days_remaining</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-29-45" name="__codelineno-29-45" href="#__codelineno-29-45"></a>            <span class="k">return</span> <span class="s1">&#39;critical&#39;</span>
<a id="__codelineno-29-46" name="__codelineno-29-46" href="#__codelineno-29-46"></a>        <span class="k">elif</span> <span class="n">days_remaining</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
<a id="__codelineno-29-47" name="__codelineno-29-47" href="#__codelineno-29-47"></a>            <span class="k">return</span> <span class="s1">&#39;high&#39;</span>
<a id="__codelineno-29-48" name="__codelineno-29-48" href="#__codelineno-29-48"></a>        <span class="k">elif</span> <span class="n">days_remaining</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">:</span>
<a id="__codelineno-29-49" name="__codelineno-29-49" href="#__codelineno-29-49"></a>            <span class="k">return</span> <span class="s1">&#39;medium&#39;</span>
<a id="__codelineno-29-50" name="__codelineno-29-50" href="#__codelineno-29-50"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-29-51" name="__codelineno-29-51" href="#__codelineno-29-51"></a>            <span class="k">return</span> <span class="s1">&#39;low&#39;</span>
<a id="__codelineno-29-52" name="__codelineno-29-52" href="#__codelineno-29-52"></a>
<a id="__codelineno-29-53" name="__codelineno-29-53" href="#__codelineno-29-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">automated_renewal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">,</span> <span class="n">threshold_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
<a id="__codelineno-29-54" name="__codelineno-29-54" href="#__codelineno-29-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-29-55" name="__codelineno-29-55" href="#__codelineno-29-55"></a><span class="sd">        Automatically renew certificates approaching expiration</span>
<a id="__codelineno-29-56" name="__codelineno-29-56" href="#__codelineno-29-56"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-29-57" name="__codelineno-29-57" href="#__codelineno-29-57"></a>        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_expiration</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
<a id="__codelineno-29-58" name="__codelineno-29-58" href="#__codelineno-29-58"></a>
<a id="__codelineno-29-59" name="__codelineno-29-59" href="#__codelineno-29-59"></a>        <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;days_remaining&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold_days</span><span class="p">:</span>
<a id="__codelineno-29-60" name="__codelineno-29-60" href="#__codelineno-29-60"></a>            <span class="c1"># Trigger automated renewal</span>
<a id="__codelineno-29-61" name="__codelineno-29-61" href="#__codelineno-29-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">initiate_renewal</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="insufficient-monitoring">Insufficient Monitoring</h3>
<p><strong>Problem</strong>: No visibility into certificate inventory and health.</p>
<p><strong>Solution</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ComprehensiveMonitoring</span><span class="p">:</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="sd">    Monitor all aspects of certificate infrastructure</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">collect_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="sd">        Collect comprehensive certificate metrics</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>            <span class="s1">&#39;inventory&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>                <span class="s1">&#39;total_certificates&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_all_certificates</span><span class="p">(),</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>                <span class="s1">&#39;by_environment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">certificates_by_environment</span><span class="p">(),</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>                <span class="s1">&#39;by_issuer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">certificates_by_issuer</span><span class="p">(),</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>            <span class="p">},</span>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>            <span class="s1">&#39;expiration&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>                <span class="s1">&#39;expiring_90_days&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_expiring_within</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>                <span class="s1">&#39;expiring_30_days&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_expiring_within</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>                <span class="s1">&#39;expiring_7_days&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_expiring_within</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a>                <span class="s1">&#39;expired&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_expired</span><span class="p">(),</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a>            <span class="p">},</span>
<a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a>            <span class="s1">&#39;security&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a>                <span class="s1">&#39;weak_keys&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_weak_keys</span><span class="p">(),</span>
<a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a>                <span class="s1">&#39;deprecated_algorithms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_deprecated_algorithms</span><span class="p">(),</span>
<a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a>                <span class="s1">&#39;revoked_certificates&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_revoked</span><span class="p">(),</span>
<a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a>                <span class="s1">&#39;pinning_failures&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_pinning_failures</span><span class="p">(),</span>
<a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a>            <span class="p">},</span>
<a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a>            <span class="s1">&#39;operations&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a>                <span class="s1">&#39;renewal_success_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_renewal_success_rate</span><span class="p">(),</span>
<a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a>                <span class="s1">&#39;average_lifetime&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_average_lifetime</span><span class="p">(),</span>
<a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a>                <span class="s1">&#39;deployment_failures&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_deployment_failures</span><span class="p">(),</span>
<a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a>            <span class="p">},</span>
<a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a>        <span class="p">}</span>
</code></pre></div></p>
<h2 id="defense-in-depth-strategies">Defense in Depth Strategies</h2>
<h3 id="layered-security-controls">Layered Security Controls</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">DefenseInDepth</span><span class="p">:</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="sd">    Implement multiple layers of security</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_with_multiple_layers</span><span class="p">(</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>        <span class="n">cert_chain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>        <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="sd">        Apply multiple validation layers</span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>        <span class="c1"># Layer 1: Standard PKI validation</span>
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">standard_validation</span><span class="p">(</span><span class="n">cert_chain</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>        <span class="c1"># Layer 2: Certificate pinning</span>
<a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verify_pins</span><span class="p">(</span><span class="n">cert_chain</span><span class="p">)</span>
<a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>
<a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a>        <span class="c1"># Layer 3: Certificate Transparency verification</span>
<a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verify_ct_logs</span><span class="p">(</span><span class="n">cert_chain</span><span class="p">)</span>
<a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a>
<a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>        <span class="c1"># Layer 4: Revocation checking (hard fail)</span>
<a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">check_revocation</span><span class="p">(</span><span class="n">cert_chain</span><span class="p">)</span>
<a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a>
<a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a>        <span class="c1"># Layer 5: Additional security checks</span>
<a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">advanced_security_checks</span><span class="p">(</span><span class="n">cert_chain</span><span class="p">)</span>
<a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a>
<a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a>
<a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">advanced_security_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert_chain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">]):</span>
<a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a><span class="sd">        Additional security validations</span>
<a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a>        <span class="n">leaf_cert</span> <span class="o">=</span> <span class="n">cert_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a>
<a id="__codelineno-31-37" name="__codelineno-31-37" href="#__codelineno-31-37"></a>        <span class="c1"># Check key strength</span>
<a id="__codelineno-31-38" name="__codelineno-31-38" href="#__codelineno-31-38"></a>        <span class="n">public_key</span> <span class="o">=</span> <span class="n">leaf_cert</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
<a id="__codelineno-31-39" name="__codelineno-31-39" href="#__codelineno-31-39"></a>        <span class="k">if</span> <span class="n">public_key</span><span class="o">.</span><span class="n">key_size</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">:</span>
<a id="__codelineno-31-40" name="__codelineno-31-40" href="#__codelineno-31-40"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">&quot;Weak key size&quot;</span><span class="p">)</span>
<a id="__codelineno-31-41" name="__codelineno-31-41" href="#__codelineno-31-41"></a>
<a id="__codelineno-31-42" name="__codelineno-31-42" href="#__codelineno-31-42"></a>        <span class="c1"># Check for deprecated algorithms</span>
<a id="__codelineno-31-43" name="__codelineno-31-43" href="#__codelineno-31-43"></a>        <span class="k">if</span> <span class="s1">&#39;sha1&#39;</span> <span class="ow">in</span> <span class="n">leaf_cert</span><span class="o">.</span><span class="n">signature_algorithm_oid</span><span class="o">.</span><span class="n">_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
<a id="__codelineno-31-44" name="__codelineno-31-44" href="#__codelineno-31-44"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">&quot;Deprecated signature algorithm: SHA-1&quot;</span><span class="p">)</span>
<a id="__codelineno-31-45" name="__codelineno-31-45" href="#__codelineno-31-45"></a>
<a id="__codelineno-31-46" name="__codelineno-31-46" href="#__codelineno-31-46"></a>        <span class="c1"># Verify certificate is in CT logs</span>
<a id="__codelineno-31-47" name="__codelineno-31-47" href="#__codelineno-31-47"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-31-48" name="__codelineno-31-48" href="#__codelineno-31-48"></a>            <span class="n">sct_ext</span> <span class="o">=</span> <span class="n">leaf_cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_oid</span><span class="p">(</span>
<a id="__codelineno-31-49" name="__codelineno-31-49" href="#__codelineno-31-49"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">ObjectIdentifier</span><span class="p">(</span><span class="s2">&quot;1.3.6.1.4.1.11129.2.4.2&quot;</span><span class="p">)</span>
<a id="__codelineno-31-50" name="__codelineno-31-50" href="#__codelineno-31-50"></a>            <span class="p">)</span>
<a id="__codelineno-31-51" name="__codelineno-31-51" href="#__codelineno-31-51"></a>            <span class="c1"># Has SCT extension - good</span>
<a id="__codelineno-31-52" name="__codelineno-31-52" href="#__codelineno-31-52"></a>        <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
<a id="__codelineno-31-53" name="__codelineno-31-53" href="#__codelineno-31-53"></a>            <span class="c1"># No CT - suspicious</span>
<a id="__codelineno-31-54" name="__codelineno-31-54" href="#__codelineno-31-54"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">&quot;Certificate not in CT logs&quot;</span><span class="p">)</span>
<a id="__codelineno-31-55" name="__codelineno-31-55" href="#__codelineno-31-55"></a>
<a id="__codelineno-31-56" name="__codelineno-31-56" href="#__codelineno-31-56"></a>        <span class="c1"># Check certificate lifetime</span>
<a id="__codelineno-31-57" name="__codelineno-31-57" href="#__codelineno-31-57"></a>        <span class="n">lifetime</span> <span class="o">=</span> <span class="p">(</span><span class="n">leaf_cert</span><span class="o">.</span><span class="n">not_valid_after_utc</span> <span class="o">-</span> 
<a id="__codelineno-31-58" name="__codelineno-31-58" href="#__codelineno-31-58"></a>                   <span class="n">leaf_cert</span><span class="o">.</span><span class="n">not_valid_before_utc</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
<a id="__codelineno-31-59" name="__codelineno-31-59" href="#__codelineno-31-59"></a>        <span class="k">if</span> <span class="n">lifetime</span> <span class="o">&gt;</span> <span class="mi">397</span><span class="p">:</span>  <span class="c1"># Max allowed by CA/Browser Forum</span>
<a id="__codelineno-31-60" name="__codelineno-31-60" href="#__codelineno-31-60"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Certificate lifetime too long: </span><span class="si">{</span><span class="n">lifetime</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="further-reading">Further Reading</h2>
<h3 id="standards-and-rfcs">Standards and RFCs</h3>
<ul>
<li>RFC 5280: X.509 Certificatesand CRLs</li>
<li>RFC 6960: OCSP</li>
<li>RFC 8659: CAA Records</li>
<li>CA/Browser Forum Baseline Requirements</li>
</ul>
<h3 id="security-resources">Security Resources</h3>
<ul>
<li>OWASP Certificate and Public Key Pinning Guide</li>
<li>CWE-295: Improper Certificate Validation</li>
<li>Common Weakness Enumeration (CWE) PKI entries</li>
</ul>
<h3 id="research-papers">Research Papers</h3>
<ul>
<li>"The Most Dangerous Code in the World" (2012)</li>
<li>"Analysis of SSL Certificate Reissues" (2016)</li>
<li>"Measuring and Analyzing the SSL Certificate Ecosystem" (2017)</li>
</ul>
<hr />
<p><strong>See Also</strong>: <a href="../certificate-pinning/">Certificate Pinning</a>, <a href="../private-key-protection/">Private Key Protection</a>, <a href="../../standards/tls-protocol/">Tls Protocol</a>, <a href="../../foundations/trust-models/">Trust Models</a></p>









  




                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/company/axonsecurity/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
  
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var sidebar = document.querySelector('.md-sidebar--secondary .md-sidebar__scrollwrap');
      if (sidebar) {
        var disclaimer = document.createElement('div');
        disclaimer.className = 'md-sidebar-disclaimer';
        disclaimer.innerHTML = `
          <div class="md-typeset">
            <div class="admonition tip">
              <p class="admonition-title">Our Books</p>
              <p><a href="https://axonshield.com/book"><strong>The Invisible Certificate Management Tax and How Automation Eliminates 94% of It</strong></a></p>
            </div>
            <div class="admonition warning">
              <p class="admonition-title">Disclaimer</p>
              <p><small>This documentation is based on "best practices". We've observed these ignore 
                unique organizational needs and often prove ineffective for long-term, sustainable 
                operations and ignore strategic advanteges of building infrastructure intelligence.</small></p>
            </div>
          </div>
        `;
        sidebar.insertBefore(disclaimer, sidebar.firstChild);
      }
    });
  </script>
  

  </body>
</html>