
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://vault.axonshield.com/implementation/certificate-issuance-workflows/">
      
      
        <link rel="prev" href="../ca-architecture/">
      
      
        <link rel="next" href="../hsm-integration/">
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Certificate Issuance Workflows - Shield Vault</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


    
    
    
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WJXPDRF2');</script>
  <!-- End Google Tag Manager -->
  
  <!-- Apollo Tracking -->
  <script>
    (function() {
      var apolloScript = document.createElement('script');
      apolloScript.type = 'text/javascript';
      apolloScript.async = true;
      apolloScript.src = 'https://cdn.apollo.io/v1/apollo.js';
      apolloScript.setAttribute('data-apollo-id', '68b8b91c5e883f0021f7f7aa');
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(apolloScript, s);
    })();
  </script>
  <!-- End Apollo Tracking -->

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#certificate-issuance-workflows" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Shield Vault" class="md-header__button md-logo" aria-label="Shield Vault" data-md-component="logo">
      
  <img src="../../assets/axon-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Shield Vault
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Certificate Issuance Workflows
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Why Certificate Management Matters

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../glossary/" class="md-tabs__link">
        
  
  
    
  
  Glossary

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../quick-start/" class="md-tabs__link">
        
  
  
    
  
  Quick Start Guide

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../technical-guide/" class="md-tabs__link">
        
  
  
    
  
  Foundations for Infrastructure Intelligence - Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../architecture/case-studies/" class="md-tabs__link">
          
  
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../business/cost_of_certificate_management/" class="md-tabs__link">
          
  
  
  Business

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../foundations/certificate-anatomy/" class="md-tabs__link">
          
  
  
  Foundations

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../acme-protocol-implementation/" class="md-tabs__link">
          
  
  
  Implementation

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../operations/certificate-lifecycle-management/" class="md-tabs__link">
          
  
  
  Operations

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../patterns/ca-hierarchies/" class="md-tabs__link">
          
  
  
  Patterns

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../security/ca-compromise-scenarios/" class="md-tabs__link">
          
  
  
  Security

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../standards/acme-protocol/" class="md-tabs__link">
          
  
  
  Standards

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../strategy/success-metrics/" class="md-tabs__link">
          
  
  
  Strategy

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../troubleshooting/chain-validation-errors/" class="md-tabs__link">
          
  
  
  Troubleshooting

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../vendors/digicert-certcentral/" class="md-tabs__link">
          
  
  
  Vendors

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Shield Vault" class="md-nav__button md-logo" aria-label="Shield Vault" data-md-component="logo">
      
  <img src="../../assets/axon-logo.png" alt="logo">

    </a>
    Shield Vault
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Why Certificate Management Matters
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Foundations for Infrastructure Intelligence - Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/case-studies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Case Studies - Certificate Management at Scale
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/certificate-as-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate-as-Code
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/mutual-tls-patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mutual TLS Patterns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/service-mesh-certificates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Service Mesh Certificates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/zero-trust-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Zero-Trust Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Business
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Business
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../business/cost_of_certificate_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The $67 Million Risk: Hidden Costs of Manual Certificate Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Foundations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Foundations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/certificate-anatomy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Anatomy
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/cryptographic-primitives/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cryptographic Primitives
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/public-private-key-pairs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Public-Private Key Pairs
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/trust-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trust Models
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/what-is-pki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    What is PKI?
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Implementation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Implementation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../acme-protocol-implementation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ACME Protocol Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ca-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CA Architecture
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Certificate Issuance Workflows
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Certificate Issuance Workflows
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tldr" class="md-nav__link">
    <span class="md-ellipsis">
      TL;DR
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Workflow Patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Workflow Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manual-workflow-traditional" class="md-nav__link">
    <span class="md-ellipsis">
      Manual Workflow (Traditional)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semi-automated-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Semi-Automated Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fully-automated-workflow-modern" class="md-nav__link">
    <span class="md-ellipsis">
      Fully Automated Workflow (Modern)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Request Validation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Request Validation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#domain-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Domain Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identity-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Identity Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authorization-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Authorization Validation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Generation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Certificate Generation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#certificate-signing-request-csr-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Signing Request (CSR) Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#profile-application" class="md-nav__link">
    <span class="md-ellipsis">
      Profile Application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#template-based-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Template-Based Generation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-distribution" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Distribution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Certificate Distribution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#push-vs-pull-models" class="md-nav__link">
    <span class="md-ellipsis">
      Push vs Pull Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secrets-management-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Secrets Management Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automation-protocols" class="md-nav__link">
    <span class="md-ellipsis">
      Automation Protocols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Automation Protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#acme-automated-certificate-management-environment" class="md-nav__link">
    <span class="md-ellipsis">
      ACME (Automated Certificate Management Environment)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scep-simple-certificate-enrollment-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      SCEP (Simple Certificate Enrollment Protocol)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#est-enrollment-over-secure-transport" class="md-nav__link">
    <span class="md-ellipsis">
      EST (Enrollment over Secure Transport)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cmc-certificate-management-over-cms" class="md-nav__link">
    <span class="md-ellipsis">
      CMC (Certificate Management over CMS)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-management-systems" class="md-nav__link">
    <span class="md-ellipsis">
      Workflow Management Systems
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Workflow Management Systems">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#approval-workflows" class="md-nav__link">
    <span class="md-ellipsis">
      Approval Workflows
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-with-itsm-systems" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with ITSM Systems
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#audit-and-compliance" class="md-nav__link">
    <span class="md-ellipsis">
      Audit and Compliance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Audit and Compliance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#complete-audit-trails" class="md-nav__link">
    <span class="md-ellipsis">
      Complete Audit Trails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compliance-reporting" class="md-nav__link">
    <span class="md-ellipsis">
      Compliance Reporting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling and Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling and Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#request-validation-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Request Validation Errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-logic" class="md-nav__link">
    <span class="md-ellipsis">
      Retry Logic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#batch-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Batch Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caching-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Caching Strategies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      Common Pitfalls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Pitfalls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#weak-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Weak Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#missing-audit-trails" class="md-nav__link">
    <span class="md-ellipsis">
      Missing Audit Trails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-bottlenecks" class="md-nav__link">
    <span class="md-ellipsis">
      Manual Bottlenecks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insufficient-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Insufficient Error Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poor-key-management" class="md-nav__link">
    <span class="md-ellipsis">
      Poor Key Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inconsistent-policy-enforcement" class="md-nav__link">
    <span class="md-ellipsis">
      Inconsistent Policy Enforcement
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Security Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#request-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Request Authentication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domain-validation-security" class="md-nav__link">
    <span class="md-ellipsis">
      Domain Validation Security
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#private-key-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Private Key Protection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#approval-bypass-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      Approval Bypass Prevention
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#real-world-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Real-World Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real-World Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#google-certificate-automation" class="md-nav__link">
    <span class="md-ellipsis">
      Google Certificate Automation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#financial-services-manual-to-automated" class="md-nav__link">
    <span class="md-ellipsis">
      Financial Services Manual to Automated
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloud-provider-instant-issuance" class="md-nav__link">
    <span class="md-ellipsis">
      Cloud Provider Instant Issuance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      Further Reading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Further Reading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#standards-and-rfcs" class="md-nav__link">
    <span class="md-ellipsis">
      Standards and RFCs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#related-pages" class="md-nav__link">
    <span class="md-ellipsis">
      Related Pages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#industry-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Industry Resources
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hsm-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HSM Integration
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-cloud-pki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Cloud PKI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/certificate-lifecycle-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Lifecycle Management
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/certificate-rotation-strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Rotation Strategies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/inventory-and-discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inventory and Discovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/monitoring-and-alerting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Monitoring and Alerting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/renewal-automation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Renewal Automation
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Patterns
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/ca-hierarchies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CA Hierarchies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/cloud-vs-on-premises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cloud vs On-Premises
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/high-availability-disaster-recovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    High Availability and Disaster Recovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/multi-tenancy-considerations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Tenancy Considerations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Security
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/ca-compromise-scenarios/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CA Compromise Scenarios
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/certificate-pinning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Pinning
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/common-vulnerabilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common Vulnerabilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/compliance-and-audit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compliance and Audit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/incident-response/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Incident Response
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/key-management-best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Key Management Best Practices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/private-key-protection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Private Key Protection
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/threat-models-and-attack-vectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Threat Models and Attack Vectors
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Standards
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            Standards
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/acme-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ACME Protocol
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/ocsp-and-crl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OCSP and CRL
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/pkcs-standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PKCS Standards
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/tls-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TLS Protocol
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/x509-standard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    X.509 Standard
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Strategy
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Strategy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategy/success-metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Success Metrics and KPIs for Certificate Automation
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            Troubleshooting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/chain-validation-errors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chain Validation Errors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/common-misconfigurations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common Misconfigurations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/expired-certificate-outages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Expired Certificate Outages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/performance-bottlenecks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Performance Bottlenecks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Vendors
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            Vendors
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/digicert-certcentral/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DigiCert CertCentral
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/hashicorp-vault-pki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HashiCorp Vault PKI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/keyfactor-command/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Keyfactor Command
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/venafi-platform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Venafi Platform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/vendor-comparison-matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vendor Comparison Matrix
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tldr" class="md-nav__link">
    <span class="md-ellipsis">
      TL;DR
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Workflow Patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Workflow Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manual-workflow-traditional" class="md-nav__link">
    <span class="md-ellipsis">
      Manual Workflow (Traditional)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semi-automated-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Semi-Automated Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fully-automated-workflow-modern" class="md-nav__link">
    <span class="md-ellipsis">
      Fully Automated Workflow (Modern)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Request Validation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Request Validation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#domain-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Domain Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identity-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Identity Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authorization-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Authorization Validation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Generation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Certificate Generation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#certificate-signing-request-csr-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Signing Request (CSR) Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#profile-application" class="md-nav__link">
    <span class="md-ellipsis">
      Profile Application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#template-based-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Template-Based Generation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-distribution" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Distribution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Certificate Distribution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#push-vs-pull-models" class="md-nav__link">
    <span class="md-ellipsis">
      Push vs Pull Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secrets-management-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Secrets Management Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automation-protocols" class="md-nav__link">
    <span class="md-ellipsis">
      Automation Protocols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Automation Protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#acme-automated-certificate-management-environment" class="md-nav__link">
    <span class="md-ellipsis">
      ACME (Automated Certificate Management Environment)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scep-simple-certificate-enrollment-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      SCEP (Simple Certificate Enrollment Protocol)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#est-enrollment-over-secure-transport" class="md-nav__link">
    <span class="md-ellipsis">
      EST (Enrollment over Secure Transport)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cmc-certificate-management-over-cms" class="md-nav__link">
    <span class="md-ellipsis">
      CMC (Certificate Management over CMS)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-management-systems" class="md-nav__link">
    <span class="md-ellipsis">
      Workflow Management Systems
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Workflow Management Systems">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#approval-workflows" class="md-nav__link">
    <span class="md-ellipsis">
      Approval Workflows
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-with-itsm-systems" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with ITSM Systems
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#audit-and-compliance" class="md-nav__link">
    <span class="md-ellipsis">
      Audit and Compliance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Audit and Compliance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#complete-audit-trails" class="md-nav__link">
    <span class="md-ellipsis">
      Complete Audit Trails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compliance-reporting" class="md-nav__link">
    <span class="md-ellipsis">
      Compliance Reporting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling and Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling and Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#request-validation-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Request Validation Errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-logic" class="md-nav__link">
    <span class="md-ellipsis">
      Retry Logic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#batch-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Batch Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caching-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Caching Strategies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      Common Pitfalls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Pitfalls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#weak-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Weak Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#missing-audit-trails" class="md-nav__link">
    <span class="md-ellipsis">
      Missing Audit Trails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-bottlenecks" class="md-nav__link">
    <span class="md-ellipsis">
      Manual Bottlenecks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insufficient-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Insufficient Error Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poor-key-management" class="md-nav__link">
    <span class="md-ellipsis">
      Poor Key Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inconsistent-policy-enforcement" class="md-nav__link">
    <span class="md-ellipsis">
      Inconsistent Policy Enforcement
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Security Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#request-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Request Authentication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domain-validation-security" class="md-nav__link">
    <span class="md-ellipsis">
      Domain Validation Security
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#private-key-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Private Key Protection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#approval-bypass-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      Approval Bypass Prevention
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#real-world-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Real-World Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real-World Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#google-certificate-automation" class="md-nav__link">
    <span class="md-ellipsis">
      Google Certificate Automation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#financial-services-manual-to-automated" class="md-nav__link">
    <span class="md-ellipsis">
      Financial Services Manual to Automated
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloud-provider-instant-issuance" class="md-nav__link">
    <span class="md-ellipsis">
      Cloud Provider Instant Issuance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      Further Reading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Further Reading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#standards-and-rfcs" class="md-nav__link">
    <span class="md-ellipsis">
      Standards and RFCs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#related-pages" class="md-nav__link">
    <span class="md-ellipsis">
      Related Pages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#industry-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Industry Resources
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WJXPDRF2"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <!-- Right sidebar with disclaimer above TOC -->
  
    <style>
      @media screen and (min-width: 76.25em) {
        .md-sidebar--secondary {
          order: 1;
        }
        .md-sidebar--secondary::before {
          content: '';
          display: block;
          margin-bottom: 1rem;
        }
      }
    </style>
  
  
  
                  



<h1 id="certificate-issuance-workflows">Certificate Issuance Workflows</h1>
<h2 id="tldr">TL;DR</h2>
<p>Certificate issuance is the core operational process of any PKI, transforming certificate requests into signed certificates through validation, generation, and distribution workflows. Modern issuance systems must balance security (strong validation, audit trails) with operational efficiency (automation, self-service), while supporting multiple protocols (ACME, SCEP, EST) and integration patterns. Organizations typically evolve from manual, ad-hoc processes to systematic, automated workflows with policy enforcement, eventually reaching fully integrated infrastructure-as-code approaches. The key challenge is building workflows that are simultaneously secure enough to meet compliance requirements, automated enough to handle scale, and flexible enough to support diverse use cases from IoT devices to load balancers to developer workstations.</p>
<p><strong>Key Insight</strong>: The maturity of your certificate issuance workflow directly correlates with your security posture and operational efficiency. Manual processes create security gaps and operational bottlenecks, while well-designed automated workflows enforce policy consistently, provide complete audit trails, and enable infrastructure-as-code approaches.</p>
<hr />
<h2 id="overview">Overview</h2>
<p>Certificate issuance workflows encompass the entire process from initial request through final certificate delivery and installation. In enterprise environments, these workflows must handle thousands or millions of certificates across diverse use cases while maintaining security, compliance, and operational efficiency.</p>
<p><strong>Core Workflow Stages</strong>:</p>
<ol>
<li><strong>Request Initiation</strong> - Certificate request generated with required identifiers</li>
<li><strong>Identity Validation</strong> - Verifying requester authorization and identifier ownership</li>
<li><strong>Policy Enforcement</strong> - Applying organizational rules and compliance requirements</li>
<li><strong>Certificate Generation</strong> - Creating and signing the certificate</li>
<li><strong>Distribution</strong> - Delivering certificate to target systems</li>
<li><strong>Installation</strong> - Deploying certificate into service</li>
<li><strong>Verification</strong> - Confirming proper operation</li>
<li><strong>Audit Logging</strong> - Recording all actions for compliance</li>
</ol>
<p>Modern certificate workflows must support both traditional request/approval patterns and fully automated, policy-driven issuance while maintaining appropriate security controls for each use case.</p>
<hr />
<h2 id="workflow-patterns">Workflow Patterns</h2>
<h3 id="manual-workflow-traditional">Manual Workflow (Traditional)</h3>
<p>The traditional approach used in many enterprises, characterized by human intervention at multiple stages:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Request  Email Approval  Manual Validation  Manual Generation  
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>Email Delivery  Manual Installation  Manual Verification
</code></pre></div>
<p><strong>Characteristics</strong>:</p>
<ul>
<li>High touch, multiple handoffs between teams</li>
<li>Days to weeks for certificate issuance</li>
<li>Prone to errors and omissions</li>
<li>Limited audit trail</li>
<li>Does not scale beyond hundreds of certificates</li>
<li>Often bypassed through "shadow IT" channels</li>
</ul>
<p><strong>When Appropriate</strong>:</p>
<ul>
<li>High-value certificates (root CAs, signing certificates)</li>
<li>External-facing certificates requiring extensive validation</li>
<li>Initial PKI standup with limited automation</li>
<li>Organizations under 500 total certificates</li>
</ul>
<h3 id="semi-automated-workflow">Semi-Automated Workflow</h3>
<p>Hybrid approach combining automated technical operations with manual approval gates:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>API Request  Policy Check  Approval Queue  
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>Auto-Generation  Auto-Distribution  Manual Installation  Auto-Verification
</code></pre></div>
<p><strong>Characteristics</strong>:</p>
<ul>
<li>Automated technical operations</li>
<li>Human approval for policy decisions</li>
<li>Hours to days for issuance</li>
<li>Better audit trails</li>
<li>Scales to thousands of certificates</li>
<li>Balances security and efficiency</li>
</ul>
<p><strong>When Appropriate</strong>:</p>
<ul>
<li>Organizations transitioning to automation</li>
<li>Certificates requiring business approval</li>
<li>Mixed environment with varying risk levels</li>
<li>Compliance requirements mandate human oversight</li>
</ul>
<h3 id="fully-automated-workflow-modern">Fully Automated Workflow (Modern)</h3>
<p>Policy-driven automation with no manual intervention:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>API Request  Policy Engine  Auto-Validation  Auto-Generation  
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>Auto-Distribution  Auto-Installation  Auto-Verification  Audit Log
</code></pre></div>
<p><strong>Characteristics</strong>:</p>
<ul>
<li>Minutes to seconds for issuance</li>
<li>Policy-driven decisions</li>
<li>Complete audit automation</li>
<li>Scales to millions of certificates</li>
<li>Infrastructure-as-code compatible</li>
<li>Requires robust policy framework</li>
</ul>
<p><strong>When Appropriate</strong>:</p>
<ul>
<li>Cloud-native environments</li>
<li>Container and microservices architectures</li>
<li>Short-lived certificate strategies</li>
<li>DevOps/GitOps workflows</li>
<li>High-volume environments</li>
</ul>
<hr />
<h2 id="request-validation">Request Validation</h2>
<p>Request validation is the critical security control that prevents unauthorized certificate issuance. Modern validation combines multiple verification methods.</p>
<h3 id="domain-validation">Domain Validation</h3>
<p>Verifying control of DNS names included in certificates:</p>
<p><strong>DNS Challenge (Preferred)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Validator generates unique token</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nv">TOKEN</span><span class="o">=</span><span class="s2">&quot;abc123def456&quot;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1"># Requester creates DNS record</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>_acme-challenge.example.com.<span class="w"> </span>IN<span class="w"> </span>TXT<span class="w"> </span><span class="s2">&quot;abc123def456&quot;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="c1"># Validator queries DNS</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>dig<span class="w"> </span>TXT<span class="w"> </span>_acme-challenge.example.com<span class="w"> </span>@8.8.8.8<span class="w"> </span>+short
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="c1"># Returns: &quot;abc123def456&quot;</span>
</code></pre></div></p>
<p><strong>HTTP Challenge</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Requester hosts file at specific path</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>curl<span class="w"> </span>http://example.com/.well-known/acme-challenge/TOKEN
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="c1"># Returns: TOKEN.ACCOUNT_THUMBPRINT</span>
</code></pre></div></p>
<p><strong>TLS-ALPN Challenge</strong> (For systems that only accept TLS):
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Requester presents special certificate with token</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>example.com:443<span class="w"> </span>-alpn<span class="w"> </span>acme-tls/1
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="c1"># Certificate contains validation token in extension</span>
</code></pre></div></p>
<h3 id="identity-validation">Identity Validation</h3>
<p>Verifying the requester is authorized to receive certificates:</p>
<p><strong>API Key Authentication</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="s1">&#39;X-API-Key&#39;</span><span class="p">:</span> <span class="s1">&#39;your-api-key&#39;</span><span class="p">,</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="p">}</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="n">csr</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;-----BEGIN CERTIFICATE REQUEST-----</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="s2">MIICvDCCAaQCAQAwdzELMAkGA1UEBhMCVVMx...</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="s2">-----END CERTIFICATE REQUEST-----&quot;&quot;&quot;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>    <span class="s1">&#39;https://ca.example.com/api/v1/certificates&#39;</span><span class="p">,</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;csr&#39;</span><span class="p">:</span> <span class="n">csr</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="s1">&#39;webserver&#39;</span><span class="p">}</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="p">)</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>    <span class="n">cert</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;certificate&#39;</span><span class="p">]</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Certificate issued: </span><span class="si">{</span><span class="n">cert</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Mutual TLS (mTLS) Authentication</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="c1"># Client presents certificate for authentication</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">cert</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;/path/to/client-cert.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;/path/to/client-key.pem&#39;</span><span class="p">)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="s1">&#39;https://ca.example.com/api/v1/certificates&#39;</span><span class="p">,</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    <span class="n">cert</span><span class="o">=</span><span class="n">cert</span><span class="p">,</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;csr&#39;</span><span class="p">:</span> <span class="n">csr_text</span><span class="p">}</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>OAuth 2.0 / OIDC Integration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">requests_oauthlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">OAuth2Session</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">client_id</span> <span class="o">=</span> <span class="s1">&#39;your-client-id&#39;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">token_url</span> <span class="o">=</span> <span class="s1">&#39;https://auth.example.com/oauth/token&#39;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="n">oauth</span> <span class="o">=</span> <span class="n">OAuth2Session</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="n">token</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">fetch_token</span><span class="p">(</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    <span class="n">token_url</span><span class="p">,</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="n">client_secret</span><span class="o">=</span><span class="s1">&#39;your-secret&#39;</span><span class="p">,</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="n">grant_type</span><span class="o">=</span><span class="s1">&#39;client_credentials&#39;</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="p">)</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="s1">&#39;https://ca.example.com/api/v1/certificates&#39;</span><span class="p">,</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;csr&#39;</span><span class="p">:</span> <span class="n">csr_text</span><span class="p">}</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="p">)</span>
</code></pre></div></p>
<h3 id="authorization-validation">Authorization Validation</h3>
<p>Verifying the authenticated party is authorized for specific certificate types:</p>
<p><strong>Role-Based Access Control (RBAC)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Policy definition</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nt">policies</span><span class="p">:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">  </span><span class="nt">webserver_issuer</span><span class="p">:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web_admin</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">devops_engineer</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="nt">allowed_profiles</span><span class="p">:</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls_server</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span><span class="nt">allowed_sans</span><span class="p">:</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;*.example.com&quot;</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;*.prod.example.com&quot;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="nt">max_validity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90d</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">  </span><span class="nt">code_signing_issuer</span><span class="p">:</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">    </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">release_manager</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">    </span><span class="nt">allowed_profiles</span><span class="p">:</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_signing</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">    </span><span class="nt">max_validity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">365d</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">    </span><span class="nt">require_approval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div></p>
<p><strong>Attribute-Based Access Control (ABAC)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CertificatePolicy</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">can_issue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requester</span><span class="p">,</span> <span class="n">certificate_request</span><span class="p">):</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate policy using requester and request attributes&quot;&quot;&quot;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>        <span class="c1"># Check domain ownership</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_domain_ownership</span><span class="p">(</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>            <span class="n">requester</span><span class="o">.</span><span class="n">owned_domains</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>            <span class="n">certificate_request</span><span class="o">.</span><span class="n">sans</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        <span class="p">):</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Requester doesn&#39;t own requested domains&quot;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="c1"># Check organizational unit</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>        <span class="k">if</span> <span class="n">certificate_request</span><span class="o">.</span><span class="n">ou</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">requester</span><span class="o">.</span><span class="n">authorized_ous</span><span class="p">:</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Not authorized for this OU&quot;</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>        <span class="c1"># Check key size</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>        <span class="k">if</span> <span class="n">certificate_request</span><span class="o">.</span><span class="n">key_size</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">:</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Key size too small&quot;</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>        <span class="c1"># Check validity period</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>        <span class="k">if</span> <span class="n">certificate_request</span><span class="o">.</span><span class="n">validity_days</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">requester</span><span class="o">.</span><span class="n">has_role</span><span class="p">(</span><span class="s1">&#39;senior_admin&#39;</span><span class="p">):</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Validity exceeds limit for role&quot;</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Authorized&quot;</span>
</code></pre></div></p>
<hr />
<h2 id="certificate-generation">Certificate Generation</h2>
<h3 id="certificate-signing-request-csr-processing">Certificate Signing Request (CSR) Processing</h3>
<p>Extracting and validating information from CSRs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography</span><span class="w"> </span><span class="kn">import</span> <span class="n">x509</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.backends</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_backend</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">Encoding</span><span class="p">,</span> <span class="n">PublicFormat</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_csr</span><span class="p">(</span><span class="n">csr_pem</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse and validate CSR&quot;&quot;&quot;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="n">csr</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_pem_x509_csr</span><span class="p">(</span><span class="n">csr_pem</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">default_backend</span><span class="p">())</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="c1"># Extract subject information</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">subject</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="n">attr</span><span class="o">.</span><span class="n">oid</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">value</span> 
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">csr</span><span class="o">.</span><span class="n">subject</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="p">}</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="c1"># Extract SANs</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>    <span class="n">sans</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>        <span class="n">san_ext</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>            <span class="n">x509</span><span class="o">.</span><span class="n">SubjectAlternativeName</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>        <span class="p">)</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>        <span class="n">sans</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">san_ext</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>    <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>        <span class="k">pass</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>    <span class="c1"># Verify signature</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">csr</span><span class="o">.</span><span class="n">is_signature_valid</span><span class="p">:</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CSR signature invalid&quot;</span><span class="p">)</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>    <span class="c1"># Check key size</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>    <span class="n">public_key</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>    <span class="n">key_size</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">key_size</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>    <span class="k">if</span> <span class="n">key_size</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">:</span>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key size </span><span class="si">{</span><span class="n">key_size</span><span class="si">}</span><span class="s2"> too small&quot;</span><span class="p">)</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>        <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>        <span class="s1">&#39;sans&#39;</span><span class="p">:</span> <span class="n">sans</span><span class="p">,</span>
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>        <span class="s1">&#39;public_key&#39;</span><span class="p">:</span> <span class="n">public_key</span><span class="p">,</span>
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>        <span class="s1">&#39;key_size&#39;</span><span class="p">:</span> <span class="n">key_size</span>
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>    <span class="p">}</span>
</code></pre></div>
<h3 id="profile-application">Profile Application</h3>
<p>Applying certificate profiles to enforce organizational standards:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography</span><span class="w"> </span><span class="kn">import</span> <span class="n">x509</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.x509.oid</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExtensionOID</span><span class="p">,</span> <span class="n">ExtendedKeyUsageOID</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">CertificateProfile</span><span class="p">:</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;TLS Server Certificate Profile&quot;&quot;&quot;</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validity_days</span> <span class="o">=</span> <span class="mi">90</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">key_usage</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>            <span class="s1">&#39;digital_signature&#39;</span><span class="p">,</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>            <span class="s1">&#39;key_encipherment&#39;</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>        <span class="p">]</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">extended_key_usage</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>            <span class="n">ExtendedKeyUsageOID</span><span class="o">.</span><span class="n">SERVER_AUTH</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        <span class="p">]</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">must_staple</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csr</span><span class="p">,</span> <span class="n">issuer_key</span><span class="p">,</span> <span class="n">issuer_cert</span><span class="p">):</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate certificate from CSR using profile&quot;&quot;&quot;</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        <span class="n">subject</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">subject</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>        <span class="n">public_key</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>        <span class="c1"># Build certificate</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">CertificateBuilder</span><span class="p">()</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">subject_name</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">issuer_name</span><span class="p">(</span><span class="n">issuer_cert</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">public_key</span><span class="p">)</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">serial_number</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">random_serial_number</span><span class="p">())</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">not_valid_before</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">not_valid_after</span><span class="p">(</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>            <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity_days</span><span class="p">)</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>        <span class="p">)</span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>        <span class="c1"># Add Subject Alternative Names from CSR</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>            <span class="n">san_ext</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">SubjectAlternativeName</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>            <span class="p">)</span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>            <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>                <span class="n">san_ext</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>                <span class="n">critical</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>            <span class="p">)</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>        <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>            <span class="k">pass</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>        <span class="c1"># Add Key Usage</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>            <span class="n">x509</span><span class="o">.</span><span class="n">KeyUsage</span><span class="p">(</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>                <span class="n">digital_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>                <span class="n">key_encipherment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>                <span class="n">content_commitment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>                <span class="n">data_encipherment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>                <span class="n">key_agreement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>                <span class="n">key_cert_sign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>                <span class="n">crl_sign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>                <span class="n">encipher_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>                <span class="n">decipher_only</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>            <span class="p">),</span>
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>            <span class="n">critical</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a>        <span class="p">)</span>
<a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a>
<a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a>        <span class="c1"># Add Extended Key Usage</span>
<a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
<a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a>            <span class="n">x509</span><span class="o">.</span><span class="n">ExtendedKeyUsage</span><span class="p">([</span>
<a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a>                <span class="n">ExtendedKeyUsageOID</span><span class="o">.</span><span class="n">SERVER_AUTH</span>
<a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a>            <span class="p">]),</span>
<a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a>            <span class="n">critical</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a>        <span class="p">)</span>
<a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a>
<a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a>        <span class="c1"># Add OCSP Must-Staple</span>
<a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_staple</span><span class="p">:</span>
<a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a>            <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
<a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">TLSFeature</span><span class="p">([</span><span class="n">x509</span><span class="o">.</span><span class="n">TLSFeatureType</span><span class="o">.</span><span class="n">status_request</span><span class="p">]),</span>
<a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a>                <span class="n">critical</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a>            <span class="p">)</span>
<a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a>
<a id="__codelineno-12-79" name="__codelineno-12-79" href="#__codelineno-12-79"></a>        <span class="c1"># Add Authority Key Identifier</span>
<a id="__codelineno-12-80" name="__codelineno-12-80" href="#__codelineno-12-80"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
<a id="__codelineno-12-81" name="__codelineno-12-81" href="#__codelineno-12-81"></a>            <span class="n">x509</span><span class="o">.</span><span class="n">AuthorityKeyIdentifier</span><span class="o">.</span><span class="n">from_issuer_public_key</span><span class="p">(</span>
<a id="__codelineno-12-82" name="__codelineno-12-82" href="#__codelineno-12-82"></a>                <span class="n">issuer_cert</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
<a id="__codelineno-12-83" name="__codelineno-12-83" href="#__codelineno-12-83"></a>            <span class="p">),</span>
<a id="__codelineno-12-84" name="__codelineno-12-84" href="#__codelineno-12-84"></a>            <span class="n">critical</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-12-85" name="__codelineno-12-85" href="#__codelineno-12-85"></a>        <span class="p">)</span>
<a id="__codelineno-12-86" name="__codelineno-12-86" href="#__codelineno-12-86"></a>
<a id="__codelineno-12-87" name="__codelineno-12-87" href="#__codelineno-12-87"></a>        <span class="c1"># Add Subject Key Identifier</span>
<a id="__codelineno-12-88" name="__codelineno-12-88" href="#__codelineno-12-88"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
<a id="__codelineno-12-89" name="__codelineno-12-89" href="#__codelineno-12-89"></a>            <span class="n">x509</span><span class="o">.</span><span class="n">SubjectKeyIdentifier</span><span class="o">.</span><span class="n">from_public_key</span><span class="p">(</span><span class="n">public_key</span><span class="p">),</span>
<a id="__codelineno-12-90" name="__codelineno-12-90" href="#__codelineno-12-90"></a>            <span class="n">critical</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-12-91" name="__codelineno-12-91" href="#__codelineno-12-91"></a>        <span class="p">)</span>
<a id="__codelineno-12-92" name="__codelineno-12-92" href="#__codelineno-12-92"></a>
<a id="__codelineno-12-93" name="__codelineno-12-93" href="#__codelineno-12-93"></a>        <span class="c1"># Add Authority Information Access (OCSP + CA Issuers)</span>
<a id="__codelineno-12-94" name="__codelineno-12-94" href="#__codelineno-12-94"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
<a id="__codelineno-12-95" name="__codelineno-12-95" href="#__codelineno-12-95"></a>            <span class="n">x509</span><span class="o">.</span><span class="n">AuthorityInformationAccess</span><span class="p">([</span>
<a id="__codelineno-12-96" name="__codelineno-12-96" href="#__codelineno-12-96"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">AccessDescription</span><span class="p">(</span>
<a id="__codelineno-12-97" name="__codelineno-12-97" href="#__codelineno-12-97"></a>                    <span class="n">x509</span><span class="o">.</span><span class="n">OID_OCSP</span><span class="p">,</span>
<a id="__codelineno-12-98" name="__codelineno-12-98" href="#__codelineno-12-98"></a>                    <span class="n">x509</span><span class="o">.</span><span class="n">UniformResourceIdentifier</span><span class="p">(</span><span class="s1">&#39;http://ocsp.example.com&#39;</span><span class="p">)</span>
<a id="__codelineno-12-99" name="__codelineno-12-99" href="#__codelineno-12-99"></a>                <span class="p">),</span>
<a id="__codelineno-12-100" name="__codelineno-12-100" href="#__codelineno-12-100"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">AccessDescription</span><span class="p">(</span>
<a id="__codelineno-12-101" name="__codelineno-12-101" href="#__codelineno-12-101"></a>                    <span class="n">x509</span><span class="o">.</span><span class="n">OID_CA_ISSUERS</span><span class="p">,</span>
<a id="__codelineno-12-102" name="__codelineno-12-102" href="#__codelineno-12-102"></a>                    <span class="n">x509</span><span class="o">.</span><span class="n">UniformResourceIdentifier</span><span class="p">(</span><span class="s1">&#39;http://ca.example.com/issuer.crt&#39;</span><span class="p">)</span>
<a id="__codelineno-12-103" name="__codelineno-12-103" href="#__codelineno-12-103"></a>                <span class="p">)</span>
<a id="__codelineno-12-104" name="__codelineno-12-104" href="#__codelineno-12-104"></a>            <span class="p">]),</span>
<a id="__codelineno-12-105" name="__codelineno-12-105" href="#__codelineno-12-105"></a>            <span class="n">critical</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-12-106" name="__codelineno-12-106" href="#__codelineno-12-106"></a>        <span class="p">)</span>
<a id="__codelineno-12-107" name="__codelineno-12-107" href="#__codelineno-12-107"></a>
<a id="__codelineno-12-108" name="__codelineno-12-108" href="#__codelineno-12-108"></a>        <span class="c1"># Add CRL Distribution Points</span>
<a id="__codelineno-12-109" name="__codelineno-12-109" href="#__codelineno-12-109"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
<a id="__codelineno-12-110" name="__codelineno-12-110" href="#__codelineno-12-110"></a>            <span class="n">x509</span><span class="o">.</span><span class="n">CRLDistributionPoints</span><span class="p">([</span>
<a id="__codelineno-12-111" name="__codelineno-12-111" href="#__codelineno-12-111"></a>                <span class="n">x509</span><span class="o">.</span><span class="n">DistributionPoint</span><span class="p">(</span>
<a id="__codelineno-12-112" name="__codelineno-12-112" href="#__codelineno-12-112"></a>                    <span class="n">full_name</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-12-113" name="__codelineno-12-113" href="#__codelineno-12-113"></a>                        <span class="n">x509</span><span class="o">.</span><span class="n">UniformResourceIdentifier</span><span class="p">(</span><span class="s1">&#39;http://crl.example.com/ca.crl&#39;</span><span class="p">)</span>
<a id="__codelineno-12-114" name="__codelineno-12-114" href="#__codelineno-12-114"></a>                    <span class="p">],</span>
<a id="__codelineno-12-115" name="__codelineno-12-115" href="#__codelineno-12-115"></a>                    <span class="n">relative_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-12-116" name="__codelineno-12-116" href="#__codelineno-12-116"></a>                    <span class="n">crl_issuer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-12-117" name="__codelineno-12-117" href="#__codelineno-12-117"></a>                    <span class="n">reasons</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-12-118" name="__codelineno-12-118" href="#__codelineno-12-118"></a>                <span class="p">)</span>
<a id="__codelineno-12-119" name="__codelineno-12-119" href="#__codelineno-12-119"></a>            <span class="p">]),</span>
<a id="__codelineno-12-120" name="__codelineno-12-120" href="#__codelineno-12-120"></a>            <span class="n">critical</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-12-121" name="__codelineno-12-121" href="#__codelineno-12-121"></a>        <span class="p">)</span>
<a id="__codelineno-12-122" name="__codelineno-12-122" href="#__codelineno-12-122"></a>
<a id="__codelineno-12-123" name="__codelineno-12-123" href="#__codelineno-12-123"></a>        <span class="c1"># Sign certificate</span>
<a id="__codelineno-12-124" name="__codelineno-12-124" href="#__codelineno-12-124"></a>        <span class="n">certificate</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span>
<a id="__codelineno-12-125" name="__codelineno-12-125" href="#__codelineno-12-125"></a>            <span class="n">private_key</span><span class="o">=</span><span class="n">issuer_key</span><span class="p">,</span>
<a id="__codelineno-12-126" name="__codelineno-12-126" href="#__codelineno-12-126"></a>            <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
<a id="__codelineno-12-127" name="__codelineno-12-127" href="#__codelineno-12-127"></a>            <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">()</span>
<a id="__codelineno-12-128" name="__codelineno-12-128" href="#__codelineno-12-128"></a>        <span class="p">)</span>
<a id="__codelineno-12-129" name="__codelineno-12-129" href="#__codelineno-12-129"></a>
<a id="__codelineno-12-130" name="__codelineno-12-130" href="#__codelineno-12-130"></a>        <span class="k">return</span> <span class="n">certificate</span>
</code></pre></div>
<h3 id="template-based-generation">Template-Based Generation</h3>
<p>Using certificate templates for common patterns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># templates.yaml</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nt">templates</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span><span class="nt">webserver</span><span class="p">:</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="nt">validity_days</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="nt">key_usage</span><span class="p">:</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">digital_signature</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">key_encipherment</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="nt">extended_key_usage</span><span class="p">:</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">serverAuth</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="nt">must_staple</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="nt">subject_pattern</span><span class="p">:</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">      </span><span class="nt">O</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Example</span><span class="nv"> </span><span class="s">Corp&quot;</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">      </span><span class="nt">OU</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Web</span><span class="nv"> </span><span class="s">Services&quot;</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">      </span><span class="nt">C</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;US&quot;</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">  </span><span class="nt">client_auth</span><span class="p">:</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="nt">validity_days</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">365</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">    </span><span class="nt">key_usage</span><span class="p">:</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">digital_signature</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">    </span><span class="nt">extended_key_usage</span><span class="p">:</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clientAuth</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">    </span><span class="nt">subject_pattern</span><span class="p">:</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">      </span><span class="nt">O</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Example</span><span class="nv"> </span><span class="s">Corp&quot;</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">      </span><span class="nt">OU</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Employees&quot;</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">      </span><span class="nt">C</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;US&quot;</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">  </span><span class="nt">code_signing</span><span class="p">:</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">    </span><span class="nt">validity_days</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1095</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="w">    </span><span class="nt">key_usage</span><span class="p">:</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">digital_signature</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a><span class="w">    </span><span class="nt">extended_key_usage</span><span class="p">:</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codeSigning</span>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="w">    </span><span class="nt">subject_pattern</span><span class="p">:</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a><span class="w">      </span><span class="nt">O</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Example</span><span class="nv"> </span><span class="s">Corp&quot;</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a><span class="w">      </span><span class="nt">OU</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Engineering&quot;</span>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a><span class="w">      </span><span class="nt">C</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;US&quot;</span>
</code></pre></div>
<hr />
<h2 id="certificate-distribution">Certificate Distribution</h2>
<h3 id="push-vs-pull-models">Push vs Pull Models</h3>
<p><strong>Push Model</strong> - CA delivers certificates to endpoints:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">paramiko</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">deploy_certificate</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">cert_pem</span><span class="p">,</span> <span class="n">key_pem</span><span class="p">):</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Deploy certificate to remote server&quot;&quot;&quot;</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="n">ssh</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;deploy-user&#39;</span><span class="p">,</span> <span class="n">key_filename</span><span class="o">=</span><span class="s1">&#39;/path/to/key&#39;</span><span class="p">)</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    <span class="n">sftp</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="c1"># Write certificate</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="k">with</span> <span class="n">sftp</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/etc/ssl/certs/server.crt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_pem</span><span class="p">)</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>    <span class="c1"># Write private key (with restricted permissions)</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>    <span class="k">with</span> <span class="n">sftp</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/etc/ssl/private/server.key&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">key_pem</span><span class="p">)</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>    <span class="n">sftp</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s1">&#39;/etc/ssl/private/server.key&#39;</span><span class="p">,</span> <span class="mo">0o600</span><span class="p">)</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>    <span class="c1"># Reload service</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>    <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s1">&#39;systemctl reload nginx&#39;</span><span class="p">)</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>    <span class="n">sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>    <span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></p>
<p><strong>Pull Model</strong> - Endpoints retrieve certificates from CA:
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="c1"># Certificate retrieval script</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="c1"># Generate CSR</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-nodes<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">  </span>-keyout<span class="w"> </span>/etc/ssl/private/server.key<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">  </span>-out<span class="w"> </span>/tmp/server.csr<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;/C=US/O=Example Corp/CN=</span><span class="k">$(</span>hostname<span class="w"> </span>-f<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="c1"># Submit to CA and retrieve certificate</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>https://ca.example.com/api/v1/certificates<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;X-API-Key: </span><span class="nv">$API_KEY</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">  </span>-d<span class="w"> </span>@/tmp/server.csr<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">  </span>-o<span class="w"> </span>/etc/ssl/certs/server.crt
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="c1"># Verify certificate</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/etc/ssl/certs/server.crt<span class="w"> </span>-noout<span class="w"> </span>-text
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="c1"># Reload service</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>systemctl<span class="w"> </span>reload<span class="w"> </span>nginx
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="c1"># Cleanup</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>rm<span class="w"> </span>/tmp/server.csr
</code></pre></div></p>
<h3 id="secrets-management-integration">Secrets Management Integration</h3>
<p>Integrating with enterprise secrets management:</p>
<p><strong>HashiCorp Vault Integration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hvac</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">issue_and_store_certificate</span><span class="p">(</span><span class="n">common_name</span><span class="p">,</span> <span class="n">vault_path</span><span class="p">):</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Issue certificate and store in Vault&quot;&quot;&quot;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="c1"># Initialize Vault client</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">hvac</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://vault.example.com&#39;</span><span class="p">)</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>    <span class="n">client</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">approle</span><span class="o">.</span><span class="n">login</span><span class="p">(</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>        <span class="n">role_id</span><span class="o">=</span><span class="s1">&#39;your-role-id&#39;</span><span class="p">,</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>        <span class="n">secret_id</span><span class="o">=</span><span class="s1">&#39;your-secret-id&#39;</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="p">)</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="c1"># Request certificate from Vault PKI</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">pki</span><span class="o">.</span><span class="n">generate_certificate</span><span class="p">(</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;webserver-role&#39;</span><span class="p">,</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>        <span class="n">common_name</span><span class="o">=</span><span class="n">common_name</span><span class="p">,</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>        <span class="n">ttl</span><span class="o">=</span><span class="s1">&#39;90d&#39;</span><span class="p">,</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>        <span class="n">mount_point</span><span class="o">=</span><span class="s1">&#39;pki-int&#39;</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>    <span class="p">)</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>    <span class="n">certificate</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;certificate&#39;</span><span class="p">]</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>    <span class="n">private_key</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;private_key&#39;</span><span class="p">]</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>    <span class="n">ca_chain</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;ca_chain&#39;</span><span class="p">]</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>    <span class="c1"># Store in KV store for backup</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>    <span class="n">client</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">create_or_update_secret</span><span class="p">(</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>        <span class="n">path</span><span class="o">=</span><span class="n">vault_path</span><span class="p">,</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>        <span class="n">secret</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>            <span class="s1">&#39;certificate&#39;</span><span class="p">:</span> <span class="n">certificate</span><span class="p">,</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>            <span class="s1">&#39;private_key&#39;</span><span class="p">:</span> <span class="n">private_key</span><span class="p">,</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>            <span class="s1">&#39;ca_chain&#39;</span><span class="p">:</span> <span class="n">ca_chain</span><span class="p">,</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>            <span class="s1">&#39;issued_at&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;lease_start_time&#39;</span><span class="p">]</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>        <span class="p">},</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>        <span class="n">mount_point</span><span class="o">=</span><span class="s1">&#39;secret&#39;</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>    <span class="p">)</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>    <span class="k">return</span> <span class="n">certificate</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">ca_chain</span>
</code></pre></div></p>
<p><strong>AWS Secrets Manager Integration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">store_certificate_in_secrets_manager</span><span class="p">(</span><span class="n">cert_pem</span><span class="p">,</span> <span class="n">key_pem</span><span class="p">,</span> <span class="n">secret_name</span><span class="p">):</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Store certificate in AWS Secrets Manager&quot;&quot;&quot;</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;secretsmanager&#39;</span><span class="p">)</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    <span class="n">secret_value</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>        <span class="s1">&#39;certificate&#39;</span><span class="p">:</span> <span class="n">cert_pem</span><span class="p">,</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>        <span class="s1">&#39;private_key&#39;</span><span class="p">:</span> <span class="n">key_pem</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    <span class="p">}</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_secret</span><span class="p">(</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>            <span class="n">Name</span><span class="o">=</span><span class="n">secret_name</span><span class="p">,</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>            <span class="n">SecretString</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">secret_value</span><span class="p">),</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>            <span class="n">Tags</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>                <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="s1">&#39;TLS Certificate&#39;</span><span class="p">},</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>                <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;ManagedBy&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="s1">&#39;PKI System&#39;</span><span class="p">}</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>            <span class="p">]</span>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>        <span class="p">)</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>    <span class="k">except</span> <span class="n">client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ResourceExistsException</span><span class="p">:</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">put_secret_value</span><span class="p">(</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>            <span class="n">SecretId</span><span class="o">=</span><span class="n">secret_name</span><span class="p">,</span>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>            <span class="n">SecretString</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">secret_value</span><span class="p">)</span>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>        <span class="p">)</span>
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>    <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;ARN&#39;</span><span class="p">]</span>
</code></pre></div></p>
<hr />
<h2 id="automation-protocols">Automation Protocols</h2>
<h3 id="acme-automated-certificate-management-environment">ACME (Automated Certificate Management Environment)</h3>
<p>The modern standard for automated issuance (see <a href="./acme-protocol.md">ACME Protocol</a> for implementation details):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">acme</span><span class="w"> </span><span class="kn">import</span> <span class="n">client</span><span class="p">,</span> <span class="n">messages</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">acme</span><span class="w"> </span><span class="kn">import</span> <span class="n">challenges</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="c1"># Initialize ACME client</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="n">directory_url</span> <span class="o">=</span> <span class="s1">&#39;https://acme.example.com/directory&#39;</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="n">acc_key</span> <span class="o">=</span> <span class="n">load_account_key</span><span class="p">()</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="n">net</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ClientNetwork</span><span class="p">(</span><span class="n">acc_key</span><span class="p">)</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="n">directory</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">Directory</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">directory_url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="n">acme_client</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ClientV2</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">)</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="c1"># Create new order</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="n">order</span> <span class="o">=</span> <span class="n">acme_client</span><span class="o">.</span><span class="n">new_order</span><span class="p">(</span><span class="n">csr_pem</span><span class="p">)</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="c1"># Complete challenges for each authorization</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="k">for</span> <span class="n">authz</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">authorizations</span><span class="p">:</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>    <span class="k">for</span> <span class="n">challenge</span> <span class="ow">in</span> <span class="n">authz</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">challenges</span><span class="p">:</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">challenge</span><span class="o">.</span><span class="n">chall</span><span class="p">,</span> <span class="n">challenges</span><span class="o">.</span><span class="n">DNS01</span><span class="p">):</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>            <span class="c1"># Perform DNS validation</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>            <span class="n">validation_record</span> <span class="o">=</span> <span class="n">challenge</span><span class="o">.</span><span class="n">validation</span><span class="p">(</span><span class="n">acc_key</span><span class="p">)</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>            <span class="n">create_dns_record</span><span class="p">(</span><span class="n">authz</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">validation_record</span><span class="p">)</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>            <span class="c1"># Notify CA challenge is ready</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>            <span class="n">acme_client</span><span class="o">.</span><span class="n">answer_challenge</span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="n">challenge</span><span class="o">.</span><span class="n">response</span><span class="p">(</span><span class="n">acc_key</span><span class="p">))</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="c1"># Finalize order and download certificate</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="n">finalized_order</span> <span class="o">=</span> <span class="n">acme_client</span><span class="o">.</span><span class="n">poll_and_finalize</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="n">certificate</span> <span class="o">=</span> <span class="n">finalized_order</span><span class="o">.</span><span class="n">fullchain_pem</span>
</code></pre></div>
<h3 id="scep-simple-certificate-enrollment-protocol">SCEP (Simple Certificate Enrollment Protocol)</h3>
<p>Legacy protocol still widely used in enterprise networks:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># SCEP enrollment using sscep</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="c1"># Get CA certificate</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>sscep<span class="w"> </span>getca<span class="w"> </span>-u<span class="w"> </span>http://scep.example.com/scep<span class="w"> </span>-c<span class="w"> </span>ca.crt
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="c1"># Generate key and CSR</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-nodes<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">  </span>-keyout<span class="w"> </span>client.key<span class="w"> </span>-out<span class="w"> </span>client.csr<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;/C=US/O=Example/CN=client01&quot;</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="c1"># Enroll and get certificate</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>sscep<span class="w"> </span>enroll<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">  </span>-u<span class="w"> </span>http://scep.example.com/scep<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">  </span>-c<span class="w"> </span>ca.crt<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">  </span>-k<span class="w"> </span>client.key<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">  </span>-r<span class="w"> </span>client.csr<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">  </span>-l<span class="w"> </span>client.crt<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">  </span>-e<span class="w"> </span>client.key
</code></pre></div>
<h3 id="est-enrollment-over-secure-transport">EST (Enrollment over Secure Transport)</h3>
<p>Modern replacement for SCEP with better security:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">requests.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">est_enroll</span><span class="p">(</span><span class="n">csr_der</span><span class="p">,</span> <span class="n">ca_url</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enroll certificate via EST&quot;&quot;&quot;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>    <span class="c1"># EST simpleenroll endpoint</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ca_url</span><span class="si">}</span><span class="s2">/.well-known/est/simpleenroll&quot;</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/pkcs10&#39;</span><span class="p">,</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>        <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/pkcs7-mime&#39;</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>    <span class="p">}</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>        <span class="n">url</span><span class="p">,</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>        <span class="n">data</span><span class="o">=</span><span class="n">csr_der</span><span class="p">,</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>        <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">),</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>        <span class="n">verify</span><span class="o">=</span><span class="s1">&#39;/path/to/ca.crt&#39;</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>    <span class="p">)</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>        <span class="c1"># Parse PKCS7 response</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>        <span class="n">cert_der</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>        <span class="k">return</span> <span class="n">cert_der</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enrollment failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="cmc-certificate-management-over-cms">CMC (Certificate Management over CMS)</h3>
<p>Enterprise-grade enrollment with full PKI features:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">rsa</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography</span><span class="w"> </span><span class="kn">import</span> <span class="n">x509</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_cmc_request</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">signer_cert</span><span class="p">,</span> <span class="n">signer_key</span><span class="p">):</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create CMC full request&quot;&quot;&quot;</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="c1"># CMC requests are CMS SignedData structures containing CSR</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="c1"># This is a simplified example - real CMC is complex</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">asn1crypto</span><span class="w"> </span><span class="kn">import</span> <span class="n">cms</span><span class="p">,</span> <span class="n">core</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>    <span class="c1"># Build SignedData</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>    <span class="n">signed_data</span> <span class="o">=</span> <span class="n">cms</span><span class="o">.</span><span class="n">SignedData</span><span class="p">({</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>        <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;v3&#39;</span><span class="p">,</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>        <span class="s1">&#39;digest_algorithms&#39;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>            <span class="p">{</span><span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;sha256&#39;</span><span class="p">}</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>        <span class="p">],</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>        <span class="s1">&#39;encap_content_info&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>            <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">csr</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">DER</span><span class="p">)</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>        <span class="p">},</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>        <span class="s1">&#39;certificates&#39;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>            <span class="n">signer_cert</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">DER</span><span class="p">)</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>        <span class="p">],</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>        <span class="s1">&#39;signer_infos&#39;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>            <span class="n">create_signer_info</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">signer_cert</span><span class="p">,</span> <span class="n">signer_key</span><span class="p">)</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>        <span class="p">]</span>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>    <span class="p">})</span>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>    <span class="k">return</span> <span class="n">signed_data</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
</code></pre></div>
<hr />
<h2 id="workflow-management-systems">Workflow Management Systems</h2>
<h3 id="approval-workflows">Approval Workflows</h3>
<p>Implementing multi-stage approvals:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CertificateWorkflow</span><span class="p">:</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Certificate approval workflow engine&quot;&quot;&quot;</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span> <span class="o">=</span> <span class="n">NotificationService</span><span class="p">()</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">submit_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csr</span><span class="p">,</span> <span class="n">requester</span><span class="p">,</span> <span class="n">justification</span><span class="p">):</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Submit certificate request for approval&quot;&quot;&quot;</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">generate_uuid</span><span class="p">(),</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>            <span class="s1">&#39;csr&#39;</span><span class="p">:</span> <span class="n">csr</span><span class="p">,</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>            <span class="s1">&#39;requester&#39;</span><span class="p">:</span> <span class="n">requester</span><span class="p">,</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>            <span class="s1">&#39;justification&#39;</span><span class="p">:</span> <span class="n">justification</span><span class="p">,</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;pending_approval&#39;</span><span class="p">,</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>            <span class="s1">&#39;approvals_required&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_required_approvals</span><span class="p">(</span><span class="n">csr</span><span class="p">),</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>            <span class="s1">&#39;approvals_received&#39;</span><span class="p">:</span> <span class="p">[]</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>        <span class="p">}</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">save_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>        <span class="c1"># Notify approvers</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>        <span class="k">for</span> <span class="n">approver</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;approvals_required&#39;</span><span class="p">]:</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span><span class="o">.</span><span class="n">send_approval_request</span><span class="p">(</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>                <span class="n">approver</span><span class="p">,</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>                <span class="n">request</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>                <span class="n">justification</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>            <span class="p">)</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>        <span class="k">return</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">approve_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">approver</span><span class="p">,</span> <span class="n">approved</span><span class="p">):</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record approval decision&quot;&quot;&quot;</span>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>        <span class="k">if</span> <span class="n">approver</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;approvals_required&#39;</span><span class="p">]:</span>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Approver not authorized&quot;</span><span class="p">)</span>
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>        <span class="n">approval</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>            <span class="s1">&#39;approver&#39;</span><span class="p">:</span> <span class="n">approver</span><span class="p">,</span>
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>            <span class="s1">&#39;decision&#39;</span><span class="p">:</span> <span class="s1">&#39;approved&#39;</span> <span class="k">if</span> <span class="n">approved</span> <span class="k">else</span> <span class="s1">&#39;rejected&#39;</span><span class="p">,</span>
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a>            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a>        <span class="p">}</span>
<a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a>
<a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a>        <span class="n">request</span><span class="p">[</span><span class="s1">&#39;approvals_received&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">approval</span><span class="p">)</span>
<a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a>
<a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">approved</span><span class="p">:</span>
<a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a>            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rejected&#39;</span>
<a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span><span class="o">.</span><span class="n">send_rejection</span><span class="p">(</span>
<a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a>                <span class="n">request</span><span class="p">[</span><span class="s1">&#39;requester&#39;</span><span class="p">],</span>
<a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a>                <span class="n">request_id</span>
<a id="__codelineno-22-55" name="__codelineno-22-55" href="#__codelineno-22-55"></a>            <span class="p">)</span>
<a id="__codelineno-22-56" name="__codelineno-22-56" href="#__codelineno-22-56"></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;approvals_received&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;approvals_required&#39;</span><span class="p">]):</span>
<a id="__codelineno-22-57" name="__codelineno-22-57" href="#__codelineno-22-57"></a>            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;approved&#39;</span>
<a id="__codelineno-22-58" name="__codelineno-22-58" href="#__codelineno-22-58"></a>            <span class="c1"># Trigger certificate generation</span>
<a id="__codelineno-22-59" name="__codelineno-22-59" href="#__codelineno-22-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">issue_certificate</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-22-60" name="__codelineno-22-60" href="#__codelineno-22-60"></a>
<a id="__codelineno-22-61" name="__codelineno-22-61" href="#__codelineno-22-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">update_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-22-62" name="__codelineno-22-62" href="#__codelineno-22-62"></a>
<a id="__codelineno-22-63" name="__codelineno-22-63" href="#__codelineno-22-63"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_required_approvals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csr</span><span class="p">):</span>
<a id="__codelineno-22-64" name="__codelineno-22-64" href="#__codelineno-22-64"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine required approvers based on CSR&quot;&quot;&quot;</span>
<a id="__codelineno-22-65" name="__codelineno-22-65" href="#__codelineno-22-65"></a>
<a id="__codelineno-22-66" name="__codelineno-22-66" href="#__codelineno-22-66"></a>        <span class="n">cert_info</span> <span class="o">=</span> <span class="n">parse_csr</span><span class="p">(</span><span class="n">csr</span><span class="p">)</span>
<a id="__codelineno-22-67" name="__codelineno-22-67" href="#__codelineno-22-67"></a>        <span class="n">approvers</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-22-68" name="__codelineno-22-68" href="#__codelineno-22-68"></a>
<a id="__codelineno-22-69" name="__codelineno-22-69" href="#__codelineno-22-69"></a>        <span class="c1"># Require manager approval for all requests</span>
<a id="__codelineno-22-70" name="__codelineno-22-70" href="#__codelineno-22-70"></a>        <span class="n">approvers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;manager&#39;</span><span class="p">)</span>
<a id="__codelineno-22-71" name="__codelineno-22-71" href="#__codelineno-22-71"></a>
<a id="__codelineno-22-72" name="__codelineno-22-72" href="#__codelineno-22-72"></a>        <span class="c1"># Require security team for external certificates</span>
<a id="__codelineno-22-73" name="__codelineno-22-73" href="#__codelineno-22-73"></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">san</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.internal&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">san</span> <span class="ow">in</span> <span class="n">cert_info</span><span class="p">[</span><span class="s1">&#39;sans&#39;</span><span class="p">]):</span>
<a id="__codelineno-22-74" name="__codelineno-22-74" href="#__codelineno-22-74"></a>            <span class="n">approvers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;security_team&#39;</span><span class="p">)</span>
<a id="__codelineno-22-75" name="__codelineno-22-75" href="#__codelineno-22-75"></a>
<a id="__codelineno-22-76" name="__codelineno-22-76" href="#__codelineno-22-76"></a>        <span class="c1"># Require additional approval for long validity</span>
<a id="__codelineno-22-77" name="__codelineno-22-77" href="#__codelineno-22-77"></a>        <span class="k">if</span> <span class="n">cert_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validity_days&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">365</span><span class="p">:</span>
<a id="__codelineno-22-78" name="__codelineno-22-78" href="#__codelineno-22-78"></a>            <span class="n">approvers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;senior_management&#39;</span><span class="p">)</span>
<a id="__codelineno-22-79" name="__codelineno-22-79" href="#__codelineno-22-79"></a>
<a id="__codelineno-22-80" name="__codelineno-22-80" href="#__codelineno-22-80"></a>        <span class="k">return</span> <span class="n">approvers</span>
</code></pre></div>
<h3 id="integration-with-itsm-systems">Integration with ITSM Systems</h3>
<p>Connecting to ServiceNow, Jira, etc.:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">ServiceNowIntegration</span><span class="p">:</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Integrate certificate workflow with ServiceNow&quot;&quot;&quot;</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_url</span><span class="p">,</span> <span class="n">api_user</span><span class="p">,</span> <span class="n">api_pass</span><span class="p">):</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">instance_url</span><span class="si">}</span><span class="s2">/api/now/table&quot;</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="n">api_user</span><span class="p">,</span> <span class="n">api_pass</span><span class="p">)</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_change_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificate_info</span><span class="p">):</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create change request for certificate deployment&quot;&quot;&quot;</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>        <span class="n">change_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>            <span class="s1">&#39;short_description&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Deploy TLS certificate for </span><span class="si">{</span><span class="n">certificate_info</span><span class="p">[</span><span class="s1">&#39;common_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="s2">Certificate Details:</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="s2">- Common Name: </span><span class="si">{</span><span class="n">certificate_info</span><span class="p">[</span><span class="s1">&#39;common_name&#39;</span><span class="p">]</span><span class="si">}</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="s2">- SANs: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">certificate_info</span><span class="p">[</span><span class="s1">&#39;sans&#39;</span><span class="p">])</span><span class="si">}</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="s2">- Validity: </span><span class="si">{</span><span class="n">certificate_info</span><span class="p">[</span><span class="s1">&#39;not_before&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">certificate_info</span><span class="p">[</span><span class="s1">&#39;not_after&#39;</span><span class="p">]</span><span class="si">}</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="s2">- Serial: </span><span class="si">{</span><span class="n">certificate_info</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">]</span><span class="si">}</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="s2">Impact: Service restart required</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="s2">Risk: Low - automated deployment with rollback capability</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;standard&#39;</span><span class="p">,</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>            <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>            <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>            <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>            <span class="s1">&#39;assignment_group&#39;</span><span class="p">:</span> <span class="s1">&#39;PKI Team&#39;</span><span class="p">,</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>            <span class="s1">&#39;implementation_plan&#39;</span><span class="p">:</span> <span class="s1">&#39;Automated deployment via Ansible&#39;</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>        <span class="p">}</span>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/change_request&quot;</span><span class="p">,</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>            <span class="n">auth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>            <span class="n">json</span><span class="o">=</span><span class="n">change_data</span><span class="p">,</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>        <span class="p">)</span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;sys_id&#39;</span><span class="p">]</span>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create change request: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_cmdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">certificate_info</span><span class="p">):</span>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update CMDB with certificate information&quot;&quot;&quot;</span>
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a>        <span class="c1"># Find server CI</span>
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;name=</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/cmdb_ci_server&quot;</span><span class="p">,</span>
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a>            <span class="n">auth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span>
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a>            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sysparm_query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a>        <span class="p">)</span>
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a>
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a>            <span class="n">ci_sys_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sys_id&#39;</span><span class="p">]</span>
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a>
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a>            <span class="c1"># Update certificate fields</span>
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a>            <span class="n">update_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a>                <span class="s1">&#39;u_tls_certificate_serial&#39;</span><span class="p">:</span> <span class="n">certificate_info</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">],</span>
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a>                <span class="s1">&#39;u_tls_certificate_expiry&#39;</span><span class="p">:</span> <span class="n">certificate_info</span><span class="p">[</span><span class="s1">&#39;not_after&#39;</span><span class="p">],</span>
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a>                <span class="s1">&#39;u_tls_certificate_issuer&#39;</span><span class="p">:</span> <span class="n">certificate_info</span><span class="p">[</span><span class="s1">&#39;issuer&#39;</span><span class="p">]</span>
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a>            <span class="p">}</span>
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a>
<a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a>            <span class="n">requests</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
<a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/cmdb_ci_server/</span><span class="si">{</span><span class="n">ci_sys_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a>                <span class="n">auth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span>
<a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a>                <span class="n">json</span><span class="o">=</span><span class="n">update_data</span>
<a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a>            <span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="audit-and-compliance">Audit and Compliance</h2>
<h3 id="complete-audit-trails">Complete Audit Trails</h3>
<p>Recording all certificate lifecycle events:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AuditLogger</span><span class="p">:</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Comprehensive certificate audit logging&quot;&quot;&quot;</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">certificate_info</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log certificate lifecycle event&quot;&quot;&quot;</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>            <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="n">generate_uuid</span><span class="p">(),</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>            <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="n">event_type</span><span class="p">,</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="n">actor</span><span class="p">,</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>            <span class="s1">&#39;certificate_serial&#39;</span><span class="p">:</span> <span class="n">certificate_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">),</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>            <span class="s1">&#39;certificate_subject&#39;</span><span class="p">:</span> <span class="n">certificate_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">),</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>            <span class="s1">&#39;certificate_sans&#39;</span><span class="p">:</span> <span class="n">certificate_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sans&#39;</span><span class="p">),</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>            <span class="s1">&#39;system_context&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_system_context</span><span class="p">()</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>        <span class="p">}</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">audit_log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>        <span class="c1"># Send to SIEM if high-priority event</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;issuance_failed&#39;</span><span class="p">,</span> <span class="s1">&#39;unauthorized_request&#39;</span><span class="p">,</span> <span class="s1">&#39;revocation&#39;</span><span class="p">]:</span>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_to_siem</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csr</span><span class="p">,</span> <span class="n">requester</span><span class="p">,</span> <span class="n">source_ip</span><span class="p">):</span>
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log certificate request&quot;&quot;&quot;</span>
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_event</span><span class="p">(</span>
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>            <span class="s1">&#39;certificate_requested&#39;</span><span class="p">,</span>
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>            <span class="n">parse_csr</span><span class="p">(</span><span class="n">csr</span><span class="p">),</span>
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>            <span class="n">requester</span><span class="p">,</span>
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a>            <span class="p">{</span><span class="s1">&#39;source_ip&#39;</span><span class="p">:</span> <span class="n">source_ip</span><span class="p">,</span> <span class="s1">&#39;csr_fingerprint&#39;</span><span class="p">:</span> <span class="n">hash_csr</span><span class="p">(</span><span class="n">csr</span><span class="p">)}</span>
<a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>        <span class="p">)</span>
<a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a>
<a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificate_info</span><span class="p">,</span> <span class="n">validation_method</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log validation attempt&quot;&quot;&quot;</span>
<a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_event</span><span class="p">(</span>
<a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a>            <span class="s1">&#39;validation_attempted&#39;</span><span class="p">,</span>
<a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a>            <span class="n">certificate_info</span><span class="p">,</span>
<a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a>            <span class="s1">&#39;system&#39;</span><span class="p">,</span>
<a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">validation_method</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>        <span class="p">)</span>
<a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>
<a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_issuance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificate</span><span class="p">,</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
<a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log successful certificate issuance&quot;&quot;&quot;</span>
<a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_event</span><span class="p">(</span>
<a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a>            <span class="s1">&#39;certificate_issued&#39;</span><span class="p">,</span>
<a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a>            <span class="n">extract_cert_info</span><span class="p">(</span><span class="n">certificate</span><span class="p">),</span>
<a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a>            <span class="n">issuer</span><span class="p">,</span>
<a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a>            <span class="p">{</span><span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">profile</span><span class="p">,</span> <span class="s1">&#39;validity_days&#39;</span><span class="p">:</span> <span class="n">get_validity_days</span><span class="p">(</span><span class="n">certificate</span><span class="p">)}</span>
<a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a>        <span class="p">)</span>
<a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a>
<a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificate_serial</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
<a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log certificate distribution&quot;&quot;&quot;</span>
<a id="__codelineno-24-57" name="__codelineno-24-57" href="#__codelineno-24-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_event</span><span class="p">(</span>
<a id="__codelineno-24-58" name="__codelineno-24-58" href="#__codelineno-24-58"></a>            <span class="s1">&#39;certificate_distributed&#39;</span><span class="p">,</span>
<a id="__codelineno-24-59" name="__codelineno-24-59" href="#__codelineno-24-59"></a>            <span class="p">{</span><span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="n">certificate_serial</span><span class="p">},</span>
<a id="__codelineno-24-60" name="__codelineno-24-60" href="#__codelineno-24-60"></a>            <span class="s1">&#39;system&#39;</span><span class="p">,</span>
<a id="__codelineno-24-61" name="__codelineno-24-61" href="#__codelineno-24-61"></a>            <span class="p">{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">}</span>
<a id="__codelineno-24-62" name="__codelineno-24-62" href="#__codelineno-24-62"></a>        <span class="p">)</span>
<a id="__codelineno-24-63" name="__codelineno-24-63" href="#__codelineno-24-63"></a>
<a id="__codelineno-24-64" name="__codelineno-24-64" href="#__codelineno-24-64"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_installation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificate_serial</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
<a id="__codelineno-24-65" name="__codelineno-24-65" href="#__codelineno-24-65"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log certificate installation&quot;&quot;&quot;</span>
<a id="__codelineno-24-66" name="__codelineno-24-66" href="#__codelineno-24-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_event</span><span class="p">(</span>
<a id="__codelineno-24-67" name="__codelineno-24-67" href="#__codelineno-24-67"></a>            <span class="s1">&#39;certificate_installed&#39;</span><span class="p">,</span>
<a id="__codelineno-24-68" name="__codelineno-24-68" href="#__codelineno-24-68"></a>            <span class="p">{</span><span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="n">certificate_serial</span><span class="p">},</span>
<a id="__codelineno-24-69" name="__codelineno-24-69" href="#__codelineno-24-69"></a>            <span class="n">hostname</span><span class="p">,</span>
<a id="__codelineno-24-70" name="__codelineno-24-70" href="#__codelineno-24-70"></a>            <span class="p">{</span><span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="n">service</span><span class="p">}</span>
<a id="__codelineno-24-71" name="__codelineno-24-71" href="#__codelineno-24-71"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="compliance-reporting">Compliance Reporting</h3>
<p>Generating audit reports for compliance:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_compliance_report</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate certificate issuance compliance report&quot;&quot;&quot;</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="n">db</span> <span class="o">=</span> <span class="n">connect_to_database</span><span class="p">()</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    <span class="c1"># Query audit logs</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    <span class="n">events</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">audit_log</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span><span class="p">:</span> <span class="n">start_date</span><span class="p">,</span> <span class="s1">&#39;$lte&#39;</span><span class="p">:</span> <span class="n">end_date</span><span class="p">},</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>        <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$in&#39;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>            <span class="s1">&#39;certificate_requested&#39;</span><span class="p">,</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>            <span class="s1">&#39;certificate_issued&#39;</span><span class="p">,</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>            <span class="s1">&#39;validation_attempted&#39;</span><span class="p">,</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>            <span class="s1">&#39;issuance_failed&#39;</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>        <span class="p">]}</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>    <span class="p">})</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>    <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>        <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>        <span class="s1">&#39;total_requests&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>        <span class="s1">&#39;successful_issuances&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>        <span class="s1">&#39;failed_issuances&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>        <span class="s1">&#39;validation_failures&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>        <span class="s1">&#39;unauthorized_attempts&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>        <span class="s1">&#39;by_profile&#39;</span><span class="p">:</span> <span class="p">{},</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>        <span class="s1">&#39;by_requester&#39;</span><span class="p">:</span> <span class="p">{},</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>        <span class="s1">&#39;average_issuance_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>        <span class="s1">&#39;compliance_violations&#39;</span><span class="p">:</span> <span class="p">[]</span>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>    <span class="p">}</span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>    <span class="n">issuance_times</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;certificate_requested&#39;</span><span class="p">:</span>
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a>            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;total_requests&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a>
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>        <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;certificate_issued&#39;</span><span class="p">:</span>
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a>            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;successful_issuances&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a>            <span class="n">profile</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">)</span>
<a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;by_profile&#39;</span><span class="p">][</span><span class="n">profile</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;by_profile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a>
<a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a>            <span class="n">requester</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;actor&#39;</span><span class="p">]</span>
<a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;by_requester&#39;</span><span class="p">][</span><span class="n">requester</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;by_requester&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">requester</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a>
<a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a>            <span class="c1"># Check for compliance violations</span>
<a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a>            <span class="n">validity_days</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validity_days&#39;</span><span class="p">)</span>
<a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a>            <span class="k">if</span> <span class="n">validity_days</span> <span class="o">&gt;</span> <span class="mi">398</span><span class="p">:</span>  <span class="c1"># CA/B Forum baseline requirement</span>
<a id="__codelineno-25-48" name="__codelineno-25-48" href="#__codelineno-25-48"></a>                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;compliance_violations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-25-49" name="__codelineno-25-49" href="#__codelineno-25-49"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;excessive_validity&#39;</span><span class="p">,</span>
<a id="__codelineno-25-50" name="__codelineno-25-50" href="#__codelineno-25-50"></a>                    <span class="s1">&#39;certificate_serial&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;certificate_serial&#39;</span><span class="p">],</span>
<a id="__codelineno-25-51" name="__codelineno-25-51" href="#__codelineno-25-51"></a>                    <span class="s1">&#39;validity_days&#39;</span><span class="p">:</span> <span class="n">validity_days</span>
<a id="__codelineno-25-52" name="__codelineno-25-52" href="#__codelineno-25-52"></a>                <span class="p">})</span>
<a id="__codelineno-25-53" name="__codelineno-25-53" href="#__codelineno-25-53"></a>
<a id="__codelineno-25-54" name="__codelineno-25-54" href="#__codelineno-25-54"></a>        <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;issuance_failed&#39;</span><span class="p">:</span>
<a id="__codelineno-25-55" name="__codelineno-25-55" href="#__codelineno-25-55"></a>            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;failed_issuances&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-25-56" name="__codelineno-25-56" href="#__codelineno-25-56"></a>
<a id="__codelineno-25-57" name="__codelineno-25-57" href="#__codelineno-25-57"></a>            <span class="k">if</span> <span class="s1">&#39;unauthorized&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
<a id="__codelineno-25-58" name="__codelineno-25-58" href="#__codelineno-25-58"></a>                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;unauthorized_attempts&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-25-59" name="__codelineno-25-59" href="#__codelineno-25-59"></a>
<a id="__codelineno-25-60" name="__codelineno-25-60" href="#__codelineno-25-60"></a>        <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;validation_attempted&#39;</span><span class="p">:</span>
<a id="__codelineno-25-61" name="__codelineno-25-61" href="#__codelineno-25-61"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">][</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
<a id="__codelineno-25-62" name="__codelineno-25-62" href="#__codelineno-25-62"></a>                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;validation_failures&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-25-63" name="__codelineno-25-63" href="#__codelineno-25-63"></a>
<a id="__codelineno-25-64" name="__codelineno-25-64" href="#__codelineno-25-64"></a>    <span class="k">if</span> <span class="n">issuance_times</span><span class="p">:</span>
<a id="__codelineno-25-65" name="__codelineno-25-65" href="#__codelineno-25-65"></a>        <span class="n">report</span><span class="p">[</span><span class="s1">&#39;average_issuance_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">issuance_times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">issuance_times</span><span class="p">)</span>
<a id="__codelineno-25-66" name="__codelineno-25-66" href="#__codelineno-25-66"></a>
<a id="__codelineno-25-67" name="__codelineno-25-67" href="#__codelineno-25-67"></a>    <span class="k">return</span> <span class="n">report</span>
</code></pre></div>
<hr />
<h2 id="error-handling-and-recovery">Error Handling and Recovery</h2>
<h3 id="request-validation-errors">Request Validation Errors</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">IssuanceError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for issuance errors&quot;&quot;&quot;</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>    <span class="k">pass</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">ValidationError</span><span class="p">(</span><span class="n">IssuanceError</span><span class="p">):</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Domain validation failed&quot;&quot;&quot;</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="k">pass</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">AuthorizationError</span><span class="p">(</span><span class="n">IssuanceError</span><span class="p">):</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Requester not authorized&quot;&quot;&quot;</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>    <span class="k">pass</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">PolicyViolationError</span><span class="p">(</span><span class="n">IssuanceError</span><span class="p">):</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request violates policy&quot;&quot;&quot;</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>    <span class="k">pass</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="k">def</span><span class="w"> </span><span class="nf">handle_issuance_request</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">requester</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle certificate issuance with comprehensive error handling&quot;&quot;&quot;</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>        <span class="c1"># Parse CSR</span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>            <span class="n">cert_info</span> <span class="o">=</span> <span class="n">parse_csr</span><span class="p">(</span><span class="n">csr</span><span class="p">)</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid CSR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>        <span class="c1"># Authenticate requester</span>
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a>            <span class="n">audit_log</span><span class="o">.</span><span class="n">log_unauthorized_attempt</span><span class="p">(</span><span class="n">requester</span><span class="p">)</span>
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a>            <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s2">&quot;Invalid API key&quot;</span><span class="p">)</span>
<a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a>
<a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a>        <span class="c1"># Authorize request</span>
<a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a>        <span class="n">authorized</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">can_issue</span><span class="p">(</span><span class="n">requester</span><span class="p">,</span> <span class="n">cert_info</span><span class="p">)</span>
<a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">authorized</span><span class="p">:</span>
<a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>            <span class="n">audit_log</span><span class="o">.</span><span class="n">log_authorization_failure</span><span class="p">(</span><span class="n">requester</span><span class="p">,</span> <span class="n">cert_info</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
<a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a>            <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
<a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a>
<a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a>        <span class="c1"># Validate domain ownership</span>
<a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a>        <span class="k">for</span> <span class="n">san</span> <span class="ow">in</span> <span class="n">cert_info</span><span class="p">[</span><span class="s1">&#39;sans&#39;</span><span class="p">]:</span>
<a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_domain_ownership</span><span class="p">(</span><span class="n">san</span><span class="p">,</span> <span class="n">requester</span><span class="p">):</span>
<a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a>                <span class="n">audit_log</span><span class="o">.</span><span class="n">log_validation_failure</span><span class="p">(</span><span class="n">san</span><span class="p">,</span> <span class="n">requester</span><span class="p">)</span>
<a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a>                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot validate ownership of </span><span class="si">{</span><span class="n">san</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a>
<a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a>        <span class="c1"># Check policy constraints</span>
<a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a>        <span class="k">if</span> <span class="n">cert_info</span><span class="p">[</span><span class="s1">&#39;key_size&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">:</span>
<a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a>            <span class="k">raise</span> <span class="n">PolicyViolationError</span><span class="p">(</span><span class="s2">&quot;Key size below minimum (2048 bits)&quot;</span><span class="p">)</span>
<a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a>
<a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a>        <span class="k">if</span> <span class="n">cert_info</span><span class="p">[</span><span class="s1">&#39;validity_days&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
<a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">requester</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="s1">&#39;long_validity&#39;</span><span class="p">):</span>
<a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a>                <span class="k">raise</span> <span class="n">PolicyViolationError</span><span class="p">(</span><span class="s2">&quot;Validity exceeds permitted maximum&quot;</span><span class="p">)</span>
<a id="__codelineno-26-51" name="__codelineno-26-51" href="#__codelineno-26-51"></a>
<a id="__codelineno-26-52" name="__codelineno-26-52" href="#__codelineno-26-52"></a>        <span class="c1"># Issue certificate</span>
<a id="__codelineno-26-53" name="__codelineno-26-53" href="#__codelineno-26-53"></a>        <span class="n">certificate</span> <span class="o">=</span> <span class="n">generate_certificate</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">cert_info</span><span class="p">,</span> <span class="n">requester</span><span class="p">)</span>
<a id="__codelineno-26-54" name="__codelineno-26-54" href="#__codelineno-26-54"></a>
<a id="__codelineno-26-55" name="__codelineno-26-55" href="#__codelineno-26-55"></a>        <span class="n">audit_log</span><span class="o">.</span><span class="n">log_issuance</span><span class="p">(</span><span class="n">certificate</span><span class="p">,</span> <span class="n">requester</span><span class="p">)</span>
<a id="__codelineno-26-56" name="__codelineno-26-56" href="#__codelineno-26-56"></a>
<a id="__codelineno-26-57" name="__codelineno-26-57" href="#__codelineno-26-57"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-26-58" name="__codelineno-26-58" href="#__codelineno-26-58"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
<a id="__codelineno-26-59" name="__codelineno-26-59" href="#__codelineno-26-59"></a>            <span class="s1">&#39;certificate&#39;</span><span class="p">:</span> <span class="n">certificate</span><span class="p">,</span>
<a id="__codelineno-26-60" name="__codelineno-26-60" href="#__codelineno-26-60"></a>            <span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="n">extract_serial</span><span class="p">(</span><span class="n">certificate</span><span class="p">)</span>
<a id="__codelineno-26-61" name="__codelineno-26-61" href="#__codelineno-26-61"></a>        <span class="p">}</span>
<a id="__codelineno-26-62" name="__codelineno-26-62" href="#__codelineno-26-62"></a>
<a id="__codelineno-26-63" name="__codelineno-26-63" href="#__codelineno-26-63"></a>    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-26-64" name="__codelineno-26-64" href="#__codelineno-26-64"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-26-65" name="__codelineno-26-65" href="#__codelineno-26-65"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;validation_error&#39;</span><span class="p">,</span>
<a id="__codelineno-26-66" name="__codelineno-26-66" href="#__codelineno-26-66"></a>            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-26-67" name="__codelineno-26-67" href="#__codelineno-26-67"></a>            <span class="s1">&#39;retry_allowed&#39;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-26-68" name="__codelineno-26-68" href="#__codelineno-26-68"></a>        <span class="p">}</span>
<a id="__codelineno-26-69" name="__codelineno-26-69" href="#__codelineno-26-69"></a>
<a id="__codelineno-26-70" name="__codelineno-26-70" href="#__codelineno-26-70"></a>    <span class="k">except</span> <span class="n">AuthorizationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-26-71" name="__codelineno-26-71" href="#__codelineno-26-71"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-26-72" name="__codelineno-26-72" href="#__codelineno-26-72"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;authorization_error&#39;</span><span class="p">,</span>
<a id="__codelineno-26-73" name="__codelineno-26-73" href="#__codelineno-26-73"></a>            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-26-74" name="__codelineno-26-74" href="#__codelineno-26-74"></a>            <span class="s1">&#39;retry_allowed&#39;</span><span class="p">:</span> <span class="kc">False</span>
<a id="__codelineno-26-75" name="__codelineno-26-75" href="#__codelineno-26-75"></a>        <span class="p">}</span>
<a id="__codelineno-26-76" name="__codelineno-26-76" href="#__codelineno-26-76"></a>
<a id="__codelineno-26-77" name="__codelineno-26-77" href="#__codelineno-26-77"></a>    <span class="k">except</span> <span class="n">PolicyViolationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-26-78" name="__codelineno-26-78" href="#__codelineno-26-78"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-26-79" name="__codelineno-26-79" href="#__codelineno-26-79"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;policy_violation&#39;</span><span class="p">,</span>
<a id="__codelineno-26-80" name="__codelineno-26-80" href="#__codelineno-26-80"></a>            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-26-81" name="__codelineno-26-81" href="#__codelineno-26-81"></a>            <span class="s1">&#39;retry_allowed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-26-82" name="__codelineno-26-82" href="#__codelineno-26-82"></a>            <span class="s1">&#39;suggestions&#39;</span><span class="p">:</span> <span class="n">get_policy_suggestions</span><span class="p">(</span><span class="n">cert_info</span><span class="p">)</span>
<a id="__codelineno-26-83" name="__codelineno-26-83" href="#__codelineno-26-83"></a>        <span class="p">}</span>
<a id="__codelineno-26-84" name="__codelineno-26-84" href="#__codelineno-26-84"></a>
<a id="__codelineno-26-85" name="__codelineno-26-85" href="#__codelineno-26-85"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-26-86" name="__codelineno-26-86" href="#__codelineno-26-86"></a>        <span class="n">audit_log</span><span class="o">.</span><span class="n">log_system_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-26-87" name="__codelineno-26-87" href="#__codelineno-26-87"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-26-88" name="__codelineno-26-88" href="#__codelineno-26-88"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;system_error&#39;</span><span class="p">,</span>
<a id="__codelineno-26-89" name="__codelineno-26-89" href="#__codelineno-26-89"></a>            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Internal error occurred&#39;</span><span class="p">,</span>
<a id="__codelineno-26-90" name="__codelineno-26-90" href="#__codelineno-26-90"></a>            <span class="s1">&#39;retry_allowed&#39;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-26-91" name="__codelineno-26-91" href="#__codelineno-26-91"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="retry-logic">Retry Logic</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">retry_with_backoff</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">initial_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator for retrying failed operations with exponential backoff&quot;&quot;&quot;</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>            <span class="n">delay</span> <span class="o">=</span> <span class="n">initial_delay</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>            <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>                <span class="k">except</span> <span class="n">RetryableError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>                    <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>                        <span class="k">raise</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2">s...&quot;</span><span class="p">)</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>                    <span class="n">delay</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># Exponential backoff</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>                <span class="k">except</span> <span class="n">FatalError</span><span class="p">:</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>                    <span class="c1"># Don&#39;t retry fatal errors</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>                    <span class="k">raise</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>        <span class="k">return</span> <span class="n">wrapper</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>    <span class="k">return</span> <span class="n">decorator</span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="nd">@retry_with_backoff</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate_domain_with_dns</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate domain ownership via DNS with retries&quot;&quot;&quot;</span>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">dns.resolver</span>
<a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>
<a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a>    <span class="n">record_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_acme-challenge.</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a>
<a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a>        <span class="n">answers</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">record_name</span><span class="p">,</span> <span class="s1">&#39;TXT&#39;</span><span class="p">)</span>
<a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>        <span class="k">for</span> <span class="n">rdata</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">:</span>
<a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a>            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">rdata</span><span class="p">):</span>
<a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a>
<a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a>    <span class="k">except</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NXDOMAIN</span><span class="p">:</span>
<a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a>        <span class="k">raise</span> <span class="n">RetryableError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DNS record not found: </span><span class="si">{</span><span class="n">record_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a>
<a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a>    <span class="k">except</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NoAnswer</span><span class="p">:</span>
<a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a>        <span class="k">raise</span> <span class="n">RetryableError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No TXT records for </span><span class="si">{</span><span class="n">record_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a>
<a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a>    <span class="k">except</span> <span class="n">dns</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
<a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a>        <span class="k">raise</span> <span class="n">RetryableError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DNS query timeout for </span><span class="si">{</span><span class="n">record_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="performance-optimization">Performance Optimization</h2>
<h3 id="batch-processing">Batch Processing</h3>
<p>Processing multiple certificate requests efficiently:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">BatchCertificateProcessor</span><span class="p">:</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Process multiple certificate requests in parallel&quot;&quot;&quot;</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requests</span><span class="p">):</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process batch of certificate requests&quot;&quot;&quot;</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>        <span class="c1"># Create tasks for each request</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>            <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">,</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">process_single_request</span><span class="p">,</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>                <span class="n">request</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>            <span class="p">)</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>            <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>        <span class="p">]</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a>        <span class="c1"># Wait for all to complete</span>
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a>        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a>
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a>        <span class="c1"># Separate successes and failures</span>
<a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a>        <span class="n">successes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a>        <span class="n">failures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a>
<a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a>        <span class="k">for</span> <span class="n">request</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a>                <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a>                    <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
<a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a>                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a>                <span class="p">})</span>
<a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a>                <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a>
<a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a>            <span class="s1">&#39;successes&#39;</span><span class="p">:</span> <span class="n">successes</span><span class="p">,</span>
<a id="__codelineno-28-43" name="__codelineno-28-43" href="#__codelineno-28-43"></a>            <span class="s1">&#39;failures&#39;</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span>
<a id="__codelineno-28-44" name="__codelineno-28-44" href="#__codelineno-28-44"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">),</span>
<a id="__codelineno-28-45" name="__codelineno-28-45" href="#__codelineno-28-45"></a>            <span class="s1">&#39;success_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">successes</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-28-46" name="__codelineno-28-46" href="#__codelineno-28-46"></a>        <span class="p">}</span>
<a id="__codelineno-28-47" name="__codelineno-28-47" href="#__codelineno-28-47"></a>
<a id="__codelineno-28-48" name="__codelineno-28-48" href="#__codelineno-28-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_single_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<a id="__codelineno-28-49" name="__codelineno-28-49" href="#__codelineno-28-49"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process individual certificate request&quot;&quot;&quot;</span>
<a id="__codelineno-28-50" name="__codelineno-28-50" href="#__codelineno-28-50"></a>
<a id="__codelineno-28-51" name="__codelineno-28-51" href="#__codelineno-28-51"></a>        <span class="c1"># Parse CSR</span>
<a id="__codelineno-28-52" name="__codelineno-28-52" href="#__codelineno-28-52"></a>        <span class="n">cert_info</span> <span class="o">=</span> <span class="n">parse_csr</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;csr&#39;</span><span class="p">])</span>
<a id="__codelineno-28-53" name="__codelineno-28-53" href="#__codelineno-28-53"></a>
<a id="__codelineno-28-54" name="__codelineno-28-54" href="#__codelineno-28-54"></a>        <span class="c1"># Validate</span>
<a id="__codelineno-28-55" name="__codelineno-28-55" href="#__codelineno-28-55"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_request</span><span class="p">(</span><span class="n">cert_info</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;requester&#39;</span><span class="p">]):</span>
<a id="__codelineno-28-56" name="__codelineno-28-56" href="#__codelineno-28-56"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Request validation failed&quot;</span><span class="p">)</span>
<a id="__codelineno-28-57" name="__codelineno-28-57" href="#__codelineno-28-57"></a>
<a id="__codelineno-28-58" name="__codelineno-28-58" href="#__codelineno-28-58"></a>        <span class="c1"># Generate certificate</span>
<a id="__codelineno-28-59" name="__codelineno-28-59" href="#__codelineno-28-59"></a>        <span class="n">certificate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_certificate</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;csr&#39;</span><span class="p">])</span>
<a id="__codelineno-28-60" name="__codelineno-28-60" href="#__codelineno-28-60"></a>
<a id="__codelineno-28-61" name="__codelineno-28-61" href="#__codelineno-28-61"></a>        <span class="c1"># Store in database</span>
<a id="__codelineno-28-62" name="__codelineno-28-62" href="#__codelineno-28-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">store_certificate</span><span class="p">(</span><span class="n">certificate</span><span class="p">)</span>
<a id="__codelineno-28-63" name="__codelineno-28-63" href="#__codelineno-28-63"></a>
<a id="__codelineno-28-64" name="__codelineno-28-64" href="#__codelineno-28-64"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-28-65" name="__codelineno-28-65" href="#__codelineno-28-65"></a>            <span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="n">extract_serial</span><span class="p">(</span><span class="n">certificate</span><span class="p">),</span>
<a id="__codelineno-28-66" name="__codelineno-28-66" href="#__codelineno-28-66"></a>            <span class="s1">&#39;certificate&#39;</span><span class="p">:</span> <span class="n">certificate</span>
<a id="__codelineno-28-67" name="__codelineno-28-67" href="#__codelineno-28-67"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="caching-strategies">Caching Strategies</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">redis</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">CertificateCache</span><span class="p">:</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Cache frequently accessed certificate data&quot;&quot;&quot;</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_url</span><span class="p">):</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_issuer_cert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">issuer_name</span><span class="p">):</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get issuer certificate with caching&quot;&quot;&quot;</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;issuer:</span><span class="si">{</span><span class="n">issuer_name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>        <span class="c1"># Try cache first</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a>        <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>        <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>            <span class="k">return</span> <span class="n">cached</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>        <span class="c1"># Load from database</span>
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a>        <span class="n">cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_issuer_from_db</span><span class="p">(</span><span class="n">issuer_name</span><span class="p">)</span>
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a>
<a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a>        <span class="c1"># Cache for 1 hour</span>
<a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="n">cert</span><span class="p">)</span>
<a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a>
<a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a>        <span class="k">return</span> <span class="n">cert</span>
<a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a>
<a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a>    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_name</span><span class="p">):</span>
<a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cache certificate policies in memory&quot;&quot;&quot;</span>
<a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_policy_from_db</span><span class="p">(</span><span class="n">profile_name</span><span class="p">)</span>
<a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a>
<a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">invalidate_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_name</span><span class="p">):</span>
<a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invalidate cached policy when updated&quot;&quot;&quot;</span>
<a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_policy</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
</code></pre></div>
<hr />
<h2 id="common-pitfalls">Common Pitfalls</h2>
<h3 id="weak-validation">Weak Validation</h3>
<p><strong>Problem</strong>: Insufficient validation allows unauthorized certificates<br />
<strong>Solution</strong>: Implement multiple validation methods, enforce strict authorization</p>
<h3 id="missing-audit-trails">Missing Audit Trails</h3>
<p><strong>Problem</strong>: No record of certificate issuance decisions<br />
<strong>Solution</strong>: Log all actions with complete context before and after operations</p>
<h3 id="manual-bottlenecks">Manual Bottlenecks</h3>
<p><strong>Problem</strong>: Manual approval gates create delays and inconsistency<br />
<strong>Solution</strong>: Replace with policy-driven automation, reserve manual review for exceptions</p>
<h3 id="insufficient-error-handling">Insufficient Error Handling</h3>
<p><strong>Problem</strong>: Cryptic errors prevent users from fixing issues<br />
<strong>Solution</strong>: Provide specific, actionable error messages with remediation guidance</p>
<h3 id="poor-key-management">Poor Key Management</h3>
<p><strong>Problem</strong>: Private keys exposed during distribution<br />
<strong>Solution</strong>: Never transmit private keys, use key generation on endpoint or secure channels</p>
<h3 id="inconsistent-policy-enforcement">Inconsistent Policy Enforcement</h3>
<p><strong>Problem</strong>: Different paths (web UI, API, manual) apply different rules<br />
<strong>Solution</strong>: Single policy engine enforced at all entry points</p>
<hr />
<h2 id="security-considerations">Security Considerations</h2>
<h3 id="request-authentication">Request Authentication</h3>
<ul>
<li>Use strong authentication (mTLS, OAuth) not just API keys</li>
<li>Implement rate limiting per identity</li>
<li>Log all authentication attempts</li>
<li>Use short-lived tokens for temporary access</li>
</ul>
<h3 id="domain-validation-security">Domain Validation Security</h3>
<ul>
<li>DNS validation preferred over HTTP for security</li>
<li>Implement CAA checking before issuance</li>
<li>Verify requester owns domains, not just can modify DNS</li>
<li>Use multiple validation methods for high-value certificates</li>
</ul>
<h3 id="private-key-protection">Private Key Protection</h3>
<ul>
<li>Generate keys on endpoint when possible</li>
<li>Never email or expose keys in logs</li>
<li>Use HSMs for CA signing keys</li>
<li>Implement key escrow only when required by policy</li>
</ul>
<h3 id="approval-bypass-prevention">Approval Bypass Prevention</h3>
<ul>
<li>No "emergency" backdoors bypassing policy</li>
<li>All exceptions logged and reviewed</li>
<li>Temporary elevated access with automatic expiration</li>
<li>Separation of duties for high-value certificates</li>
</ul>
<hr />
<h2 id="real-world-examples">Real-World Examples</h2>
<h3 id="google-certificate-automation">Google Certificate Automation</h3>
<p>Google issues millions of certificates daily with fully automated workflows:</p>
<ul>
<li>Custom ACME implementation for internal services</li>
<li>Policy-driven issuance with no manual approvals</li>
<li>6-day certificate lifetimes for maximum security</li>
<li>Automated deployment via service mesh (Istio)</li>
<li>Complete visibility and control through centralized management</li>
</ul>
<p><strong>Key Lessons</strong>: Extreme automation possible with proper policy framework, short lifetimes eliminate revocation concerns, infrastructure-as-code enables at scale.</p>
<h3 id="financial-services-manual-to-automated">Financial Services Manual to Automated</h3>
<p>Large bank transformed certificate management:</p>
<ul>
<li><strong>Before</strong>: 200+ hours/month, manual processes, 90-day issuance time</li>
<li><strong>Transformation</strong>: Implemented approval workflows, ACME integration, policy engine</li>
<li><strong>After</strong>: 12 hours/month, 5-minute issuance, 99.9% automated</li>
<li><strong>Investment</strong>: $400K over 6 months</li>
<li><strong>Return</strong>: $2.67M first-year value from efficiency and incident prevention</li>
</ul>
<p><strong>Key Lessons</strong>: Semi-automated workflow sufficient for most enterprises, policy engine enables automation while maintaining control, approval workflows bridge manual to automated.</p>
<h3 id="cloud-provider-instant-issuance">Cloud Provider Instant Issuance</h3>
<p>AWS Certificate Manager model:</p>
<ul>
<li>Instant validation for AWS-hosted domains</li>
<li>Automated renewal with no customer action</li>
<li>Integration with load balancers, CloudFront, API Gateway</li>
<li>No certificate storage or management required</li>
<li>Transparent deployment and renewal</li>
</ul>
<p><strong>Key Lessons</strong>: Platform integration enables seamless experience, automated validation reduces friction, hiding complexity increases adoption.</p>
<hr />
<h2 id="further-reading">Further Reading</h2>
<h3 id="standards-and-rfcs">Standards and RFCs</h3>
<ul>
<li>RFC 2986: PKCS #10 Certificate Request Syntax</li>
<li>RFC 8555: ACME Protocol</li>
<li>RFC 8894: SCEP Protocol</li>
<li>RFC 7030: EST Protocol</li>
<li>RFC 5272: CMC Protocol</li>
<li>RFC 6125: Domain Name Representation in Certificates</li>
</ul>
<h3 id="related-pages">Related Pages</h3>
<ul>
<li><a href="./acme-protocol.md">ACME Protocol Implementation</a> - Building ACME servers</li>
<li><a href="./certificate-lifecycle-management.md">Certificate Lifecycle Management</a> - Complete lifecycle</li>
<li><a href="../ca-architecture/">CA Architecture</a> - CA design and operation</li>
<li><a href="../hsm-integration/">HSM Integration</a> - Hardware security modules</li>
<li><a href="../multi-cloud-pki/">Multi-Cloud PKI</a> - Cloud certificate management</li>
</ul>
<h3 id="industry-resources">Industry Resources</h3>
<ul>
<li>CA/Browser Forum Baseline Requirements</li>
<li>NIST SP 800-57: Key Management Recommendations</li>
<li>CIS Controls: Certificate and SSL/TLS Management</li>
<li>Microsoft PKI Best Practices</li>
<li>SANS Institute: Certificate Lifecycle Management</li>
</ul>
<hr />
<p><strong>Last Updated</strong>: 2025-11-09<br />
<strong>Maintenance Notes</strong>: Update with emerging protocols (ACME extensions, new validation methods), add cloud provider examples, expand automation patterns</p>









  




                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/company/axonsecurity/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
  
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var sidebar = document.querySelector('.md-sidebar--secondary .md-sidebar__scrollwrap');
      if (sidebar) {
        var disclaimer = document.createElement('div');
        disclaimer.className = 'md-sidebar-disclaimer';
        disclaimer.innerHTML = `
          <div class="md-typeset">
            <div class="admonition info">
              <p class="admonition-title"> Our Books</p>
              <p><a href="https://axonshield.com/book"><strong>The Invisible Certificate Management Tax and How Automation Eliminates 94% of It</strong></a></p>
            </div>
            <div class="admonition warning">
              <p class="admonition-title"> Disclaimer</p>
              <p><small>This documentation is based on "best practices". We've observed these ignore 
                unique organizational needs and often prove ineffective for long-term, sustainable 
                operations and ignore strategic advanteges of building infrastructure intelligence.</small></p>
            </div>
          </div>
        `;
        sidebar.insertBefore(disclaimer, sidebar.firstChild);
      }
    });
  </script>
  

  </body>
</html>