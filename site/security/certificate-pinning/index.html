
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://axonshield.com/vault/security/certificate-pinning/">
      
      
        <link rel="prev" href="../ca-compromise-scenarios/">
      
      
        <link rel="next" href="../common-vulnerabilities/">
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Certificate Pinning - Shield Vault</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


    
    
    
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WJXPDRF2');</script>
  <!-- End Google Tag Manager -->
  
  <!-- Apollo Tracking -->
  <script>
    (function() {
      var apolloScript = document.createElement('script');
      apolloScript.type = 'text/javascript';
      apolloScript.async = true;
      apolloScript.src = 'https://cdn.apollo.io/v1/apollo.js';
      apolloScript.setAttribute('data-apollo-id', '68b8b91c5e883f0021f7f7aa');
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(apolloScript, s);
    })();
  </script>
  <!-- End Apollo Tracking -->
  
  <!-- Organization Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ProfessionalService",
    "name": "Axon Shield",
    "address": [
      {
        "@type": "PostalAddress",
        "addressCountry": "GB",
        "addressLocality": "London"
      },
      {
        "@type": "PostalAddress",
        "addressCountry": "HK",
        "addressLocality": "Hong Kong"
      }
    ],
    "url": "https://axonshield.com",
    "logo": "https://vault.axonshield.com/assets/axon-logo.png",
    "description": "Enterprise PKI and certificate automation consulting. Cambridge postdoctoral expertise with implementations at Barclays, Deutsche Bank, Sky UK, and Comcast. Specializing in HSM integration, multi-tenant PKI architecture, and certificate management for fintech and healthcare.",
    "priceRange": "$$$",
    "areaServed": {
      "@type": "Country",
      "name": "Worldwide"
    },
    "serviceType": [
      "PKI Architecture Consulting",
      "Certificate Automation Implementation", 
      "HSM Integration",
      "Multi-Tenant PKI Design",
      "Certificate Management Strategy",
      "Post-Quantum Cryptography Planning"
    ],
    "founder": {
      "@type": "Person",
      "name": "Dan Cvrcek",
      "jobTitle": "Founder and Principal Consultant",
      "description": "Cambridge postdoctoral researcher specializing in PKI and cryptography. Black Hat and DEF CON conference speaker with 20+ years implementing certificate infrastructure for Fortune 500 companies.",
      "alumniOf": {
        "@type": "CollegeOrUniversity",
        "name": "University of Cambridge",
        "sameAs": "https://www.cam.ac.uk"
      },
      "honorificPrefix": "Dr.",
      "knowsAbout": [
        {
          "@type": "Thing",
          "name": "Public Key Infrastructure",
          "sameAs": "https://en.wikipedia.org/wiki/Public_key_infrastructure"
        },
        {
          "@type": "Thing", 
          "name": "Hardware Security Module",
          "sameAs": "https://en.wikipedia.org/wiki/Hardware_security_module"
        },
        {
          "@type": "Thing",
          "name": "Certificate Automation"
        },
        {
          "@type": "Thing",
          "name": "PKCS#11"
        },
        {
          "@type": "Thing",
          "name": "Zero Trust Architecture"
        },
        {
          "@type": "Thing",
          "name": "Operational Models"
        }
      ],
      "award": [
        "Black Hat USA Conference Speaker",
        "DEF CON Conference Speaker"
      ],
      "workExample": [
        {
          "@type": "Organization",
          "name": "Barclays",
          "sameAs": "https://en.wikipedia.org/wiki/Barclays"
        },
        {
          "@type": "Organization",
          "name": "Deutsche Bank",
          "sameAs": "https://en.wikipedia.org/wiki/Deutsche_Bank"
        },
        {
          "@type": "Organization",
          "name": "Sky UK",
          "sameAs": "https://en.wikipedia.org/wiki/Sky_UK"
        },
        {
          "@type": "Organization",
          "name": "TSB Bank PLC (part of Banco Sabadell)",
          "sameAs": "https://en.wikipedia.org/wiki/TSB"
        },
        {
          "@type": "Organization",
          "name": "Comcast",
          "sameAs": "https://en.wikipedia.org/wiki/Comcast"
        }
      ],
      "hasCredential": [
        {
          "@type": "EducationalOccupationalCredential",
          "credentialCategory": "Postdoctoral Research",
          "recognizedBy": {
            "@type": "CollegeOrUniversity",
            "name": "University of Cambridge"
          }
        },
        {
          "@type": "EducationalOccupationalCredential",
          "credentialCategory": "Professor (Docent)",
          "recognizedBy": {
            "@type": "CollegeOrUniversity",
            "name": "Brno University of Technology"
          }
        }
      ]
    },
    "hasOfferCatalog": {
      "@type": "OfferCatalog",
      "name": "Consulting Services",
      "itemListElement": [
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "PKI Architecture Assessment",
            "description": "Comprehensive evaluation of PKI readiness, architecture design, and implementation planning"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service", 
            "name": "HSM Integration Implementation",
            "description": "End-to-end HSM deployment including vendor selection, PKCS#11 integration, and operational procedures"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Certificate Automation Strategy",
            "description": "Multi-tenant PKI design, ACME implementation, and certificate lifecycle automation"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Infrastructure Intelligence - Operational Model",
            "description": "Integration with Asset Management, CMDB, Runbooks, Integrated Network Perimeter (WAF, DoS, DNS, PKI)"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "PKI Rescue Consulting",
            "description": "Emergency response for certificate outages, HSM failures, and PKI implementation problems"
          }
        }
      ]
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "5.0",
      "reviewCount": "12",
      "bestRating": "5"
    }
  }
  </script>
  <!-- End Organization Schema -->

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#certificate-pinning" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Shield Vault" class="md-header__button md-logo" aria-label="Shield Vault" data-md-component="logo">
      
  <img src="../../assets/axon-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Shield Vault
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Certificate Pinning
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Why Certificate Management Matters

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../glossary/" class="md-tabs__link">
        
  
  
    
  
  Glossary

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../quick-start/" class="md-tabs__link">
        
  
  
    
  
  Quick Start Guide

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../technical-guide/" class="md-tabs__link">
        
  
  
    
  
  Foundations for Infrastructure Intelligence - Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../architecture/case-studies/" class="md-tabs__link">
          
  
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../business/cost_of_certificate_management/" class="md-tabs__link">
          
  
  
  Business

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../foundations/certificate-anatomy/" class="md-tabs__link">
          
  
  
  Foundations

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../implementation/acme-protocol-implementation/" class="md-tabs__link">
          
  
  
  Implementation

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../operations/certificate-lifecycle-management/" class="md-tabs__link">
          
  
  
  Operations

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../patterns/ca-hierarchies/" class="md-tabs__link">
          
  
  
  Patterns

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../ca-compromise-scenarios/" class="md-tabs__link">
          
  
  
  Security

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../standards/acme-protocol/" class="md-tabs__link">
          
  
  
  Standards

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../strategy/success-metrics/" class="md-tabs__link">
          
  
  
  Strategy

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../troubleshooting/chain-validation-errors/" class="md-tabs__link">
          
  
  
  Troubleshooting

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../vendors/digicert-certcentral/" class="md-tabs__link">
          
  
  
  Vendors

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Shield Vault" class="md-nav__button md-logo" aria-label="Shield Vault" data-md-component="logo">
      
  <img src="../../assets/axon-logo.png" alt="logo">

    </a>
    Shield Vault
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Why Certificate Management Matters
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Foundations for Infrastructure Intelligence - Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/case-studies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Case Studies - Certificate Management at Scale
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/certificate-as-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate-as-Code
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/mutual-tls-patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mutual TLS Patterns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/service-mesh-certificates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Service Mesh Certificates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/zero-trust-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Zero-Trust Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Business
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Business
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../business/cost_of_certificate_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The $67 Million Risk: Hidden Costs of Manual Certificate Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Foundations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Foundations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/certificate-anatomy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Anatomy
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/cryptographic-primitives/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cryptographic Primitives
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/public-private-key-pairs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Public-Private Key Pairs
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/trust-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trust Models
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../foundations/what-is-pki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    What is PKI?
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Implementation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Implementation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/acme-protocol-implementation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ACME Protocol Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/ca-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CA Architecture
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/certificate-issuance-workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Issuance Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/hsm-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HSM Integration
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/hsm-operational-failures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HSM Operational Failures
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/multi-cloud-pki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Cloud PKI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../implementation/onprem-vs-cloud-hsm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    On-Premises vs Cloud HSM
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/certificate-lifecycle-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Lifecycle Management
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/certificate-rotation-strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Rotation Strategies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/inventory-and-discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inventory and Discovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/monitoring-and-alerting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Monitoring and Alerting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/renewal-automation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Renewal Automation
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Patterns
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/ca-hierarchies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CA Hierarchies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/cloud-vs-on-premises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cloud vs On-Premises
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/high-availability-disaster-recovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    High Availability and Disaster Recovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/multi-tenancy-considerations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Tenancy Considerations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" checked>
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Security
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ca-compromise-scenarios/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CA Compromise Scenarios
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Certificate Pinning
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Certificate Pinning
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-pin-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      Why Pin Certificates?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pinning-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Pinning Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pinning Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-certificate-pinning" class="md-nav__link">
    <span class="md-ellipsis">
      1. Certificate Pinning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-public-key-pinning-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      2. Public Key Pinning (RECOMMENDED)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-certificate-authority-pinning" class="md-nav__link">
    <span class="md-ellipsis">
      3. Certificate Authority Pinning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-multi-pin-strategy-best-practice" class="md-nav__link">
    <span class="md-ellipsis">
      4. Multi-Pin Strategy (BEST PRACTICE)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#platform-specific-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Platform-Specific Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Platform-Specific Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ios-swift" class="md-nav__link">
    <span class="md-ellipsis">
      iOS (Swift)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-kotlin" class="md-nav__link">
    <span class="md-ellipsis">
      Android (Kotlin)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#web-browsers-http-public-key-pinning-deprecated" class="md-nav__link">
    <span class="md-ellipsis">
      Web Browsers (HTTP Public Key Pinning - DEPRECATED)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-requests-library" class="md-nav__link">
    <span class="md-ellipsis">
      Python (requests library)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-rotation-with-pinning" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Rotation with Pinning
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Certificate Rotation with Pinning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-fundamental-challenge" class="md-nav__link">
    <span class="md-ellipsis">
      The Fundamental Challenge
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strategy-1-multiple-pins-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy 1: Multiple Pins (Recommended)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strategy-2-pin-ca-instead-of-leaf" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy 2: Pin CA Instead of Leaf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strategy-3-dynamic-pin-updates" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy 3: Dynamic Pin Updates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strategy-4-expiration-aware-pinning" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy 4: Expiration-Aware Pinning
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operational-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Operational Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operational Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generating-pins" class="md-nav__link">
    <span class="md-ellipsis">
      Generating Pins
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-pinning" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Pinning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-and-alerting" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Alerting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incident-response" class="md-nav__link">
    <span class="md-ellipsis">
      Incident Response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-check-certificate-status" class="md-nav__link">
    <span class="md-ellipsis">
      2. Check Certificate Status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-determine-root-cause" class="md-nav__link">
    <span class="md-ellipsis">
      3. Determine Root Cause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-remediation-actions" class="md-nav__link">
    <span class="md-ellipsis">
      4. Remediation Actions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prevention" class="md-nav__link">
    <span class="md-ellipsis">
      Prevention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prevention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#case-study-3-banking-app-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Case Study 3: Banking App Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools-and-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      Tools and Libraries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tools and Libraries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ios" class="md-nav__link">
    <span class="md-ellipsis">
      iOS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android" class="md-nav__link">
    <span class="md-ellipsis">
      Android
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#web" class="md-nav__link">
    <span class="md-ellipsis">
      Web
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend" class="md-nav__link">
    <span class="md-ellipsis">
      Backend
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      Further Reading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Further Reading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#standards" class="md-nav__link">
    <span class="md-ellipsis">
      Standards
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#documentation" class="md-nav__link">
    <span class="md-ellipsis">
      Documentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#research-papers" class="md-nav__link">
    <span class="md-ellipsis">
      Research Papers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../common-vulnerabilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common Vulnerabilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../compliance-and-audit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compliance and Audit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../incident-response/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Incident Response
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../key-management-best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Key Management Best Practices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../private-key-protection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Private Key Protection
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../threat-models-and-attack-vectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Threat Models and Attack Vectors
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Standards
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            Standards
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/acme-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ACME Protocol
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/ocsp-and-crl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OCSP and CRL
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/pkcs-standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PKCS Standards
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/tls-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TLS Protocol
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/x509-standard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    X.509 Standard
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Strategy
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Strategy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategy/success-metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Success Metrics and KPIs for Certificate Automation
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            Troubleshooting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/chain-validation-errors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chain Validation Errors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/common-misconfigurations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common Misconfigurations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/expired-certificate-outages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Expired Certificate Outages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/performance-bottlenecks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Performance Bottlenecks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Vendors
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            Vendors
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/digicert-certcentral/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DigiCert CertCentral
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/hashicorp-vault-pki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HashiCorp Vault PKI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/keyfactor-command/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Keyfactor Command
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/venafi-platform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Venafi Platform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vendors/vendor-comparison-matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vendor Comparison Matrix
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-pin-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      Why Pin Certificates?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pinning-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Pinning Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pinning Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-certificate-pinning" class="md-nav__link">
    <span class="md-ellipsis">
      1. Certificate Pinning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-public-key-pinning-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      2. Public Key Pinning (RECOMMENDED)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-certificate-authority-pinning" class="md-nav__link">
    <span class="md-ellipsis">
      3. Certificate Authority Pinning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-multi-pin-strategy-best-practice" class="md-nav__link">
    <span class="md-ellipsis">
      4. Multi-Pin Strategy (BEST PRACTICE)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#platform-specific-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Platform-Specific Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Platform-Specific Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ios-swift" class="md-nav__link">
    <span class="md-ellipsis">
      iOS (Swift)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-kotlin" class="md-nav__link">
    <span class="md-ellipsis">
      Android (Kotlin)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#web-browsers-http-public-key-pinning-deprecated" class="md-nav__link">
    <span class="md-ellipsis">
      Web Browsers (HTTP Public Key Pinning - DEPRECATED)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-requests-library" class="md-nav__link">
    <span class="md-ellipsis">
      Python (requests library)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-rotation-with-pinning" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Rotation with Pinning
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Certificate Rotation with Pinning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-fundamental-challenge" class="md-nav__link">
    <span class="md-ellipsis">
      The Fundamental Challenge
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strategy-1-multiple-pins-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy 1: Multiple Pins (Recommended)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strategy-2-pin-ca-instead-of-leaf" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy 2: Pin CA Instead of Leaf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strategy-3-dynamic-pin-updates" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy 3: Dynamic Pin Updates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strategy-4-expiration-aware-pinning" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy 4: Expiration-Aware Pinning
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operational-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Operational Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operational Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generating-pins" class="md-nav__link">
    <span class="md-ellipsis">
      Generating Pins
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-pinning" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Pinning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-and-alerting" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Alerting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incident-response" class="md-nav__link">
    <span class="md-ellipsis">
      Incident Response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-check-certificate-status" class="md-nav__link">
    <span class="md-ellipsis">
      2. Check Certificate Status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-determine-root-cause" class="md-nav__link">
    <span class="md-ellipsis">
      3. Determine Root Cause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-remediation-actions" class="md-nav__link">
    <span class="md-ellipsis">
      4. Remediation Actions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prevention" class="md-nav__link">
    <span class="md-ellipsis">
      Prevention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prevention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#case-study-3-banking-app-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Case Study 3: Banking App Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools-and-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      Tools and Libraries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tools and Libraries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ios" class="md-nav__link">
    <span class="md-ellipsis">
      iOS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android" class="md-nav__link">
    <span class="md-ellipsis">
      Android
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#web" class="md-nav__link">
    <span class="md-ellipsis">
      Web
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend" class="md-nav__link">
    <span class="md-ellipsis">
      Backend
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      Further Reading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Further Reading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#standards" class="md-nav__link">
    <span class="md-ellipsis">
      Standards
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#documentation" class="md-nav__link">
    <span class="md-ellipsis">
      Documentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#research-papers" class="md-nav__link">
    <span class="md-ellipsis">
      Research Papers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WJXPDRF2"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <!-- Right sidebar with disclaimer above TOC -->
  
    <style>
      @media screen and (min-width: 76.25em) {
        .md-sidebar--secondary {
          order: 1;
        }
        .md-sidebar--secondary::before {
          content: '';
          display: block;
          margin-bottom: 1rem;
        }
      }
    </style>
  
  
  
                  



<h1 id="certificate-pinning">Certificate Pinning</h1>
<p><strong>Category</strong>: Security<br />
<strong>Complexity</strong>: Advanced<br />
<strong>Prerequisites</strong>: <a href="../../foundations/certificate-anatomy/">Certificate Anatomy</a>, <a href="../../foundations/trust-models/">Chain Of Trust</a>, <a href="../../standards/tls-protocol/">Tls Protocol</a><br />
<strong>Related</strong>: <a href="../common-vulnerabilities/">Common Vulnerabilities</a>, <a href="../private-key-protection/">Private Key Protection</a>, <a href="../../foundations/trust-models/">Trust Models</a></p>
<hr />
<h2 id="overview">Overview</h2>
<p>Certificate pinning is a security technique where applications explicitly trust specific certificates or public keys rather than relying solely on the system's trust store. This hardens security by preventing man-in-the-middle (MITM) attacks even when an attacker has compromised a Certificate Authority or installed rogue root certificates on the device.</p>
<h3 id="why-pin-certificates">Why Pin Certificates?</h3>
<p><strong>Traditional TLS validation weaknesses</strong>:</p>
<ul>
<li>Any CA in the trust store can issue certificates for any domain</li>
<li>~100+ root CAs trusted by default on most systems</li>
<li>Compromise of any single CA threatens all connections</li>
<li>Government-backed CAs may issue certificates for surveillance</li>
<li>Rogue certificates have been issued (DigiNotar 2011, CNNIC 2015)</li>
</ul>
<p><strong>Pinning provides defense-in-depth</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Normal TLS:
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>  App  System Trust Store (100+ CAs)  Accept any valid certificate
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>With Pinning:
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>  App  Built-in pins  Only accept specific certificates/keys
</code></pre></div></p>
<h2 id="pinning-strategies">Pinning Strategies</h2>
<h3 id="1-certificate-pinning">1. Certificate Pinning</h3>
<p>Pin the entire certificate (including validity dates and signature).</p>
<p><strong>Advantages</strong>:</p>
<ul>
<li>Simple to implement</li>
<li>Exact match required</li>
<li>No ambiguity</li>
</ul>
<p><strong>Disadvantages</strong>:</p>
<ul>
<li>Requires app update when certificate expires</li>
<li>Inflexible for certificate rotation</li>
<li>High operational burden</li>
</ul>
<p><strong>Implementation</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Set</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">CertificatePinner</span><span class="p">:</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="sd">    Pin entire certificates by their SHA-256 hash</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pinned_certs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="sd">        Args:</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="sd">            pinned_certs: Set of SHA-256 hashes of DER-encoded certificates</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinned_certs</span> <span class="o">=</span> <span class="n">pinned_certs</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert_der</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="sd">        Verify certificate matches one of the pins</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>        <span class="n">cert_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">cert_der</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>        <span class="k">if</span> <span class="n">cert_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_certs</span><span class="p">:</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>                <span class="sa">f</span><span class="s2">&quot;Certificate hash </span><span class="si">{</span><span class="n">cert_hash</span><span class="si">}</span><span class="s2"> not in pinned set. &quot;</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>                <span class="sa">f</span><span class="s2">&quot;Expected one of: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pinned_certs</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>            <span class="p">)</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="c1"># Usage in application</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="n">API_CERT_PINS</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>    <span class="c1"># Production certificate (expires 2025-12-31)</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>    <span class="s2">&quot;e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&quot;</span><span class="p">,</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>    <span class="c1"># Backup certificate (expires 2026-06-30)</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>    <span class="s2">&quot;d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35&quot;</span><span class="p">,</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="p">}</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="n">pinner</span> <span class="o">=</span> <span class="n">CertificatePinner</span><span class="p">(</span><span class="n">API_CERT_PINS</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="2-public-key-pinning-recommended">2. Public Key Pinning (RECOMMENDED)</h3>
<p>Pin the public key component only, ignoring certificate metadata.</p>
<p><strong>Advantages</strong>:</p>
<ul>
<li>Survives certificate renewal (same key pair)</li>
<li>More flexible for operations</li>
<li>Recommended by OWASP</li>
<li>Can pin intermediate or root CA keys</li>
</ul>
<p><strong>Disadvantages</strong>:</p>
<ul>
<li>Slightly more complex to extract public key</li>
<li>Must still rotate when keys change</li>
</ul>
<p><strong>Implementation</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography</span><span class="w"> </span><span class="kn">import</span> <span class="n">x509</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.backends</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_backend</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">PublicKeyPinner</span><span class="p">:</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="sd">    Pin Subject Public Key Info (SPKI) using SHA-256</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pinned_spki_hashes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="sd">        Args:</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="sd">            pinned_spki_hashes: Set of base64-encoded SHA-256 hashes of SPKI</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinned_spki_hashes</span> <span class="o">=</span> <span class="n">pinned_spki_hashes</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">extract_spki_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert_der</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="sd">        Extract and hash the Subject Public Key Info from certificate</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>        <span class="n">cert</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_der_x509_certificate</span><span class="p">(</span><span class="n">cert_der</span><span class="p">,</span> <span class="n">default_backend</span><span class="p">())</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>        <span class="c1"># Get public key</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>        <span class="n">public_key</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>        <span class="c1"># Serialize to SubjectPublicKeyInfo format</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>        <span class="n">spki_der</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>            <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">DER</span><span class="p">,</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>            <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PublicFormat</span><span class="o">.</span><span class="n">SubjectPublicKeyInfo</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>        <span class="p">)</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>        <span class="c1"># Hash and base64 encode</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>        <span class="n">spki_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">spki_der</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">spki_hash</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert_der</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="sd">        Verify certificate&#39;s public key matches one of the pins</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>        <span class="n">spki_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_spki_hash</span><span class="p">(</span><span class="n">cert_der</span><span class="p">)</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>        <span class="k">if</span> <span class="n">spki_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_spki_hashes</span><span class="p">:</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>                <span class="sa">f</span><span class="s2">&quot;Public key hash </span><span class="si">{</span><span class="n">spki_hash</span><span class="si">}</span><span class="s2"> not in pinned set. &quot;</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>                <span class="sa">f</span><span class="s2">&quot;This could indicate a MITM attack or certificate change.&quot;</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>            <span class="p">)</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a><span class="c1"># Usage - pins that survive certificate renewal</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a><span class="n">API_SPKI_PINS</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>    <span class="c1"># Primary key (used across multiple certificate renewals)</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>    <span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">,</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>    <span class="c1"># Backup key (for emergency rotation)</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>    <span class="s2">&quot;58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=&quot;</span><span class="p">,</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>    <span class="c1"># CA public key (pin the issuer for additional security)</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>    <span class="s2">&quot;hI0z9TjTa9Xq+PnBW4J9vKvp+Pq8dqLRFzXsLxJwXqI=&quot;</span><span class="p">,</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a><span class="p">}</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a><span class="n">pinner</span> <span class="o">=</span> <span class="n">PublicKeyPinner</span><span class="p">(</span><span class="n">API_SPKI_PINS</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="3-certificate-authority-pinning">3. Certificate Authority Pinning</h3>
<p>Pin the intermediate or root CA certificate/key.</p>
<p><strong>Advantages</strong>:</p>
<ul>
<li>No updates needed for individual certificate rotation</li>
<li>Reasonable security improvement</li>
<li>Lower operational burden</li>
</ul>
<p><strong>Disadvantages</strong>:</p>
<ul>
<li>Less protection than endpoint pinning</li>
<li>Still vulnerable if CA is compromised</li>
<li>Doesn't protect against CA mis-issuance</li>
</ul>
<p><strong>Use case</strong>: Balance between security and operational flexibility.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CAPinner</span><span class="p">:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="sd">    Pin Certificate Authority public keys</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ca_spki_hashes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ca_spki_hashes</span> <span class="o">=</span> <span class="n">ca_spki_hashes</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert_chain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="sd">        Verify at least one certificate in chain has pinned key</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="sd">        Args:</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="sd">            cert_chain: List of DER-encoded certificates from leaf to root</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>        <span class="n">pinner</span> <span class="o">=</span> <span class="n">PublicKeyPinner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_spki_hashes</span><span class="p">)</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="c1"># Check each certificate in chain</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>        <span class="k">for</span> <span class="n">cert_der</span> <span class="ow">in</span> <span class="n">cert_chain</span><span class="p">:</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>                <span class="n">spki_hash</span> <span class="o">=</span> <span class="n">pinner</span><span class="o">.</span><span class="n">extract_spki_hash</span><span class="p">(</span><span class="n">cert_der</span><span class="p">)</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>                <span class="k">if</span> <span class="n">spki_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca_spki_hashes</span><span class="p">:</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>                    <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>                <span class="k">continue</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>        <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>            <span class="s2">&quot;No certificate in chain matches pinned CA keys. &quot;</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>            <span class="s2">&quot;Chain may be compromised or using unexpected CA.&quot;</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>        <span class="p">)</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="c1"># Pin your organization&#39;s CA</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="n">INTERNAL_CA_PINS</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>    <span class="c1"># Internal Root CA</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>    <span class="s2">&quot;r/mIkG3eEpVdm+u/ko/cwxzOMo1bk4TyHIlByibiA5E=&quot;</span><span class="p">,</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>    <span class="c1"># Internal Intermediate CA</span>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>    <span class="s2">&quot;YLh1dUR9y6Kja30RrAn7JKnbQG/uEtLMkBgFF2Fuihg=&quot;</span><span class="p">,</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a><span class="p">}</span>
</code></pre></div>
<h3 id="4-multi-pin-strategy-best-practice">4. Multi-Pin Strategy (BEST PRACTICE)</h3>
<p>Combine multiple pins for defense-in-depth and operational flexibility.</p>
<p><strong>Pin multiple points in the trust chain</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MultiPinValidator</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="sd">    Validate certificate chain against multiple pin types</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PinningConfig</span><span class="p">):</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert_chain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="sd">        Validate using multiple pinning strategies</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>            <span class="s1">&#39;leaf_pin&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>            <span class="s1">&#39;intermediate_pin&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>            <span class="s1">&#39;root_pin&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        <span class="p">}</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="c1"># Extract leaf, intermediate, and root</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        <span class="n">leaf_cert</span> <span class="o">=</span> <span class="n">cert_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="n">intermediate_certs</span> <span class="o">=</span> <span class="n">cert_chain</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="n">root_cert</span> <span class="o">=</span> <span class="n">cert_chain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cert_chain</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>        <span class="c1"># Check leaf certificate pin</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">leaf_pins</span><span class="p">:</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>            <span class="n">leaf_spki</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_spki_hash</span><span class="p">(</span><span class="n">leaf_cert</span><span class="p">)</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;leaf_pin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">leaf_spki</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">leaf_pins</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>        <span class="c1"># Check intermediate certificate pins</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">intermediate_pins</span> <span class="ow">and</span> <span class="n">intermediate_certs</span><span class="p">:</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>            <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="n">intermediate_certs</span><span class="p">:</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>                <span class="n">inter_spki</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_spki_hash</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>                <span class="k">if</span> <span class="n">inter_spki</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">intermediate_pins</span><span class="p">:</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;intermediate_pin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>                    <span class="k">break</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="c1"># Check root certificate pin</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root_pins</span> <span class="ow">and</span> <span class="n">root_cert</span><span class="p">:</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>            <span class="n">root_spki</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_spki_hash</span><span class="p">(</span><span class="n">root_cert</span><span class="p">)</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;root_pin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_spki</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root_pins</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>        <span class="c1"># Apply validation policy</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_policy</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="sd">        Apply pinning policy (e.g., require leaf OR intermediate pin)</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">policy</span> <span class="o">==</span> <span class="s1">&#39;strict&#39;</span><span class="p">:</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>            <span class="c1"># Require leaf pin AND (intermediate OR root) pin</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>            <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;leaf_pin&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;intermediate_pin&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;root_pin&#39;</span><span class="p">]</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>            <span class="p">)</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">policy</span> <span class="o">==</span> <span class="s1">&#39;balanced&#39;</span><span class="p">:</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>            <span class="c1"># Require any two pins to match</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="mi">2</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">policy</span> <span class="o">==</span> <span class="s1">&#39;flexible&#39;</span><span class="p">:</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>            <span class="c1"># Require at least one pin to match</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown policy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">policy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a><span class="c1"># Configuration example</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a><span class="n">config</span> <span class="o">=</span> <span class="n">PinningConfig</span><span class="p">(</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>    <span class="n">leaf_pins</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>        <span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">,</span>  <span class="c1"># Primary</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>        <span class="s2">&quot;58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=&quot;</span><span class="p">,</span>  <span class="c1"># Backup</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>    <span class="p">},</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>    <span class="n">intermediate_pins</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>        <span class="s2">&quot;YLh1dUR9y6Kja30RrAn7JKnbQG/uEtLMkBgFF2Fuihg=&quot;</span><span class="p">,</span>  <span class="c1"># Your CA</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>    <span class="p">},</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>    <span class="n">root_pins</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>        <span class="s2">&quot;r/mIkG3eEpVdm+u/ko/cwxzOMo1bk4TyHIlByibiA5E=&quot;</span><span class="p">,</span>  <span class="c1"># Your Root CA</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>    <span class="p">},</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>    <span class="n">policy</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>  <span class="c1"># Any two pins must match</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a><span class="p">)</span>
</code></pre></div></p>
<h2 id="platform-specific-implementation">Platform-Specific Implementation</h2>
<h3 id="ios-swift">iOS (Swift)</h3>
<p><strong>Using <code>NSPinnedDomains</code> in <code>Info.plist</code></strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="cp">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; </span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="cp">          &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="nt">&lt;plist</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="nt">&lt;dict&gt;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="nt">&lt;key&gt;</span>NSAppTransportSecurity<span class="nt">&lt;/key&gt;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="nt">&lt;dict&gt;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">        </span><span class="nt">&lt;key&gt;</span>NSPinnedDomains<span class="nt">&lt;/key&gt;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">        </span><span class="nt">&lt;dict&gt;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">            </span><span class="nt">&lt;key&gt;</span>api.example.com<span class="nt">&lt;/key&gt;</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">            </span><span class="nt">&lt;dict&gt;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">                </span><span class="nt">&lt;key&gt;</span>NSIncludesSubdomains<span class="nt">&lt;/key&gt;</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">                </span><span class="nt">&lt;true/&gt;</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">                </span><span class="nt">&lt;key&gt;</span>NSPinnedLeafIdentities<span class="nt">&lt;/key&gt;</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">                </span><span class="nt">&lt;array&gt;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">                    </span><span class="nt">&lt;dict&gt;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">                        </span><span class="nt">&lt;key&gt;</span>SPKI-SHA256-BASE64<span class="nt">&lt;/key&gt;</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">                        </span><span class="nt">&lt;string&gt;</span>X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=<span class="nt">&lt;/string&gt;</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">                    </span><span class="nt">&lt;/dict&gt;</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">                    </span><span class="nt">&lt;dict&gt;</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">                        </span><span class="nt">&lt;key&gt;</span>SPKI-SHA256-BASE64<span class="nt">&lt;/key&gt;</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="w">                        </span><span class="nt">&lt;string&gt;</span>58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=<span class="nt">&lt;/string&gt;</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="w">                    </span><span class="nt">&lt;/dict&gt;</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">                </span><span class="nt">&lt;/array&gt;</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="w">                </span><span class="nt">&lt;key&gt;</span>NSPinnedCAIdentities<span class="nt">&lt;/key&gt;</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="w">                </span><span class="nt">&lt;array&gt;</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="w">                    </span><span class="nt">&lt;dict&gt;</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">                        </span><span class="nt">&lt;key&gt;</span>SPKI-SHA256-BASE64<span class="nt">&lt;/key&gt;</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="w">                        </span><span class="nt">&lt;string&gt;</span>YLh1dUR9y6Kja30RrAn7JKnbQG/uEtLMkBgFF2Fuihg=<span class="nt">&lt;/string&gt;</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a><span class="w">                    </span><span class="nt">&lt;/dict&gt;</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="w">                </span><span class="nt">&lt;/array&gt;</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a><span class="w">            </span><span class="nt">&lt;/dict&gt;</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="w">        </span><span class="nt">&lt;/dict&gt;</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a><span class="w">    </span><span class="nt">&lt;/dict&gt;</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="nt">&lt;/dict&gt;</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a><span class="nt">&lt;/plist&gt;</span>
</code></pre></div></p>
<p><strong>Manual implementation with <code>URLSession</code></strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kd">import</span><span class="w"> </span><span class="nc">Foundation</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kd">import</span><span class="w"> </span><span class="nc">Security</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kd">class</span><span class="w"> </span><span class="nc">CertificatePinner</span><span class="p">:</span><span class="w"> </span><span class="bp">NSObject</span><span class="p">,</span><span class="w"> </span><span class="n">URLSessionDelegate</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="c1">// SHA-256 hashes of pinned public keys (base64 encoded)</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">pinnedKeys</span><span class="p">:</span><span class="w"> </span><span class="n">Set</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">&gt;</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">        </span><span class="s">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">,</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">        </span><span class="s">&quot;58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=&quot;</span><span class="p">,</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span><span class="kd">func</span><span class="w"> </span><span class="nf">urlSession</span><span class="p">(</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">        </span><span class="kc">_</span><span class="w"> </span><span class="n">session</span><span class="p">:</span><span class="w"> </span><span class="n">URLSession</span><span class="p">,</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">        </span><span class="n">didReceive</span><span class="w"> </span><span class="n">challenge</span><span class="p">:</span><span class="w"> </span><span class="n">URLAuthenticationChallenge</span><span class="p">,</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">        </span><span class="n">completionHandler</span><span class="p">:</span><span class="w"> </span><span class="p">@</span><span class="n">escaping</span><span class="w"> </span><span class="p">(</span><span class="n">URLSession</span><span class="p">.</span><span class="n">AuthChallengeDisposition</span><span class="p">,</span><span class="w"> </span><span class="n">URLCredential</span><span class="p">?)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Void</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">        </span><span class="c1">// Only handle server trust challenges</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">        </span><span class="k">guard</span><span class="w"> </span><span class="n">challenge</span><span class="p">.</span><span class="n">protectionSpace</span><span class="p">.</span><span class="n">authenticationMethod</span><span class="w"> </span><span class="p">==</span><span class="w"> </span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">              </span><span class="n">NSURLAuthenticationMethodServerTrust</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">            </span><span class="n">completionHandler</span><span class="p">(.</span><span class="n">performDefaultHandling</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">            </span><span class="k">return</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">        </span><span class="k">guard</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">serverTrust</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">challenge</span><span class="p">.</span><span class="n">protectionSpace</span><span class="p">.</span><span class="n">serverTrust</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">            </span><span class="n">completionHandler</span><span class="p">(.</span><span class="n">cancelAuthenticationChallenge</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">            </span><span class="k">return</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="w">        </span><span class="c1">// Validate pin</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">validatePins</span><span class="p">(</span><span class="n">serverTrust</span><span class="p">:</span><span class="w"> </span><span class="n">serverTrust</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nv">credential</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">URLCredential</span><span class="p">(</span><span class="n">trust</span><span class="p">:</span><span class="w"> </span><span class="n">serverTrust</span><span class="p">)</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="w">            </span><span class="n">completionHandler</span><span class="p">(.</span><span class="n">useCredential</span><span class="p">,</span><span class="w"> </span><span class="n">credential</span><span class="p">)</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="w">            </span><span class="c1">// Pin validation failed - reject connection</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">            </span><span class="n">completionHandler</span><span class="p">(.</span><span class="n">cancelAuthenticationChallenge</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">func</span><span class="w"> </span><span class="nf">validatePins</span><span class="p">(</span><span class="n">serverTrust</span><span class="p">:</span><span class="w"> </span><span class="n">SecTrust</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="w">        </span><span class="c1">// Get certificate chain</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nv">certificateCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SecTrustGetCertificateCount</span><span class="p">(</span><span class="n">serverTrust</span><span class="p">)</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="w">        </span><span class="c1">// Check each certificate in chain</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.</span><span class="p">.&lt;</span><span class="n">certificateCount</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span class="w">            </span><span class="k">guard</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">certificate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SecTrustGetCertificateAtIndex</span><span class="p">(</span><span class="n">serverTrust</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="w">                </span><span class="k">continue</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a><span class="w">            </span><span class="c1">// Extract public key</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a><span class="w">            </span><span class="k">guard</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">publicKey</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SecCertificateCopyKey</span><span class="p">(</span><span class="n">certificate</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a><span class="w">                </span><span class="k">continue</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a><span class="w">            </span><span class="c1">// Get public key data</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a><span class="w">            </span><span class="k">guard</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">publicKeyData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SecKeyCopyExternalRepresentation</span><span class="p">(</span><span class="n">publicKey</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Data</span><span class="p">?</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a><span class="w">                </span><span class="k">continue</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a><span class="w">            </span><span class="c1">// Hash the public key</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nv">publicKeyHash</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sha256</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">publicKeyData</span><span class="p">)</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nv">publicKeyHashBase64</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">publicKeyHash</span><span class="p">.</span><span class="n">base64EncodedString</span><span class="p">()</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a><span class="w">            </span><span class="c1">// Check if this key is pinned</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">pinnedKeys</span><span class="p">.</span><span class="bp">contains</span><span class="p">(</span><span class="n">publicKeyHashBase64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">func</span><span class="w"> </span><span class="nf">sha256</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">Data</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nv">hash</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="nb">UInt8</span><span class="p">](</span><span class="n">repeating</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="bp">count</span><span class="p">:</span><span class="w"> </span><span class="nb">Int</span><span class="p">(</span><span class="n">CC_SHA256_DIGEST_LENGTH</span><span class="p">))</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a><span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="n">withUnsafeBytes</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a><span class="w">            </span><span class="kc">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">CC_SHA256</span><span class="p">(</span><span class="nv">$0</span><span class="p">.</span><span class="n">baseAddress</span><span class="p">,</span><span class="w"> </span><span class="n">CC_LONG</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="bp">count</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="n">hash</span><span class="p">)</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Data</span><span class="p">(</span><span class="n">hash</span><span class="p">)</span>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a><span class="p">}</span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a><span class="c1">// Usage</span>
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a><span class="kd">let</span><span class="w"> </span><span class="nv">pinner</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">CertificatePinner</span><span class="p">()</span>
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a><span class="kd">let</span><span class="w"> </span><span class="nv">sessionConfig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">URLSessionConfiguration</span><span class="p">.</span><span class="k">default</span>
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a><span class="kd">let</span><span class="w"> </span><span class="nv">session</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">URLSession</span><span class="p">(</span>
<a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a><span class="w">    </span><span class="n">configuration</span><span class="p">:</span><span class="w"> </span><span class="n">sessionConfig</span><span class="p">,</span>
<a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a><span class="w">    </span><span class="n">delegate</span><span class="p">:</span><span class="w"> </span><span class="n">pinner</span><span class="p">,</span>
<a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a><span class="w">    </span><span class="n">delegateQueue</span><span class="p">:</span><span class="w"> </span><span class="kc">nil</span>
<a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a><span class="p">)</span>
</code></pre></div></p>
<h3 id="android-kotlin">Android (Kotlin)</h3>
<p><strong>Declarative pinning with Network Security Configuration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="cm">&lt;!-- res/xml/network_security_config.xml --&gt;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="nt">&lt;network-security-config&gt;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="cm">&lt;!-- Pin specific domain --&gt;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="nt">&lt;domain-config&gt;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">        </span><span class="nt">&lt;domain</span><span class="w"> </span><span class="na">includeSubdomains=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>api.example.com<span class="nt">&lt;/domain&gt;</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">        </span><span class="nt">&lt;pin-set</span><span class="w"> </span><span class="na">expiration=</span><span class="s">&quot;2025-12-31&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">            </span><span class="cm">&lt;!-- Primary key --&gt;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">            </span><span class="nt">&lt;pin</span><span class="w"> </span><span class="na">digest=</span><span class="s">&quot;SHA-256&quot;</span><span class="nt">&gt;</span>X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=<span class="nt">&lt;/pin&gt;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">            </span><span class="cm">&lt;!-- Backup key --&gt;</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">            </span><span class="nt">&lt;pin</span><span class="w"> </span><span class="na">digest=</span><span class="s">&quot;SHA-256&quot;</span><span class="nt">&gt;</span>58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=<span class="nt">&lt;/pin&gt;</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">            </span><span class="cm">&lt;!-- CA key for flexibility --&gt;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">            </span><span class="nt">&lt;pin</span><span class="w"> </span><span class="na">digest=</span><span class="s">&quot;SHA-256&quot;</span><span class="nt">&gt;</span>YLh1dUR9y6Kja30RrAn7JKnbQG/uEtLMkBgFF2Fuihg=<span class="nt">&lt;/pin&gt;</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">        </span><span class="nt">&lt;/pin-set&gt;</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="nt">&lt;/domain-config&gt;</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="nt">&lt;/network-security-config&gt;</span>
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="cm">&lt;!-- AndroidManifest.xml --&gt;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nt">&lt;application</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="na">android:networkSecurityConfig=</span><span class="s">&quot;@xml/network_security_config&quot;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="err">...</span><span class="nt">&gt;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="nt">&lt;/application&gt;</span>
</code></pre></div>
<p><strong>Programmatic pinning with OkHttp</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">import</span><span class="w"> </span><span class="nn">okhttp3.CertificatePinner</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">import</span><span class="w"> </span><span class="nn">okhttp3.OkHttpClient</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="kd">class</span><span class="w"> </span><span class="nc">SecureApiClient</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">certificatePinner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CertificatePinner</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">        </span><span class="p">.</span><span class="na">add</span><span class="p">(</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">            </span><span class="s">&quot;api.example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">            </span><span class="s">&quot;sha256/X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// Primary</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">            </span><span class="s">&quot;sha256/58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// Backup</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">            </span><span class="s">&quot;sha256/YLh1dUR9y6Kja30RrAn7JKnbQG/uEtLMkBgFF2Fuihg=&quot;</span><span class="w">   </span><span class="c1">// CA</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">        </span><span class="p">)</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OkHttpClient</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">        </span><span class="p">.</span><span class="na">certificatePinner</span><span class="p">(</span><span class="n">certificatePinner</span><span class="p">)</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">makeSecureRequest</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">):</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Request</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">            </span><span class="p">.</span><span class="na">url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">            </span><span class="n">client</span><span class="p">.</span><span class="na">newCall</span><span class="p">(</span><span class="n">request</span><span class="p">).</span><span class="na">execute</span><span class="p">().</span><span class="na">use</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">-&gt;</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="p">.</span><span class="na">isSuccessful</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;Unexpected response: </span><span class="si">$</span><span class="n">response</span><span class="s">&quot;</span><span class="p">)</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">                </span><span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="o">?.</span><span class="na">string</span><span class="p">()</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">SSLPeerUnverifiedException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">            </span><span class="c1">// Certificate pinning failure</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="s">&quot;SecureApi&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Certificate pinning failed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="s">&quot;Certificate validation failed - possible MITM attack&quot;</span><span class="p">)</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="web-browsers-http-public-key-pinning-deprecated">Web Browsers (HTTP Public Key Pinning - DEPRECATED)</h3>
<p><strong>WARNING</strong>: HPKP is deprecated and removed from modern browsers due to operational risks.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="err"># DO NOT USE - Shown for historical context only</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="err">Public-Key-Pins: </span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="err">    pin-sha256=&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;; </span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="err">    pin-sha256=&quot;58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=&quot;; </span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="err">    max-age=5184000; </span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="err">    includeSubDomains</span>
</code></pre></div>
<p><strong>Why HPKP was deprecated</strong>:</p>
<ul>
<li>Pin misconfiguration could permanently break websites</li>
<li>No safe recovery mechanism if all pinned keys lost</li>
<li>Limited adoption due to risk</li>
<li>Better alternatives (Certificate Transparency, Expect-CT)</li>
</ul>
<p><strong>Modern alternative - Certificate Transparency</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="err">Expect-CT: max-age=86400, enforce, report-uri=&quot;https://example.com/ct-report&quot;</span>
</code></pre></div></p>
<h3 id="python-requests-library">Python (requests library)</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">requests.adapters</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPAdapter</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">urllib3.util.ssl_</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_urllib3_context</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">PinnedHTTPAdapter</span><span class="p">(</span><span class="n">HTTPAdapter</span><span class="p">):</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="sd">    HTTP adapter that validates certificate pins</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pinned_spki_hashes</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinned_spki_hashes</span> <span class="o">=</span> <span class="n">pinned_spki_hashes</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_poolmanager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        <span class="c1"># Create SSL context with custom verification</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">create_urllib3_context</span><span class="p">()</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>        <span class="n">context</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>        <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        <span class="c1"># Store original verify function</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>        <span class="n">original_verify</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">check_hostname</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>        <span class="c1"># Wrap with pin verification</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">verify_with_pins</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>            <span class="c1"># First do normal verification</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">original_verify</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>            <span class="c1"># Then verify pins</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_pins</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>        <span class="n">context</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="n">verify_with_pins</span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ssl_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init_poolmanager</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_verify_pins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert</span><span class="p">):</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a><span class="sd">        Verify certificate&#39;s SPKI hash against pins</span>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>        <span class="c1"># Extract SPKI and hash it</span>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">cryptography</span><span class="w"> </span><span class="kn">import</span> <span class="n">x509</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.backends</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_backend</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>        <span class="n">cert_obj</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_der_x509_certificate</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">default_backend</span><span class="p">())</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>        <span class="n">public_key</span> <span class="o">=</span> <span class="n">cert_obj</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>        <span class="n">spki_der</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>            <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">DER</span><span class="p">,</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>            <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PublicFormat</span><span class="o">.</span><span class="n">SubjectPublicKeyInfo</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>        <span class="p">)</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>        <span class="n">spki_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">spki_der</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>        <span class="n">spki_hash_b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">spki_hash</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>        <span class="k">if</span> <span class="n">spki_hash_b64</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_spki_hashes</span><span class="p">:</span>
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>            <span class="k">raise</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">(</span>
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>                <span class="sa">f</span><span class="s2">&quot;Certificate pin validation failed. &quot;</span>
<a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a>                <span class="sa">f</span><span class="s2">&quot;Expected one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pinned_spki_hashes</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a>                <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">spki_hash_b64</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a>            <span class="p">)</span>
<a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>
<a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a>
<a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a><span class="c1"># Usage</span>
<a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a><span class="n">pinned_hashes</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a>    <span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">,</span>
<a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a>    <span class="s2">&quot;58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=&quot;</span><span class="p">,</span>
<a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a><span class="p">}</span>
<a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a>
<a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a><span class="n">session</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">,</span> <span class="n">PinnedHTTPAdapter</span><span class="p">(</span><span class="n">pinned_hashes</span><span class="p">))</span>
<a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a>
<a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a><span class="c1"># Make pinned requests</span>
<a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a><span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/data&#39;</span><span class="p">)</span>
</code></pre></div>
<h2 id="certificate-rotation-with-pinning">Certificate Rotation with Pinning</h2>
<h3 id="the-fundamental-challenge">The Fundamental Challenge</h3>
<p>Certificate pinning creates an operational challenge: how do you rotate certificates without breaking deployed applications?</p>
<p><strong>The problem</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>Day 0:  Deploy app with pinned certificate (expires in 1 year)
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>Day 365: Certificate expires
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>Day 366: All apps stop working until users update
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>Result: Service outage for users who haven&#39;t updated
</code></pre></div></p>
<h3 id="strategy-1-multiple-pins-recommended">Strategy 1: Multiple Pins (Recommended)</h3>
<p>Always pin at least 2 keys: current and future.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">RotationFriendlyPinner</span><span class="p">:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="sd">    Pinner designed for graceful rotation</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>        <span class="c1"># Always maintain current + next key</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pins</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>            <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">,</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>            <span class="s1">&#39;next&#39;</span><span class="p">:</span> <span class="s2">&quot;58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=&quot;</span><span class="p">,</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>        <span class="p">}</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spki_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Accept any pinned key&quot;&quot;&quot;</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>        <span class="k">return</span> <span class="n">spki_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="c1"># Rotation process:</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="c1"># 1. Deploy app with pins: [current, next]</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="c1"># 2. When ready to rotate:</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="c1">#    a. Issue new certificate using &#39;next&#39; key</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="c1">#    b. Generate new &#39;next+1&#39; key</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="c1">#    c. Deploy app update with pins: [next, next+1]</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="c1">#    d. Old apps still work (they accept &#39;next&#39; key)</span>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="c1"># 3. After sufficient adoption, old key can be retired</span>
</code></pre></div>
<p><strong>Rotation timeline</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>Month 0:  App v1.0 released
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>          Pins: [Key-A, Key-B]
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>          Server uses: Key-A
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>Month 11: App v1.1 released  
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>          Pins: [Key-B, Key-C]
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>          Server uses: Key-A (still works for v1.0 and v1.1)
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>Month 12: Sufficient adoption of v1.1 (e.g., 80%)
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>          Server rotates to: Key-B
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>          v1.0 and v1.1 both work
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>Month 23: App v1.2 released
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>          Pins: [Key-C, Key-D]
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>          Server uses: Key-B
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>Month 24: High adoption of v1.2
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>          Server rotates to: Key-C
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>          v1.0 stops working (acceptable - 1 year old)
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>          v1.1 and v1.2 work
</code></pre></div></p>
<h3 id="strategy-2-pin-ca-instead-of-leaf">Strategy 2: Pin CA Instead of Leaf</h3>
<p>Pin the CA certificate, avoiding need to update pins for each rotation.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># Pin your organization&#39;s CA</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">CA_PINS</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="s2">&quot;YLh1dUR9y6Kja30RrAn7JKnbQG/uEtLMkBgFF2Fuihg=&quot;</span><span class="p">,</span>  <span class="c1"># Internal CA</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="p">}</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="c1"># Leaf certificates can rotate freely as long as issued by pinned CA</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="c1"># Trade-off: Less security than leaf pinning</span>
</code></pre></div>
<h3 id="strategy-3-dynamic-pin-updates">Strategy 3: Dynamic Pin Updates</h3>
<p>Update pins dynamically via secure channel.</p>
<p><strong>WARNING</strong>: This approach has security implications.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">DynamicPinner</span><span class="p">:</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="sd">    Update pins from server (use with extreme caution)</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bootstrap_pins</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pins</span> <span class="o">=</span> <span class="n">bootstrap_pins</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pin_update_url</span> <span class="o">=</span> <span class="s2">&quot;https://api.example.com/.well-known/pin-updates&quot;</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_pins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="sd">        Fetch new pins from server</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="sd">        CRITICAL: This request must itself be pinned to bootstrap pins</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>        <span class="c1"># Use bootstrap pins for this request</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">PinnedSession</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_update_url</span><span class="p">)</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>            <span class="c1"># Response must be signed by trusted key</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>            <span class="n">pin_update</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_signature</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>            <span class="c1"># Validate new pins</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_pin_update</span><span class="p">(</span><span class="n">pin_update</span><span class="p">):</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pin_update</span><span class="p">[</span><span class="s1">&#39;new_pins&#39;</span><span class="p">])</span>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>                <span class="c1"># Persist to local storage</span>
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_pins</span><span class="p">()</span>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_pin_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a><span class="sd">        Validate pin update for security</span>
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>        <span class="c1"># Must always include at least one current pin</span>
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span> <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;new_pins&#39;</span><span class="p">]):</span>
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span>
<a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>                <span class="s2">&quot;Pin update must include at least one current pin&quot;</span>
<a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>            <span class="p">)</span>
<a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>
<a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>        <span class="c1"># Must not remove all pins</span>
<a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">update</span><span class="p">[</span><span class="s1">&#39;new_pins&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">&quot;Cannot remove all pins&quot;</span><span class="p">)</span>
<a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>
<a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>        <span class="c1"># Signature must be valid</span>
<a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;signature_valid&#39;</span><span class="p">]:</span>
<a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">&quot;Invalid signature on pin update&quot;</span><span class="p">)</span>
<a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>
<a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p><strong>Risks of dynamic updates</strong>:</p>
<ul>
<li>If update mechanism is compromised, attacker can inject pins</li>
<li>Creates additional attack surface</li>
<li>Defeats purpose of pinning if not carefully implemented</li>
<li>
<p>Only use if combined with:</p>
</li>
<li>
<p>Digital signatures on updates</p>
</li>
<li>Never removing all existing pins</li>
<li>Rate limiting and anomaly detection</li>
</ul>
<h3 id="strategy-4-expiration-aware-pinning">Strategy 4: Expiration-Aware Pinning</h3>
<p>Build expiration awareness into the app.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExpirationAwarePinner</span><span class="p">:</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="sd">    Gracefully handle pin expiration</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pins</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>            <span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>                <span class="s1">&#39;expires&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>            <span class="p">},</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>            <span class="s2">&quot;58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>                <span class="s1">&#39;expires&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2026</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;future&#39;</span><span class="p">,</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>            <span class="p">},</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>        <span class="p">}</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spki_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="sd">        Validate pin with expiration awareness</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>        <span class="k">if</span> <span class="n">spki_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>        <span class="n">pin_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">[</span><span class="n">spki_hash</span><span class="p">]</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a>        <span class="c1"># Check expiration</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">pin_info</span><span class="p">[</span><span class="s1">&#39;expires&#39;</span><span class="p">]:</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>            <span class="c1"># Pin has expired</span>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_enforce_after_expiration</span><span class="p">():</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>                <span class="c1"># Strict mode - reject</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>                <span class="c1"># Grace period - accept but warn</span>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a>                    <span class="sa">f</span><span class="s2">&quot;Using expired pin </span><span class="si">{</span><span class="n">spki_hash</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>                    <span class="sa">f</span><span class="s2">&quot;Expired: </span><span class="si">{</span><span class="n">pin_info</span><span class="p">[</span><span class="s1">&#39;expires&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a>                <span class="p">)</span>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">should_enforce_after_expiration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a><span class="sd">        Decide whether to enforce pinning after expiration</span>
<a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>        <span class="c1"># Check if app is outdated</span>
<a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a>        <span class="n">app_age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_install_date</span>
<a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a>
<a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>        <span class="k">if</span> <span class="n">app_age</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">180</span><span class="p">):</span>
<a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>            <span class="c1"># Old app - don&#39;t enforce (avoid breaking old clients)</span>
<a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a>            <span class="c1"># Recent app - enforce</span>
<a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a>            <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<h2 id="operational-considerations">Operational Considerations</h2>
<h3 id="generating-pins">Generating Pins</h3>
<p><strong>Extract SPKI hash from certificate file</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="c1"># Extract and hash Subject Public Key Info</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="c1"># For a certificate file</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>cert.pem<span class="w"> </span>-pubkey<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">    </span>openssl<span class="w"> </span>pkey<span class="w"> </span>-pubin<span class="w"> </span>-outform<span class="w"> </span>DER<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span>openssl<span class="w"> </span>dgst<span class="w"> </span>-sha256<span class="w"> </span>-binary<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">    </span>base64
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="c1"># For a website&#39;s certificate</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>api.example.com:443<span class="w"> </span>-servername<span class="w"> </span>api.example.com<span class="w"> </span>&lt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">    </span>openssl<span class="w"> </span>x509<span class="w"> </span>-pubkey<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">    </span>openssl<span class="w"> </span>pkey<span class="w"> </span>-pubin<span class="w"> </span>-outform<span class="w"> </span>DER<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">    </span>openssl<span class="w"> </span>dgst<span class="w"> </span>-sha256<span class="w"> </span>-binary<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">    </span>base64
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="c1"># For entire certificate chain</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="nb">echo</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>api.example.com:443<span class="w"> </span>-showcerts<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">    </span>awk<span class="w"> </span><span class="s1">&#39;/BEGIN CERT/,/END CERT/ {print}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>cert<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$cert</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-pubkey<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">            </span>openssl<span class="w"> </span>pkey<span class="w"> </span>-pubin<span class="w"> </span>-outform<span class="w"> </span>DER<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">            </span>openssl<span class="w"> </span>dgst<span class="w"> </span>-sha256<span class="w"> </span>-binary<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">            </span>base64
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w">    </span><span class="k">done</span>
</code></pre></div></p>
<p><strong>Generate backup pins before deploying</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">rsa</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_backup_key_pin</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="sd">    Generate a backup key pair and return the pin</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="sd">    Returns:</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="sd">        (pin_hash, private_key_pem)</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>    <span class="c1"># Generate key pair</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>    <span class="n">private_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>        <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>        <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>    <span class="p">)</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>    <span class="c1"># Extract public key</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>    <span class="n">public_key</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>    <span class="c1"># Serialize to SPKI format</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>    <span class="n">spki_der</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>        <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">DER</span><span class="p">,</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>        <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PublicFormat</span><span class="o">.</span><span class="n">SubjectPublicKeyInfo</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>    <span class="p">)</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>    <span class="c1"># Hash and encode</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>    <span class="n">spki_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">spki_der</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>    <span class="n">pin</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">spki_hash</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>    <span class="c1"># Export private key for safekeeping</span>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>    <span class="n">private_key_pem</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">private_bytes</span><span class="p">(</span>
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>        <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>        <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PrivateFormat</span><span class="o">.</span><span class="n">PKCS8</span><span class="p">,</span>
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>        <span class="n">encryption_algorithm</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">BestAvailableEncryption</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;strong-password&#39;</span><span class="p">)</span>
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>    <span class="p">)</span>
<a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>
<a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>    <span class="k">return</span> <span class="n">pin</span><span class="p">,</span> <span class="n">private_key_pem</span>
<a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>
<a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a><span class="c1"># Generate backup key BEFORE deploying app</span>
<a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a><span class="n">backup_pin</span><span class="p">,</span> <span class="n">backup_key</span> <span class="o">=</span> <span class="n">generate_backup_key_pin</span><span class="p">()</span>
<a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backup pin: </span><span class="si">{</span><span class="n">backup_pin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Store backup key in HSM or secure key vault&quot;</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="testing-pinning">Testing Pinning</h3>
<p><strong>Test harness for pin validation</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCertificatePinning</span><span class="p">:</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="sd">    Test suite for certificate pinning</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_valid_pin_accepted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Valid pin should be accepted&quot;&quot;&quot;</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>        <span class="n">pinner</span> <span class="o">=</span> <span class="n">PublicKeyPinner</span><span class="p">({</span><span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">})</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>        <span class="c1"># Mock valid certificate with matching pin</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>        <span class="n">valid_cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_test_cert_with_pin</span><span class="p">(</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>            <span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>        <span class="p">)</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>        <span class="k">assert</span> <span class="n">pinner</span><span class="o">.</span><span class="n">verify_certificate</span><span class="p">(</span><span class="n">valid_cert</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_pin_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invalid pin should be rejected&quot;&quot;&quot;</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>        <span class="n">pinner</span> <span class="o">=</span> <span class="n">PublicKeyPinner</span><span class="p">({</span><span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">})</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>        <span class="c1"># Mock certificate with different pin</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>        <span class="n">invalid_cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_test_cert_with_pin</span><span class="p">(</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>            <span class="s2">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>        <span class="p">)</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">SecurityError</span><span class="p">):</span>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>            <span class="n">pinner</span><span class="o">.</span><span class="n">verify_certificate</span><span class="p">(</span><span class="n">invalid_cert</span><span class="p">)</span>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>
<a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_pins_any_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;If multiple pins configured, any valid pin should work&quot;&quot;&quot;</span>
<a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a>        <span class="n">pins</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a>            <span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">,</span>
<a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a>            <span class="s2">&quot;58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=&quot;</span><span class="p">,</span>
<a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a>        <span class="p">}</span>
<a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a>        <span class="n">pinner</span> <span class="o">=</span> <span class="n">PublicKeyPinner</span><span class="p">(</span><span class="n">pins</span><span class="p">)</span>
<a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a>
<a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>        <span class="c1"># Test with second pin</span>
<a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a>        <span class="n">cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_test_cert_with_pin</span><span class="p">(</span>
<a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a>            <span class="s2">&quot;58qRu/uxh4gFezqAcERupSkRYBlBAvfcw7mEjGPLnNU=&quot;</span>
<a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a>        <span class="p">)</span>
<a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a>
<a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a>        <span class="k">assert</span> <span class="n">pinner</span><span class="o">.</span><span class="n">verify_certificate</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a>
<a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_expired_pin_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test behavior when pin has expired&quot;&quot;&quot;</span>
<a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a>        <span class="n">pinner</span> <span class="o">=</span> <span class="n">ExpirationAwarePinner</span><span class="p">()</span>
<a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a>
<a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a>        <span class="c1"># Mock expired pin</span>
<a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a>        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;datetime.datetime&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_datetime</span><span class="p">:</span>
<a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a>            <span class="n">mock_datetime</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2026</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a>
<a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a>            <span class="n">cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_test_cert_with_pin</span><span class="p">(</span>
<a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a>                <span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span>
<a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a>            <span class="p">)</span>
<a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a>
<a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a>            <span class="c1"># Should log warning but accept in grace period</span>
<a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a>            <span class="k">assert</span> <span class="n">pinner</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a>
<a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_mitm_certificate_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Certificate from rogue CA should be rejected despite valid chain&quot;&quot;&quot;</span>
<a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a>        <span class="n">pinner</span> <span class="o">=</span> <span class="n">PublicKeyPinner</span><span class="p">({</span><span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span><span class="p">})</span>
<a id="__codelineno-21-65" name="__codelineno-21-65" href="#__codelineno-21-65"></a>
<a id="__codelineno-21-66" name="__codelineno-21-66" href="#__codelineno-21-66"></a>        <span class="c1"># Mock certificate with valid signature but wrong pin</span>
<a id="__codelineno-21-67" name="__codelineno-21-67" href="#__codelineno-21-67"></a>        <span class="n">mitm_cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_mitm_cert</span><span class="p">()</span>
<a id="__codelineno-21-68" name="__codelineno-21-68" href="#__codelineno-21-68"></a>
<a id="__codelineno-21-69" name="__codelineno-21-69" href="#__codelineno-21-69"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">SecurityError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<a id="__codelineno-21-70" name="__codelineno-21-70" href="#__codelineno-21-70"></a>            <span class="n">pinner</span><span class="o">.</span><span class="n">verify_certificate</span><span class="p">(</span><span class="n">mitm_cert</span><span class="p">)</span>
<a id="__codelineno-21-71" name="__codelineno-21-71" href="#__codelineno-21-71"></a>
<a id="__codelineno-21-72" name="__codelineno-21-72" href="#__codelineno-21-72"></a>        <span class="k">assert</span> <span class="s2">&quot;possible MITM attack&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</code></pre></div></p>
<p><strong>Integration testing with production endpoints</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="c1"># Test pinning against live endpoints</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="nb">set</span><span class="w"> </span>-e
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="nv">API_HOST</span><span class="o">=</span><span class="s2">&quot;api.example.com&quot;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="nv">EXPECTED_PIN</span><span class="o">=</span><span class="s2">&quot;X3pGTSOuJeEVw989IJ/cEtXUEmy52zs1lkJZdZNg5iE=&quot;</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Testing certificate pinning for </span><span class="nv">$API_HOST</span><span class="s2">...&quot;</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="c1"># Get actual pin</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="nv">ACTUAL_PIN</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span><span class="nv">$API_HOST</span>:443<span class="w"> </span>-servername<span class="w"> </span><span class="nv">$API_HOST</span><span class="w"> </span>&lt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">    </span>openssl<span class="w"> </span>x509<span class="w"> </span>-pubkey<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">    </span>openssl<span class="w"> </span>pkey<span class="w"> </span>-pubin<span class="w"> </span>-outform<span class="w"> </span>DER<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">    </span>openssl<span class="w"> </span>dgst<span class="w"> </span>-sha256<span class="w"> </span>-binary<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">    </span>base64<span class="k">)</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Expected pin: </span><span class="nv">$EXPECTED_PIN</span><span class="s2">&quot;</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Actual pin:   </span><span class="nv">$ACTUAL_PIN</span><span class="s2">&quot;</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ACTUAL_PIN</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EXPECTED_PIN</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Pin matches&quot;</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="k">else</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Pin mismatch - pinning will fail in production!&quot;</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="k">fi</span>
</code></pre></div></p>
<h3 id="monitoring-and-alerting">Monitoring and Alerting</h3>
<p><strong>Pin validation metrics</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prometheus_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="c1"># Metrics</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="n">pin_validation_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>    <span class="s1">&#39;cert_pin_validation_total&#39;</span><span class="p">,</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>    <span class="s1">&#39;Total certificate pin validations&#39;</span><span class="p">,</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>    <span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;domain&#39;</span><span class="p">]</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="p">)</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="n">pin_validation_duration</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>    <span class="s1">&#39;cert_pin_validation_duration_seconds&#39;</span><span class="p">,</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>    <span class="s1">&#39;Time spent validating pins&#39;</span><span class="p">,</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>    <span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="p">)</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">MonitoredPinner</span><span class="p">:</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="sd">    Pinner with observability</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pins</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinner</span> <span class="o">=</span> <span class="n">PublicKeyPinner</span><span class="p">(</span><span class="n">pins</span><span class="p">)</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert_der</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="sd">        Verify with metrics</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>        <span class="k">with</span> <span class="n">pin_validation_duration</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinner</span><span class="o">.</span><span class="n">verify_certificate</span><span class="p">(</span><span class="n">cert_der</span><span class="p">)</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>                <span class="n">pin_validation_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>                    <span class="n">result</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>                    <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>                <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>                <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>            <span class="k">except</span> <span class="n">SecurityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>                <span class="n">pin_validation_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>                    <span class="n">result</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>                    <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>                <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>                <span class="c1"># Log detailed error</span>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>                    <span class="s2">&quot;Certificate pin validation failed&quot;</span><span class="p">,</span>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a>                        <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a>                        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>                        <span class="s1">&#39;cert_hash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinner</span><span class="o">.</span><span class="n">extract_spki_hash</span><span class="p">(</span><span class="n">cert_der</span><span class="p">),</span>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a>                        <span class="s1">&#39;expected_pins&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinner</span><span class="o">.</span><span class="n">pinned_spki_hashes</span><span class="p">),</span>
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a>                    <span class="p">}</span>
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>                <span class="p">)</span>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a>                <span class="k">raise</span>
</code></pre></div></p>
<p><strong>Alert on pin mismatches</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># Prometheus alerting rule</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nt">groups</span><span class="p">:</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certificate_pinning</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CertificatePinFailure</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">          </span><span class="no">rate(cert_pin_validation_total{result=&quot;failure&quot;}[5m]) &gt; 0.01</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Certificate</span><span class="nv"> </span><span class="s">pin</span><span class="nv"> </span><span class="s">validation</span><span class="nv"> </span><span class="s">failures</span><span class="nv"> </span><span class="s">detected&quot;</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">            </span><span class="no">Pin validation failing for {{ $labels.domain }}.</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">            </span><span class="no">Rate: {{ $value | humanize }}</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">            </span><span class="no">This could indicate:</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">            </span><span class="no">- Certificate rotation without pin update</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="w">            </span><span class="no">- MITM attack in progress</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="w">            </span><span class="no">- Misconfigured pinning</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CertificatePinNearExpiry</span>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="w">          </span><span class="no">cert_pin_expiry_days &lt; 30</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Pinned</span><span class="nv"> </span><span class="s">certificate</span><span class="nv"> </span><span class="s">expiring</span><span class="nv"> </span><span class="s">soon&quot;</span>
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="w">            </span><span class="no">Pinned certificate for {{ $labels.domain }} expires in {{ $value }} days.</span>
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="w">            </span><span class="no">Action required:</span>
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a><span class="w">            </span><span class="no">1. Generate new key pair</span>
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a><span class="w">            </span><span class="no">2. Update app with new pin</span>
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a><span class="w">            </span><span class="no">3. Deploy updated app</span>
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="w">            </span><span class="no">4. Rotate certificate after sufficient adoption</span>
</code></pre></div></p>
<h3 id="incident-response">Incident Response</h3>
<p><strong>Pin validation failure runbook</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="gh"># Incident: Certificate Pin Validation Failures</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="gu">## Symptoms</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="k">-</span><span class="w"> </span>Apps unable to connect to API
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="k">-</span><span class="w"> </span>&quot;Certificate validation failed&quot; errors
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="k">-</span><span class="w"> </span>Spike in pin validation failures
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="gu">## Triage Steps</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="gu">### 1. Verify Scope</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>```bash
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="gh"># Check error rate by domain</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>curl &#39;[Prometheus:9090 - Query](http://prometheus:9090/api/v1/query?query=rate(cert_pin_validation_total{result=&quot;failure&quot;}[5m]))&#39;
</code></pre></div>
<h3 id="2-check-certificate-status">2. Check Certificate Status</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Verify current certificate matches expected pin</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>./scripts/check-pins.sh<span class="w"> </span>api.example.com
</code></pre></div>
<h3 id="3-determine-root-cause">3. Determine Root Cause</h3>
<p><strong>Scenario A: Legitimate Certificate Rotation</strong>
- Certificate was rotated but app pins not updated
- <strong>Impact</strong>: All app versions with old pins broken
- <strong>Resolution</strong>: Rollback certificate OR emergency app update</p>
<p><strong>Scenario B: MITM Attack</strong>
- Unexpected certificate with different pin
- <strong>Impact</strong>: Varies by attack scope
- <strong>Resolution</strong>: Investigate, do not weaken pinning</p>
<p><strong>Scenario C: Pin Misconfiguration</strong>
- Wrong pins deployed in app update
- <strong>Impact</strong>: New app version broken
- <strong>Resolution</strong>: Emergency app update with correct pins</p>
<h3 id="4-remediation-actions">4. Remediation Actions</h3>
<p><strong>If legitimate rotation (Scenario A)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># Option 1: Rollback certificate (fastest)</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>undo<span class="w"> </span>deployment/api-server
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="c1"># Option 2: Emergency app update (if rollback not possible)</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="c1"># 1. Build app with updated pins</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="c1"># 2. Fast-track through app stores</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="c1"># 3. Force update if critical</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="c1"># Option 3: Temporarily disable pinning (LAST RESORT)</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="c1"># Only if user impact severe and no other option</span>
</code></pre></div></p>
<p><strong>If MITM attack suspected (Scenario B)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1"># DO NOT disable pinning</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="c1"># Investigate:</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="c1"># - Check certificate chain</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="c1"># - Verify DNS not hijacked</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="c1"># - Check for rogue CA certificates on devices</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="c1"># - Review network logs</span>
</code></pre></div></p>
<h2 id="prevention">Prevention</h2>
<ol>
<li><strong>Always maintain backup pins</strong> in deployed apps</li>
<li><strong>Test pins before certificate rotation</strong></li>
<li><strong>Gradual rollout</strong> of certificate changes</li>
<li><strong>Monitor pin validation metrics</strong> continuously</li>
<li><strong>Document rotation procedures</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>## Security Considerations
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>### Threats Mitigated by Pinning
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>**Compromised Certificate Authority**:
</code></pre></div>
Without pinning:
  Attacker compromises CA  Issues rogue cert  MITM attack succeeds</li>
</ol>
<p>With pinning:
  Attacker compromises CA  Issues rogue cert  App rejects cert (wrong pin)
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>**Rogue Root Certificate Installation**:
</code></pre></div>
Without pinning:
  Malware installs root CA  Issues cert for your domain  Intercepts traffic</p>
<p>With pinning:
  Malware installs root CA  Issues cert  App rejects (not pinned)
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>**Government/Corporate Network Interception**:
</code></pre></div>
Without pinning:
  Corporate proxy uses trusted CA  Intercepts HTTPS  User unaware</p>
<p>With pinning:
  Corporate proxy certificate rejected  Connection fails  User alerted
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>### Threats NOT Mitigated
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>**Pinning does NOT protect against**:
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>- Application-level attacks (SQL injection, XSS, etc.)
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>- Compromised application code
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>- Stolen API keys or credentials
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>- Attacks before SSL/TLS handshake
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>- Physical device compromise (attacker can modify app)
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>### Operational Risks
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a>**Risk 1: Pin Lockout**
</code></pre></div>
Scenario: All pinned keys lost/compromised, no backup
Impact: Application permanently broken until update deployed
Mitigation: Always maintain backup pins, test rotation procedures
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>**Risk 2: Delayed Updates**
</code></pre></div>
Scenario: Users don't update apps, pins expire
Impact: Old app versions stop working
Mitigation: Server-side grace period, push notifications, forced updates
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>**Risk 3: Development Complications**
</code></pre></div>
Scenario: Developers use different certificates (dev, staging, prod)
Impact: Pinning breaks in non-production environments
Mitigation: Environment-specific pins, build-time configuration
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>### Best Practices Summary
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>**DO**:
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>-  Pin public keys (SPKI), not full certificates
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>-  Maintain multiple pins (current + backup)
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>-  Pin both leaf and intermediate/root certificates
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>-  Test pinning thoroughly before production
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>-  Monitor pin validation metrics
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>-  Document rotation procedures
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>-  Use expiration awareness in apps
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>-  Generate backup keys before deployment
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a>**DON&#39;T**:
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a>-  Pin only one certificate
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a>-  Use HPKP (deprecated)
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a>-  Deploy without backup pins
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a>-  Rotate certificates without updating pins
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a>-  Use dynamic pin updates without signatures
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a>-  Ignore pin validation failures
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a>-  Disable pinning in production (except absolute emergency)
<a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a>
<a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a>## Real-World Examples
<a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a>
<a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a>### Case Study 1: Twitter (2012)
<a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a>
<a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a>**Challenge**: Protect against compromised CAs after DigiNotar incident
<a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a>
<a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a>**Solution**:
<a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a>
<a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a>- Implemented certificate pinning in Twitter iOS app
<a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a>- Pinned both leaf certificates and CA keys
<a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a>- Maintained multiple pins for rotation flexibility
<a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a>
<a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a>**Outcome**:
<a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a>
<a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a>- Successfully detected and blocked MITM attempts
<a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a>- Set industry example for mobile app security
<a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a>
<a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a>### Case Study 2: Google Chrome
<a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a>
<a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a>**Implementation**: Chrome pins Google domains
<a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a>```cpp
<a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a>// Chromium source code (simplified)
<a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a>static const char* kGooglePins[] = {
<a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a>  &quot;sha256/4BjDjn8v2lWeUFQnqSs0BgbIcrU9LosQWGDWzQ=&quot;,
<a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a>  &quot;sha256/GUAL5bejH7czkXcAeJ0vCiRxwMnVBsDlBMBsFtfLF8A=&quot;,
<a id="__codelineno-35-49" name="__codelineno-35-49" href="#__codelineno-35-49"></a>  // ... multiple backup pins
<a id="__codelineno-35-50" name="__codelineno-35-50" href="#__codelineno-35-50"></a>};
</code></pre></div></p>
<p><strong>Results</strong>:</p>
<ul>
<li>Protected hundreds of millions of users</li>
<li>Detected multiple MITM attempts</li>
<li>Influenced industry to adopt pinning</li>
</ul>
<h3 id="case-study-3-banking-app-implementation">Case Study 3: Banking App Implementation</h3>
<p><strong>Requirements</strong>:</p>
<ul>
<li>Protect customer financial data</li>
<li>Meet PCI-DSS requirements</li>
<li>Support certificate rotation</li>
</ul>
<p><strong>Architecture</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>Mobile App Pinning Strategy:
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a> Primary API pin (current certificate)
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a> Backup API pin (prepared for rotation)
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a> CA pin (intermediate CA)
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a> Root CA pin (ultimate fallback)
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>Rotation Process:
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a> 90 days before expiry: Generate new key pair
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a> 60 days before: Deploy app update with new backup pin
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a> 30 days before: Monitor app adoption
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a> Rotation day: Switch to new certificate
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a> 90 days after: Remove old pin from next app version
</code></pre></div></p>
<p><strong>Results</strong>:</p>
<ul>
<li>Zero outages during multiple rotations</li>
<li>Detected 3 MITM attempts in corporate environments</li>
<li>Achieved PCI-DSS compliance</li>
</ul>
<h2 id="tools-and-libraries">Tools and Libraries</h2>
<h3 id="ios">iOS</h3>
<ul>
<li><strong>Built-in</strong>: <code>NSPinnedDomains</code> (iOS 14+)</li>
<li><strong>TrustKit</strong>: Full-featured pinning framework</li>
<li><strong>Alamofire</strong>: Network library with pinning support</li>
</ul>
<h3 id="android">Android</h3>
<ul>
<li><strong>Built-in</strong>: Network Security Configuration (API 24+)</li>
<li><strong>OkHttp</strong>: <code>CertificatePinner</code> class</li>
<li><strong>Conscrypt</strong>: Advanced SSL provider</li>
</ul>
<h3 id="web">Web</h3>
<ul>
<li><strong>Certificate Transparency</strong>: Modern alternative to HPKP</li>
<li><strong>Expect-CT</strong>: Enforce CT logging</li>
<li><strong>React Native</strong>: <code>react-native-ssl-pinning</code></li>
</ul>
<h3 id="backend">Backend</h3>
<ul>
<li><strong>Python</strong>: <code>requests</code> with custom adapter</li>
<li><strong>Node.js</strong>: <code>tls.connect()</code> with checkServerIdentity</li>
<li><strong>Go</strong>: <code>tls.Config</code> with <code>VerifyPeerCertificate</code></li>
</ul>
<h2 id="further-reading">Further Reading</h2>
<h3 id="standards">Standards</h3>
<ul>
<li>RFC 7469: Public Key Pinning Extension for HTTP (HPKP - deprecated)</li>
<li>RFC 6797: HTTP Strict Transport Security (HSTS)</li>
<li>RFC 6962: Certificate Transparency</li>
</ul>
<h3 id="documentation">Documentation</h3>
<ul>
<li>OWASP Certificate Pinning Cheat Sheet</li>
<li>Apple App Transport Security documentation</li>
<li>Android Network Security Configuration guide</li>
</ul>
<h3 id="research-papers">Research Papers</h3>
<ul>
<li>"The Risks of SSL Inspection" (2016)</li>
<li>"Certificate Pinning in Practice" (2014)</li>
<li>"Analysis of the HTTPS Certificate Ecosystem" (2013)</li>
</ul>
<hr />
<p><strong>See Also</strong>: <a href="../common-vulnerabilities/">Common Vulnerabilities</a>, <a href="../../foundations/trust-models/">Trust Models</a>, <a href="../../standards/tls-protocol/">Tls Protocol</a>, <a href="../private-key-protection/">Private Key Protection</a></p>









  




                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/company/axonsecurity/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
  
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../javascripts/parent-sync.js"></script>
      
    
  
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var sidebar = document.querySelector('.md-sidebar--secondary .md-sidebar__scrollwrap');
      if (sidebar) {
        var disclaimer = document.createElement('div');
        disclaimer.className = 'md-sidebar-disclaimer';
        disclaimer.innerHTML = `
          <div class="md-typeset">
            <div class="admonition tip">
              <p class="admonition-title">Our Books</p>
              <p><a href="https://axonshield.com/book"><strong>The Invisible Certificate Management Tax and How Automation Eliminates 94% of It</strong></a></p>
              <p><a href="https://axonshield.com/book"><strong>A CTO Playbook for Turning Automation into Infrastructure Intelligence</strong></a></p>
            </div>
            <div class="admonition warning">
              <p class="admonition-title">Disclaimer</p>
              <p><small>This documentation is based on "best practices". We've observed these ignore 
                unique organizational needs and often prove ineffective for long-term, sustainable 
                operations and ignore strategic advanteges of building infrastructure intelligence.</small></p>
            </div>
          </div>
        `;
        sidebar.insertBefore(disclaimer, sidebar.firstChild);
      }
    });
  </script>
  

  </body>
</html>